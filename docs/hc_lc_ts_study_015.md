# ç¬¬15ç« ï¼šçµåˆã®ç½ â‘  ãƒ•ãƒ©ã‚°å¼•æ•°ï¼†â€œæ–‡å­—åˆ—ã§æŒ‡ç¤ºâ€å•é¡ŒğŸš©ğŸ”¤ğŸ’¦

### ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯

* ã€Œ`true/false` ã§æŒ™å‹•ãŒå¤‰ã‚ã‚‹é–¢æ•°ã€ã‚„ã€Œ`"admin"` ã¿ãŸã„ãªæ–‡å­—åˆ—ã®ç›´æ›¸ãã€ãŒã€ãªãœè¨­è¨ˆã‚’å£Šã—ã‚„ã™ã„ã‹èª¬æ˜ã§ãã‚‹ğŸ˜¤âœ¨
* TypeScriptã‚‰ã—ã **åˆ¤åˆ¥å¯èƒ½Unionï¼ˆdiscriminated unionï¼‰** ã§ã€å®‰å…¨ï¼†å¤‰æ›´ã«å¼·ã„åˆ†å²ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã§ãã‚‹ğŸ§©âœ…
* ã€Œè¿½åŠ ä»•æ§˜ãŒæ¥ã¦ã‚‚ã€å£Šã‚Œã«ãã„ã€åˆ†å²ã®ä½œã‚Šæ–¹ï¼ˆç¶²ç¾…ãƒã‚§ãƒƒã‚¯ğŸ”¥ï¼‰ã‚’èº«ã«ã¤ã‘ã‚‹ğŸ’ª

â€»ã¡ãªã¿ã«ã€TypeScriptã¯ **5.9.3 ãŒ Latest** ã«ãªã£ã¦ã¾ã™ï¼ˆGitHub Releasesä¸Šï¼‰ğŸ†•âœ¨ ([GitHub][1])

---

## 15.1 ã¾ãšã¯â€œäº‹æ•…ã‚Šã‚„ã™ã„ã‚³ãƒ¼ãƒ‰â€ã‚’è¦‹ã¦ã¿ã‚ˆğŸ˜±

ã“ã‚“ãªã‚³ãƒ¼ãƒ‰ã€è¦‹è¦šãˆã‚ã‚‹ã‹ã‚‚â€¦ï¼ğŸ‘€ğŸ’¦

```ts
// ğŸ˜± æ‚ªã„ä¾‹ï¼šãƒ•ãƒ©ã‚°å¼•æ•° + æ–‡å­—åˆ—ã§æŒ‡ç¤ºï¼ˆstringly-typedï¼‰
export function renderPrice(
  yen: number,
  isAdmin: boolean,
  mode: string // "simple" / "detail" / "debug" ...ã®ã¤ã‚‚ã‚Š
): string {
  let base = yen;

  // ğŸš© ãƒ•ãƒ©ã‚°ã§æŒ™å‹•ãŒã‚¬ãƒ©ãƒƒã¨å¤‰ã‚ã‚‹
  if (isAdmin) {
    base = Math.floor(yen * 0.9); // ç®¡ç†è€…ã¯å‰²å¼•â€¦ã®ã¤ã‚‚ã‚Š
  }

  // ğŸ”¤ æ–‡å­—åˆ—ã§æŒ‡ç¤ºï¼ˆtypoã§æ­»ã¬ï¼‰
  if (mode === "simple") return `${base}å††`;
  if (mode === "detail") return `åˆè¨ˆ: ${base}å††ï¼ˆç¨è¾¼ï¼‰`;
  if (mode === "debug") return `[DEBUG] price=${base}`;

  // ã“ã“ãŒåœ°ç„ï¼šä½•ãŒæ­£ã—ã„ mode ãªã®ã‹åˆ†ã‹ã‚‰ãªã„ğŸ˜‡
  return `${base}å††`;
}
```

å‘¼ã³å‡ºã—å´ã‚‚ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚ŠãŒã¡ğŸ‘‡

```ts
renderPrice(1200, true, "detial"); // ğŸ˜± typoï¼ˆdetailã®ã¤ã‚‚ã‚Šï¼‰
renderPrice(1200, false, "simple");
```

---

## 15.2 ä½•ãŒã¾ãšã„ã®ï¼Ÿï¼ˆçµåˆãŒå¼·ããªã‚‹ç†ç”±ï¼‰ğŸ”—ğŸ’¥

![Confusing Signpost](./picture/hc_lc_ts_study_015_confusing_signpost.png)

### ğŸš© ãƒ•ãƒ©ã‚°å¼•æ•°ãŒã¾ãšã„ç†ç”±

Martin FowlerãŒã€Œ**Flag Argument**ï¼ˆãƒ•ãƒ©ã‚°å¼•æ•°ï¼‰ã€ã‚’ **â€œå¼•æ•°ã§åˆ¥ã®å‡¦ç†ã‚’ã•ã›ã‚‹åŒ‚ã„â€** ã¨ã—ã¦èª¬æ˜ã—ã¦ã¾ã™ã€‚ã¤ã¾ã‚Šã€Œ1ã¤ã®é–¢æ•°ãŒã€å®Ÿè³ª2ã¤ä»¥ä¸Šã®ä»•äº‹ã‚’ã—ã¦ã‚‹ã€çŠ¶æ…‹ã«ãªã‚Šã‚„ã™ã„ã‚“ã ã‚ˆã­ğŸ²ğŸ’¦ ([martinfowler.com][2])

* å‘¼ã³å‡ºã—å´ãŒã€Œä¸­ã®åˆ†å²ã€ã‚’çŸ¥ã£ã¦ãªã„ã¨ä½¿ãˆãªã„ï¼ˆ= çµåˆUPï¼‰ğŸ”—
* `true` ã®æ„å‘³ãŒèª­ã¿å–ã‚Œãªã„ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã§äº‹æ•…ã‚‹ï¼‰ğŸ˜µâ€ğŸ’«
* åˆ†å²ãŒå¢—ãˆã‚‹ãŸã³ã«ã€é–¢æ•°ã‚‚å‘¼ã³å‡ºã—ã‚‚è¤‡é›‘åŒ–ã™ã‚‹ğŸ•¸ï¸

ã•ã‚‰ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å®šç•ªã¨ã—ã¦ **â€œRemove Flag Argumentâ€**ï¼ˆãƒ•ãƒ©ã‚°å¼•æ•°ã‚’ã‚„ã‚ã‚ˆã†ï¼‰ã¨ã„ã†ã‚«ã‚¿ãƒ­ã‚°ã‚‚ã‚ã‚‹ã‚ˆğŸ“šâœ¨ ([refactoring.com][3])

```mermaid
graph TD
  Caller[å‘¼ã³å‡ºã—å´] -->|true/false| Fn{é–¢æ•°å†…éƒ¨ã®<br>åˆ†å²}
  Fn -->|true| LogicA
  Fn -->|false| LogicB
  
  style Caller fill:#ffcccc
  style Fn fill:#ffcccc
```

### ğŸ”¤ â€œæ–‡å­—åˆ—ã§æŒ‡ç¤ºâ€ãŒã¾ãšã„ç†ç”±ï¼ˆstringly-typedï¼‰

â€œstringly typedâ€ ã¯ã€Œæœ¬å½“ã¯å‹ã§è¡¨ã›ã‚‹ã®ã«ã€æ–‡å­—åˆ—ã«å¯„ã›ã™ãã¦ãƒ„ãƒ©ã„ã€ã£ã¦ã„ã†çš®è‚‰ãªç”¨èªã ã‚ˆğŸ˜‡
Jeff Atwoodï¼ˆCoding Horrorï¼‰ã‚‚ã€Œæ–‡å­—åˆ—ã«é ¼ã‚Šã™ãã‚‹å®Ÿè£…ã€ã‚’ä¾‹ã¤ãã§èª¬æ˜ã—ã¦ã‚‹ã‚ˆğŸ§¯ ([Coding Horror][4])

* typoãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§é˜²ã’ãªã„ï¼ˆå®Ÿè¡Œã—ã¦ã‹ã‚‰æ°—ã¥ãï¼‰ğŸ˜±
* ã©ã“ã§ä½¿ã‚ã‚Œã¦ã‚‹ã‹è¿½ã„ã¥ã‚‰ã„ï¼ˆæ¤œç´¢ç¥­ã‚Šï¼‰ğŸ”ğŸ’¦
* â€œè¿½åŠ â€ã®ãŸã³ã«æ–‡å­—åˆ—ãŒæ•£ã‚‰ã°ã£ã¦ã€ä»•æ§˜ãŒåˆ†è£‚ã™ã‚‹ğŸ’¥

---

## 15.3 ã¾ãšã¯â€œè»½ã„æ”¹å–„â€3æŠğŸ§¸âœ¨ï¼ˆã§ã‚‚æœ€çµ‚çš„ã«ã¯UnionãŒå¼·ã„ï¼‰

### æ”¹å–„â‘ ï¼šé–¢æ•°ã‚’åˆ†ã‘ã‚‹âœ‚ï¸

ã€Œãã‚‚ãã‚‚åˆ¥ã®ä»•äº‹ãªã‚‰ã€é–¢æ•°ã‚’åˆ†ã‘ã‚‹ã€âœ¨

```ts
export const renderPriceForAdmin = (yen: number) => `${Math.floor(yen * 0.9)}å††`;
export const renderPriceForUser  = (yen: number) => `${yen}å††`;
```

âœ… ã‚·ãƒ³ãƒ—ãƒ«ï¼
âš ï¸ ãŸã ã— â€œmodeâ€ ãŒå¢—ãˆã‚‹ã¨é–¢æ•°çˆ†ç™ºã—ãŒã¡ğŸ’£

---

### æ”¹å–„â‘¡ï¼šbooleanã‚’â€œåå‰ä»˜ãâ€ã«ã™ã‚‹ï¼ˆæœ€å°ã®èª­ã¿ã‚„ã™ã•UPï¼‰ğŸ·ï¸

```ts
renderPrice(1200, /* isAdmin */ true, "detail");
```

âœ… äº‹æ•…ãŒæ¸›ã‚‹
âš ï¸ ã§ã‚‚æœ¬è³ªã¯å¤‰ã‚ã£ã¦ãªã„ï¼ˆåˆ†å²ã®è²¬å‹™æ··åœ¨ğŸ²ï¼‰

---

### æ”¹å–„â‘¢ï¼šã“ã“ã‹ã‚‰ãŒæœ¬å‘½ï¼åˆ¤åˆ¥å¯èƒ½Unionã«ã™ã‚‹ğŸ§©ğŸ”¥

TypeScriptã¯ **Unionå‹** ã¨ **çµã‚Šè¾¼ã¿ï¼ˆnarrowingï¼‰** ãŒå¾—æ„ï¼ ([TypeScript][5])
ã•ã‚‰ã« **åˆ¤åˆ¥å¯èƒ½Union** ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚‚å®šç•ªã®ã‚„ã‚Šæ–¹ã¨ã—ã¦ç´¹ä»‹ã•ã‚Œã¦ã‚‹ã‚ˆâœ¨ ([TypeScript][6])

---

## 15.4 åˆ¤åˆ¥å¯èƒ½Unionã§â€œå®‰å…¨ãªåˆ†å²â€ã«ä½œã‚Šæ›¿ãˆã‚ˆã†ğŸ› ï¸âœ¨

![Safe Switch](./picture/hc_lc_ts_study_015_safe_switch.png)

### âœ… Step1ï¼šmode ã‚’ã€Œè¨±å¯ãƒªã‚¹ãƒˆã®å‹ã€ã«ã™ã‚‹

```ts
type Mode =
  | { kind: "simple" }
  | { kind: "detail" }
  | { kind: "debug" };
```

### âœ… Step2ï¼šadmin/user ã‚’ boolean ã˜ã‚ƒãªã â€œæ„å›³ãŒè¦‹ãˆã‚‹å½¢â€ ã«ã™ã‚‹

```ts
type Viewer =
  | { role: "admin" }
  | { role: "user" };
```

### âœ… Step3ï¼šå¼•æ•°ã‚’ â€œ1ã¤ã®å‘½ä»¤â€ ã¨ã—ã¦ã¾ã¨ã‚ã‚‹ğŸ

```ts
type RenderPriceCommand = {
  yen: number;
  viewer: Viewer;
  mode: Mode;
};
```

### âœ… Step4ï¼šswitchã§åˆ†å²ï¼ˆTSãŒå‹æ‰‹ã«çµã‚Šè¾¼ã‚“ã§ãã‚Œã‚‹ï¼‰ğŸ§ âœ¨

```ts
export function renderPrice(cmd: RenderPriceCommand): string {
  const base =
    cmd.viewer.role === "admin" ? Math.floor(cmd.yen * 0.9) : cmd.yen;

  switch (cmd.mode.kind) {
    case "simple":
      return `${base}å††`;

    case "detail":
      return `åˆè¨ˆ: ${base}å††ï¼ˆç¨è¾¼ï¼‰`;

    case "debug":
      return `[DEBUG] price=${base}`;

    default:
      return assertNever(cmd.mode); // ğŸ”¥ ç¶²ç¾…ãƒã‚§ãƒƒã‚¯
  }
}

function assertNever(x: never): never {
  throw new Error(`Unexpected: ${JSON.stringify(x)}`);
}
```

ã“ã‚Œã®ä½•ãŒå¬‰ã—ã„ã‹ã¨ã„ã†ã¨â€¦ğŸ‘‡ğŸ˜

* `"detial"` ã¿ãŸã„ãªtypoãŒ **ãã‚‚ãã‚‚æ›¸ã‘ãªã„** âœ…
* modeã‚’è¿½åŠ ã—ãŸã‚‰ `switch` ã® `default: assertNever` ã§ **æœªå¯¾å¿œãŒå³ãƒãƒ¬** ğŸ”¥
* å‘¼ã³å‡ºã—å´ãŒ â€œæ„å‘³ä¸æ˜ãªtrueâ€ ã‚’æ¸¡ã•ãªãã¦ã‚ˆããªã‚‹ğŸ‰

å‘¼ã³å‡ºã—ã‚‚ã“ã†ãªã‚‹ğŸ‘‡ï¼ˆèª­ã¿ã‚„ã™ã„ã€œï¼ğŸ’ï¼‰

```ts
renderPrice({
  yen: 1200,
  viewer: { role: "admin" },
  mode: { kind: "detail" },
});
```

---

## 15.5 æ–‡å­—åˆ—ç›´æ›¸ãå•é¡Œã®â€œç¾å®Ÿçš„ãªå…¥å£â€ğŸšªğŸ”¤

ã€Œã§ã‚‚ã•â€¦å¤–éƒ¨å…¥åŠ›ï¼ˆURLã‚¯ã‚¨ãƒªã¨ã‹ï¼‰ã£ã¦æ–‡å­—åˆ—ã§æ¥ã‚‹ã‚ˆã­ï¼Ÿã€â†ã“ã‚Œè¶…ã‚ã‚‹ã‚ã‚‹ğŸ˜¤

å¤§äº‹ãªã®ã¯ã“ã‚ŒğŸ‘‡
**å¤–ã‹ã‚‰æ¥ãŸæ–‡å­—åˆ—ã¯ã€å¢ƒç•Œã§â€œå®‰å…¨ãªå‹â€ã«å¤‰æ›ã—ã¦ã‹ã‚‰ä¸­ã¸å…¥ã‚Œã‚‹**ğŸ›¡ï¸âœ¨

```ts
type ModeKind = Mode["kind"];

export function parseMode(input: string): Mode {
  switch (input) {
    case "simple":
      return { kind: "simple" };
    case "detail":
      return { kind: "detail" };
    case "debug":
      return { kind: "debug" };
    default:
      return { kind: "simple" }; // è¿·ã£ãŸã‚‰å®‰å…¨å´ã¸ğŸ€ï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰
  }
}
```

---

## 15.6 ã‚ã‚ŠãŒã¡ãªè½ã¨ã—ç©´ã¨ã€åˆ¤æ–­ãƒ«ãƒ¼ãƒ«ğŸ§ ğŸ’¡

### ğŸš© ãƒ•ãƒ©ã‚°å¼•æ•°ã‚’â€œã»ã¼ç¢ºå®Ÿã«ã‚„ã‚ãŸã„â€ã‚µã‚¤ãƒ³

* `true` ã®æ„å‘³ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ãªã„ã¨åˆ†ã‹ã‚‰ãªã„ğŸ˜µâ€ğŸ’«
* `if (flag)` ã®ä¸­ã§ **å‡¦ç†å†…å®¹ãŒåˆ¥ç‰©**ï¼ˆåˆ¥æ©Ÿèƒ½ã£ã½ã„ï¼‰ğŸ²
* ãƒ•ãƒ©ã‚°ãŒå¢—ãˆãŸï¼ˆ`isAdmin, isDebug, isShort, ...`ï¼‰ğŸ˜‡

### ğŸ”¤ æ–‡å­—åˆ—ã§æŒ‡ç¤ºã‚’â€œã‚„ã‚ãŸã„â€ã‚µã‚¤ãƒ³

* `"admin"` ãŒè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«æ•£ã£ã¦ã‚‹ğŸ•¸ï¸
* ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ãŒæ€–ãã¦ãƒ†ã‚¹ãƒˆã«é ¼ã£ã¦ã‚‹ğŸ˜±
* ä»•æ§˜è¿½åŠ ã®ãŸã³ã« `if (mode === "...")` ãŒå¢—æ®–ã™ã‚‹ğŸ‘¾

---

## 15.7 ãƒãƒ³ã‚ºã‚ªãƒ³ğŸ› ï¸ï¼šãƒ•ãƒ©ã‚°ï¼†æ–‡å­—åˆ—ã‚’å’æ¥­ã—ã‚ˆğŸ“âœ¨

### ãŠé¡ŒğŸ“Œ

ã•ã£ãã® `renderPrice(yen, isAdmin, mode)` ã‚’ã€æ¬¡ã®æ¡ä»¶ã§ç›´ã—ã¦ã­ğŸ‘‡

1. å¼•æ•°ã¯ **1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã«ã™ã‚‹ğŸ
2. `isAdmin: boolean` ã‚’ã‚„ã‚ã¦ã€`viewer.role` ã«ã™ã‚‹ğŸ‘€
3. `mode: string` ã‚’ã‚„ã‚ã¦ã€`mode.kind` ã® Union ã«ã™ã‚‹ğŸ§©
4. modeã‚’1å€‹è¿½åŠ ï¼ˆä¾‹ï¼š`"compact"`ï¼‰ã—ã¦ã€**ç¶²ç¾…ãƒã‚§ãƒƒã‚¯ãŒåŠ¹ã**ã®ã‚’ç¢ºèªã™ã‚‹ğŸ”¥

### ä»•ä¸Šã’ã®ç¢ºèªâœ…

* `"detial"` ã‚’æ›¸ã“ã†ã¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§æ­¢ã¾ã‚‹ï¼ŸğŸ§¯
* `"compact"` ã‚’è¿½åŠ ã—ãŸã®ã« `switch` ãŒæœªå¯¾å¿œã ã¨æ€’ã‚‰ã‚Œã‚‹ï¼ŸğŸ˜†

---

## 15.8 ã¾ã¨ã‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆğŸ§¾âœ¨ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ä½¿ãˆã‚‹ï¼ï¼‰

* [ ] å¼•æ•°ã® `boolean` ãŒã€Œå‡¦ç†ã®ç¨®é¡ã€ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãªã„ï¼ŸğŸš©
* [ ] `"string"` ã§å‘½ä»¤ã—ã¦ãªã„ï¼Ÿï¼ˆtypoã§æ­»ã¬ã‚„ã¤ï¼‰ğŸ”¤ğŸ’¦
* [ ] Union + `switch` ã§åˆ†å²ã—ã¦ã€`never` ç¶²ç¾…ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹ï¼ŸğŸ”¥
* [ ] å¤–éƒ¨å…¥åŠ›ã®æ–‡å­—åˆ—ã¯ã€å¢ƒç•Œã§å‹ã«å¤‰æ›ã—ã¦ã‚‹ï¼ŸğŸ›¡ï¸

---

## 15.9 AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã“ã®ç« ã®1ã€œ2æœ¬ï¼‰ğŸ¤–ğŸ’

1. ğŸš©â†’ğŸ§© å¤‰æ›ç”¨
   ã€Œã“ã®é–¢æ•°ã® boolean ãƒ•ãƒ©ã‚°å¼•æ•°ã¨ string æŒ‡ç¤ºã‚’ã‚„ã‚ã¦ã€åˆ¤åˆ¥å¯èƒ½Unionï¼ˆdiscriminated unionï¼‰ã«ç½®ãæ›ãˆã‚‹è¨­è¨ˆæ¡ˆã‚’å‡ºã—ã¦ã€‚å‹å®šç¾©ãƒ»é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ãƒ»å‘¼ã³å‡ºã—ä¾‹ã¾ã§ã‚»ãƒƒãƒˆã§ã€

2. ğŸ”¥ ç¶²ç¾…ãƒã‚§ãƒƒã‚¯å¼·åŒ–ç”¨
   ã€ŒUnionã§åˆ†å²ã—ã¦ã„ã‚‹ switch ãŒâ€œè¿½åŠ ã«å¼±ã„â€çŠ¶æ…‹ã«ãªã£ã¦ãªã„ï¼Ÿneverç¶²ç¾…ãƒã‚§ãƒƒã‚¯ã‚„ã€æ¼ã‚ŒãŒèµ·ãã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŒ‡æ‘˜ã—ã¦æ”¹å–„æ¡ˆã‚’å‡ºã—ã¦ã€

---

æ¬¡ã®ç¬¬16ç« ã¯ã€ã“ã“ã§ä½œã£ãŸã€Œå®‰å…¨ãªå‹ã€ã‚’ **â€œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¢ƒç•Œâ€** ã¨ã—ã¦ã©ã†å®ˆã‚‹ã‹ï¼ˆå…¬é–‹é¢ã‚’çµã‚‹ï¼importãƒ«ãƒ¼ãƒ«ï¼‰ã«ç¹‹ãŒã‚‹ã‚ˆğŸ“ğŸ”’âœ¨

[1]: https://github.com/microsoft/typescript/releases "Releases Â· microsoft/TypeScript Â· GitHub"
[2]: https://martinfowler.com/bliki/FlagArgument.html?utm_source=chatgpt.com "Flag Argument"
[3]: https://refactoring.com/catalog/removeFlagArgument.html?utm_source=chatgpt.com "Remove Flag Argument - Refactoring"
[4]: https://blog.codinghorror.com/new-programming-jargon/?utm_source=chatgpt.com "New Programming Jargon"
[5]: https://www.typescriptlang.org/docs/handbook/unions-and-intersections.html?utm_source=chatgpt.com "Handbook - Unions and Intersection Types"
[6]: https://www.typescriptlang.org/docs/handbook/typescript-in-5-minutes-func.html?utm_source=chatgpt.com "Documentation - TypeScript for Functional Programmers"
