# ç¬¬30ç« ï¼šä¾å­˜ã®å·®ã—æ›¿ãˆâ‘ ï¼šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æœ€å°å°Žå…¥ðŸ”

ã“ã®ç« ã¯ã€Œ**æ™‚é–“ï¼ˆDateTime.Nowï¼‰ã¿ãŸã„ãªå¤–éƒ¨è¦å› ã‚’ã€ãƒ†ã‚¹ãƒˆã‹ã‚‰è‡ªç”±ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹**ã€ã®ãŒã‚´ãƒ¼ãƒ«ã ã‚ˆã€œï¼â°ðŸª„
ãƒã‚¤ãƒ³ãƒˆã¯ãŸã£ãŸ1ã¤ï¼š**ç›´æŽ¥è§¦ã£ã¡ã‚ƒãƒ€ãƒ¡ãªã‚‚ã®ï¼ˆæ™‚é–“ï¼‰ã‚’ â€œè–„ã„å£â€ ã§åŒ…ã‚€**ã“ã¨ðŸ˜Š

ã¡ãªã¿ã«ç¾æ™‚ç‚¹ã® .NET 10 ã®æœ€æ–°ã¯ **10.0.2ï¼ˆ2026-01-13ï¼‰** ã ã‚ˆã€œðŸ†• ([Microsoft][1])
ï¼ˆç« ã®å†…å®¹è‡ªä½“ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å·¦å³ã•ã‚Œã«ãã„ã‘ã©ã€æœ€æ–°å‰æã¯å¤§äº‹ãªã®ã§ä¸€å¿œã­âœ¨ï¼‰

---

## 1) ä»Šæ—¥ã®ãŠé¡Œï¼šãƒãƒƒãƒ”ãƒ¼ã‚¢ãƒ¯ãƒ¼å‰²å¼•â˜•ï¸ðŸŽŸï¸

![ç”»åƒã‚’æŒ¿å…¥äºˆå®š](./picture/tdd_cs_study_030_interface_abstraction.png)

ã€Œ15:00ã€œ16:59 ã®é–“ã¯ **10%å‰²å¼•**ï¼ã€ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã€ã‚ˆãã‚ã‚‹ã‚ˆã­ðŸ˜Š
ã§ã‚‚ã€å®Ÿè£…ã§ **DateTime.Now ã‚’ç›´ã§èª­ã‚€**ã¨â€¦ãƒ†ã‚¹ãƒˆãŒåœ°ç„ã«ãªã‚‹ã®ðŸ˜­ðŸ’¥

* ã„ã¾16æ™‚ãªã‚‰é€šã‚‹âœ…
* 15æ™‚ã˜ã‚ƒãªã„ã¨è½ã¡ã‚‹âŒ
* æ·±å¤œã«CIãŒå›žã£ãŸã‚‰è½ã¡ã‚‹âŒâŒ

ãƒ†ã‚¹ãƒˆã¯ **æ¯Žå›žåŒã˜çµæžœï¼ˆæ±ºå®šæ€§ï¼‰** ãŒå‘½ï¼ðŸŽ²ðŸš«
ã ã‹ã‚‰ã€Œæ™‚é–“ã€ã¯ **ä¾å­˜ï¼ˆå¤–éƒ¨è¦å› ï¼‰** ã¨ã—ã¦æ‰±ã£ã¦ã€å·®ã—æ›¿ãˆå¯èƒ½ã«ã™ã‚‹ã‚ˆã€œðŸ”âœ¨

---

## 2) Redï¼šã¾ãš â€œã“ã†æ›¸ããŸã„ãƒ†ã‚¹ãƒˆâ€ ã‚’æ›¸ãðŸŸ¥ðŸ§ª

ã€Œ16:00 ã®ã¨ãã¯ 10%å‰²å¼•ã€ã£ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã„ï¼

```csharp
using Xunit;

public class HappyHourDiscountTests
{
    [Fact]
    public void 16æ™‚ãªã‚‰10ãƒ‘ãƒ¼å‰²å¼•ã«ãªã‚‹()
    {
        // Arrange
        var clock = new FakeClock(new DateTimeOffset(2026, 1, 18, 16, 0, 0, TimeSpan.Zero));
        var calc = new PriceCalculator(clock);

        // Act
        var result = calc.ApplyHappyHourDiscount(1000m);

        // Assert
        Assert.Equal(900m, result);
    }
}
```

ã¯ã„ã€ã“ã“ã§å¤šåˆ†ã“ã†ãªã‚‹ã‚ˆã­ï¼š

* `FakeClock` ã£ã¦ä½•ï¼ŸâŒ
* `PriceCalculator(clock)` ãªã‚“ã¦ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ç„¡ã„ã‚ˆâŒ

ã§ã‚‚OKï¼ã“ã‚ŒãŒ **TDDã®Red**ï¼ˆå¤±æ•—ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰ã ã‚ˆã€œðŸŸ¥âœ¨
ã€Œã“ã†ã—ãŸã„ã€ã‹ã‚‰é€†ç®—ã—ã¦ã€å¿…è¦ãªå½¢ã‚’ä½œã‚‹ã®ãŒTDDã®å¼·ã¿ðŸ˜Š

---

## 3) ä¾å­˜ã‚’åŒ…ã‚€ â€œæœ€å°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹â€ ã‚’ä½œã‚‹ðŸ§±âœ¨

ã“ã“ãŒã“ã®ç« ã®æœ¬é¡Œï¼
**æœ€å°**ãŒè¶…å¤§äº‹ï¼ï¼ï¼ˆç››ã‚‹ã¨å¾Œã§ã—ã‚“ã©ã„ï¼‰ðŸ°ðŸ™…â€â™€ï¸

âœ… ä»Šæ—¥ã®æœ€å°ã‚»ãƒƒãƒˆã¯ã“ã‚Œã ã‘ï¼š

* `IClock`ï¼šä»Šã®æ™‚åˆ»ãŒå–ã‚Œã‚‹
* `SystemClock`ï¼šæœ¬ç‰©ã®æ™‚é–“ã‚’è¿”ã™ï¼ˆæœ¬ç•ªç”¨ï¼‰

```csharp
public interface IClock
{
    DateTimeOffset Now { get; }
}

public sealed class SystemClock : IClock
{
    public DateTimeOffset Now => DateTimeOffset.Now;
}
```

> ã“ã“ã§ `Now` ä»¥å¤–ï¼ˆ`Today` ã¨ã‹ `UtcNow` ã¨ã‹ `Elapsed` ã¨ã‹ï¼‰ã‚’è©°ã‚è¾¼ã¿ãŸããªã‚‹ã‘ã©ã€ä»Šæ—¥ã¯æˆ‘æ…¢ã€œï¼ðŸ˜‡
> **ã€Œå¿…è¦ã«ãªã£ãŸã‚‰å¢—ã‚„ã™ã€** ãŒå‹ã¡ã ã‚ˆðŸ†âœ¨

---

## 4) ãƒ†ã‚¹ãƒˆç”¨ã®æ™‚è¨ˆï¼ˆFakeClockï¼‰ã‚’ä½œã‚‹ðŸ•°ï¸ðŸ§ª

Fakeã¯ **ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´**ã«ç½®ãã®ãŒæ°—æ¥½ã§ãŠã™ã™ã‚ðŸ˜Š
ï¼ˆæœ¬ç•ªã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆéƒ½åˆã§æ±šã•ãªã„âœ¨ï¼‰

```csharp
public sealed class FakeClock : IClock
{
    public FakeClock(DateTimeOffset now) => Now = now;

    public DateTimeOffset Now { get; private set; }

    public void Set(DateTimeOffset now) => Now = now;
}
```

---

## 5) æœ¬ä½“ï¼ˆPriceCalculatorï¼‰ã§ â€œIClock ã—ã‹è¦‹ãªã„â€ ã‚ˆã†ã«ã™ã‚‹ðŸ‘€ðŸ”

ã“ã“ãŒ â€œå·®ã—æ›¿ãˆâ€ ã®å®Œæˆãƒã‚¤ãƒ³ãƒˆï¼

```csharp
public sealed class PriceCalculator
{
    private readonly IClock _clock;

    // ã€Œæœ€å°å°Žå…¥ã€ãªã®ã§ã€å¼•æ•°ãªã—ã§ã‚‚å‹•ãå½¢ã«ã—ã¦ãŠãã‚ˆðŸ˜Š
    public PriceCalculator(IClock? clock = null)
        => _clock = clock ?? new SystemClock();

    public decimal ApplyHappyHourDiscount(decimal subtotal)
    {
        var hour = _clock.Now.Hour;

        // 15:00ã€œ16:59 ã¯ 10%å‰²å¼•
        if (hour >= 15 && hour < 17)
            return subtotal * 0.9m;

        return subtotal;
    }
}
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã¯ã€Œä»ŠãŒä½•æ™‚ã‹ã€ã«é–¢ä¿‚ãªãã€**å¸¸ã«åŒã˜çµæžœ**ã«ãªã‚‹ã‚ˆã€œï¼ðŸŽ‰ðŸŽ‰ðŸŽ‰

---

## 6) Greenï¼šãƒ†ã‚¹ãƒˆã‚’å¢—ã‚„ã—ã¦å¢ƒç•Œã‚’å›ºã‚ã‚‹ðŸŸ©ðŸ§ªðŸ§±

å¢ƒç•Œï¼ˆã‚®ãƒªã‚®ãƒªï¼‰ã£ã¦ãƒã‚°ã‚Šã‚„ã™ã„ã‹ã‚‰ã€ãƒ†ã‚¹ãƒˆã§ã‚¬ãƒã‚¬ãƒã«ã™ã‚‹ã‚ˆðŸ’ªâœ¨

```csharp
using Xunit;

public class HappyHourDiscountTests
{
    [Fact]
    public void 16æ™‚ãªã‚‰10ãƒ‘ãƒ¼å‰²å¼•ã«ãªã‚‹()
    {
        var clock = new FakeClock(new DateTimeOffset(2026, 1, 18, 16, 0, 0, TimeSpan.Zero));
        var calc = new PriceCalculator(clock);

        var result = calc.ApplyHappyHourDiscount(1000m);

        Assert.Equal(900m, result);
    }

    [Fact]
    public void 14æ™‚ãªã‚‰å‰²å¼•ã•ã‚Œãªã„()
    {
        var clock = new FakeClock(new DateTimeOffset(2026, 1, 18, 14, 59, 0, TimeSpan.Zero));
        var calc = new PriceCalculator(clock);

        var result = calc.ApplyHappyHourDiscount(1000m);

        Assert.Equal(1000m, result);
    }

    [Fact]
    public void 17æ™‚ã¡ã‚‡ã†ã©ã¯å‰²å¼•ã•ã‚Œãªã„()
    {
        var clock = new FakeClock(new DateTimeOffset(2026, 1, 18, 17, 0, 0, TimeSpan.Zero));
        var calc = new PriceCalculator(clock);

        var result = calc.ApplyHappyHourDiscount(1000m);

        Assert.Equal(1000m, result);
    }
}
```

---

## 7) Refactorï¼šã“ã®ç« ã§ã‚„ã‚‹ â€œæ•´ç†â€ ã¯ã“ã‚Œã ã‘ã§OKðŸ§¹âœ¨

ã“ã®æ®µéšŽã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã¯ã€**èª­ã¿ã‚„ã™ã•å„ªå…ˆ**ã§è»½ãã­ðŸ˜Š

* âœ… `15` ã¨ `17` ã‚’å®šæ•°ã«ã™ã‚‹ï¼ˆæ„å›³ãŒè¦‹ãˆã‚‹ï¼‰
* âœ… ãƒ¡ã‚½ãƒƒãƒ‰åã‚’ â€œæŒ¯ã‚‹èˆžã„â€ ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ï¼ˆèª­ã¿ç‰©åŒ–ðŸ“˜ï¼‰
* âœ… ãƒ†ã‚¹ãƒˆã®ArrangeãŒé‡ããªã£ã¦ããŸã‚‰ã€Œè¾›ã•ã€ã®ã‚µã‚¤ãƒ³ðŸ‘ƒðŸš¨ï¼ˆæ¬¡ã®ç« ä»¥é™ã§è‚²ã¦ã‚‹ï¼‰

---

## 8) ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ã‚ã‚‹ã‚ã‚‹ðŸ˜µâ€ðŸ’«âš ï¸

### âŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç››ã‚Šã™ãŽã‚‹

`IClock` ã« `Today` ã‚„ `UtcNow` ã‚„ `NowTicks` ã‚’å…¥ã‚Œå§‹ã‚ã‚‹ã¨ã€æœªæ¥ã§ç ´ç¶»ã—ãŒã¡â€¦ðŸ’¥
âœ… ã¾ãšã¯ **Nowã ã‘**ï¼

### âŒ â€œä½•ã§ã‚‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹â€ ã«ã™ã‚‹

æŠ½è±¡åŒ–ã¯ã‚³ã‚¹ãƒˆã‚‚ã‚ã‚‹ã‚ˆã€œï¼
âœ… **å¤–éƒ¨è¦å› ï¼ˆæ™‚é–“ãƒ»ä¹±æ•°ãƒ»I/Oï¼‰** ã¿ãŸã„ãªã€Œãƒ†ã‚¹ãƒˆã‚’å£Šã™ã‚„ã¤ã€ã‹ã‚‰ã§OKðŸ˜Š

### âŒ ãƒ†ã‚¹ãƒˆãŒ â€œæœ¬ç‰©ã®æ™‚é–“â€ ã«è§¦ã£ã¦ã‚‹

`DateTimeOffset.Now` ãŒ1è¡Œã§ã‚‚ãƒ†ã‚¹ãƒˆã«æ··ã–ã‚‹ã¨ã€æ±ºå®šæ€§ãŒæ­»ã¬ðŸ˜‡
âœ… ãƒ†ã‚¹ãƒˆã¯ Fake ã ã‘ã‚’è¦‹ã‚‹ï¼

---

## 9) AIã®ä½¿ã„ã©ã“ã‚ï¼ˆã“ã®ç« ã®å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ðŸ¤–âœ¨

AIã¯ä¾¿åˆ©ã ã‘ã©ã€**ç››ã‚ŠãŒã¡**ã ã‹ã‚‰ã€Œæœ€å°ã€ã‚’å®ˆã‚‹ç”¨é€”ã§ä½¿ã†ã®ãŒã‚³ãƒ„ðŸ˜Š

ãŠã™ã™ã‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ðŸ‘‡

* ã€Œ`DateTime.Now` ã®ä¾å­˜ã‚’å·®ã—æ›¿ãˆã‚‹ãŸã‚ã® **æœ€å°** ã® `IClock` ã‚’ææ¡ˆã—ã¦ã€
* ã€Œ`FakeClock` ã®å®Ÿè£…ã‚’ä½œã£ã¦ã€‚**ä½™è¨ˆãªæ©Ÿèƒ½ã¯å…¥ã‚Œãªã„ã§**ã€
* ã€Œã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åã€`IClock` / `ITimeProvider` / `IDateTimeProvider` ã®ã©ã‚ŒãŒèª¤è§£å°‘ãªã„ï¼Ÿç†ç”±ã‚‚ï¼ã€

---

## 10) ãƒŸãƒ‹èª²é¡ŒðŸŽ’âœ¨ï¼ˆæ‰‹ã‚’å‹•ã‹ã™ã‚„ã¤ï¼‰

### èª²é¡ŒAï¼šä¹±æ•°ã‚‚å·®ã—æ›¿ãˆã‚ˆã†ðŸŽ²ðŸ”

* `Random.Shared.Next()` ã‚’ç›´æŽ¥ä½¿ã£ã¦ã‚‹ç®‡æ‰€ã‚’è¦‹ã¤ã‘ã¦
* `IRandom`ï¼ˆä¾‹ï¼š`int Next(int min, int max)`ï¼‰ã§åŒ…ã‚“ã§
* ãƒ†ã‚¹ãƒˆã§å›ºå®šå€¤ã‚’è¿”ã™ Fake ã«å·®ã—æ›¿ãˆã¦ã¿ã¦ã­ðŸ˜Š

### èª²é¡ŒBï¼šæ™‚è¨ˆã‚’é€²ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†â©ðŸ•°ï¸

* `FakeClock.Set(...)` ã‚’ä½¿ã£ã¦
* ã€Œ16:59ã¯å‰²å¼•ã€17:00ã¯å‰²å¼•ãªã—ã€ã‚’ **åŒã˜ãƒ†ã‚¹ãƒˆå†…ã§ç¢ºèª**ã—ã¦ã¿ã‚ˆã†âœ¨

---

## 11) æå‡ºç‰©ï¼ˆã‚³ãƒŸãƒƒãƒˆå˜ä½ã®ãŠã™ã™ã‚ï¼‰ðŸ“¦âœ…

* âœ… `test: 16æ™‚ã¯10%å‰²å¼•`ï¼ˆã¾ãšRedï¼‰
* âœ… `feat: IClock + FakeClock è¿½åŠ `ï¼ˆå·®ã—æ›¿ãˆã®é“å…·ï¼‰
* âœ… `feat: PriceCalculator ãŒ IClock ã‚’ä½¿ã†`ï¼ˆä¾å­˜ã®ç½®ãæ›ãˆï¼‰
* âœ… `test: å¢ƒç•Œ(14:59/17:00)è¿½åŠ `ï¼ˆå®ˆã‚Šã‚’å›ºã‚ã‚‹ï¼‰
* âœ… `refactor: ãƒžã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼æ•´ç†`ï¼ˆè»½ãæ•´ãˆã‚‹ï¼‰

---

## 12) ä»Šæ—¥ã®ã¾ã¨ã‚ï¼ˆè¶…ã ã„ã˜ï¼‰ðŸŽ¯âœ¨

* **æ™‚é–“ã¯å¤–éƒ¨è¦å› ** â†’ ãƒ†ã‚¹ãƒˆã‚’å£Šã™ðŸ’¥
* ã ã‹ã‚‰ **IClock ã§åŒ…ã‚€** â†’ ãƒ†ã‚¹ãƒˆã‹ã‚‰å·®ã—æ›¿ãˆå¯èƒ½ðŸ”
* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ **æœ€å°** ãŒæ­£ç¾©ðŸ°âœ…
* æ¬¡ã®ç« ã§ã€ã“ã®å·®ã—æ›¿ãˆã‚’ã‚‚ã£ã¨ã‚­ãƒ¬ã‚¤ã«ã™ã‚‹ï¼ˆDIå…¥é–€ï¼‰ðŸ“¦âœ¨

C# 14 ã¯ .NET 10 ä¸Šã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã¦ã€Visual Studio 2026 ã«ã‚‚ .NET 10 SDK ãŒå…¥ã£ã¦ã‚‹ã‚ˆã€œðŸ§©âœ¨ ([Microsoft Learn][2])
xUnit v3 ã‚‚å®‰å®šç‰ˆãŒå‡ºã¦ã„ã¦ã€ãƒªãƒªãƒ¼ã‚¹ä¸€è¦§ã¯ã“ã“ã§è¿½ãˆã‚‹ã‚ˆðŸ“Œ ([xunit.net][3])

---

æ¬¡ã¯ **ç¬¬31ç« ï¼šã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ï¼ˆDIå…¥é–€ï¼‰ðŸ“¦** ã§ã€ä»Šæ—¥ã® `IClock` ã‚’ã‚‚ã£ã¨æ°—æŒã¡ã‚ˆãä½¿ãˆã‚‹å½¢ã«æ•´ãˆã¦ã„ãã‚ˆã€œðŸ˜ŠðŸ’ªâœ¨

[1]: https://dotnet.microsoft.com/en-US/download/dotnet/10.0?utm_source=chatgpt.com "Download .NET 10.0 (Linux, macOS, and Windows) | .NET"
[2]: https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-14?utm_source=chatgpt.com "What's new in C# 14"
[3]: https://xunit.net/releases/?utm_source=chatgpt.com "Release Notes"
