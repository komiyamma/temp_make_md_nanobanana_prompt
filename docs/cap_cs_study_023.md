# ç¬¬23ç« ï¼šã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã®è‚Œæ„Ÿè¦šï¼ˆæŠ¼ã—ã¤ã¶ã•ãªã„ï¼‰ğŸ§¯ğŸš§

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ğŸ¯âœ¨

* ã€Œå£Šã‚Œã¦ã‚‹ç›¸æ‰‹ã«çªæ’ƒã—ç¶šã‘ã‚‹ã€ã‚’ã‚„ã‚ã¦ã€**è‡ªåˆ†ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®ˆã‚‹**è€ƒãˆæ–¹ãŒã‚ã‹ã‚‹ğŸ›¡ï¸
* **Closed / Open / Half-Open** ã®çŠ¶æ…‹ãŒã€Œã„ã¾ä½•ã‚’ã—ã¦ã‚‹ã®ã‹ã€èª¬æ˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸš¦
* CampusCafe ã® **æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ãŒä¸èª¿**ãªã¨ãã«ã€æ³¨æ–‡APIãŒå·»ãæ·»ãˆã§æ­»ãªãªã„è¨­è¨ˆãŒã§ãã‚‹â˜•ğŸ’³ğŸ˜µâ€ğŸ’«â†’ğŸ˜Œ
* å¤±æ•—ç‡ãƒ»é…å»¶ã‚’è¦‹ãªãŒã‚‰ã€Œã„ã¤æ­¢ã‚ã‚‹ï¼Ÿã€ã®ãƒ«ãƒ¼ãƒ«ï¼ˆé–¾å€¤ï¼‰ã‚’æ±ºã‚ã‚‰ã‚Œã‚‹ğŸ“‰ğŸ“ˆ

---

## ã¾ãšã‚¤ãƒ¡ãƒ¼ã‚¸ï¼šã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã£ã¦ä½•ï¼ŸğŸ”Œâš¡

ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã¯ã€é›»æ°—ã®ãƒ–ãƒ¬ãƒ¼ã‚«ã¿ãŸã„ã« **å±ãªã„çŠ¶æ…‹ã«ãªã£ãŸã‚‰ä¸€æ—¦é®æ–­ã—ã¦**ã€ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ **æ§˜å­è¦‹ï¼ˆãƒ†ã‚¹ãƒˆï¼‰**ã—ã¦å›å¾©ã—ãŸã‚‰å¾©å¸°ã™ã‚‹ä»•çµ„ã¿ã ã‚ˆğŸ§¯âœ¨
ã€Œç›¸æ‰‹ãŒå£Šã‚Œã¦ã‚‹ã®ã«å‘¼ã³ç¶šã‘ã¦ã€è‡ªåˆ†ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚„æ¥ç¶šã‚„å¾…ã¡æ™‚é–“ãŒè©°ã¾ã£ã¦ã€ã“ã£ã¡ã¾ã§æ­»ã¬ğŸ’¥ã€ã®ã‚’é˜²ãã®ãŒç›®çš„ã€‚

Microsoft ã® Circuit Breaker Pattern ã§ã‚‚ã€Œãƒªãƒ¢ãƒ¼ãƒˆå‘¼ã³å‡ºã—ã®å¤±æ•—ãŒç¶šããªã‚‰ã€ã™ãå¤±æ•—ã•ã›ã¦è³‡æºã‚’å®ˆã‚‹ã€ç™ºæƒ³ãŒä¸­å¿ƒã ã‚ˆã€‚([Microsoft Learn][1])

---

## CampusCafe ã ã¨ã€ã©ã“ã§åŠ¹ãï¼Ÿâ˜•ğŸ“±

ä¾‹ï¼š**æ³¨æ–‡APIï¼ˆOrderï¼‰â†’ æ±ºæ¸ˆAPIï¼ˆPaymentï¼‰** ã‚’å‘¼ã¶

* æ±ºæ¸ˆAPIãŒä¸èª¿ï¼ˆé…ã„ãƒ»è½ã¡ã¦ã‚‹ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ğŸ˜µâ€ğŸ’«
* æ³¨æ–‡APIãŒæ¯å›å¾…ãŸã•ã‚Œã‚‹ã¨ã€æ³¨æ–‡APIå´ã®ã‚¹ãƒ¬ãƒƒãƒ‰/æ¥ç¶š/ã‚­ãƒ¥ãƒ¼ãŒæ¸‹æ»ğŸš—ğŸš—ğŸš—
* ãã®ã†ã¡ **æ³¨æ–‡APIãŒå¥åº·ã§ã‚‚ã€æ³¨æ–‡APIãŒè½ã¡ã‚‹**ï¼ˆå·»ãæ·»ãˆï¼‰ğŸ’¥

ãã“ã§ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«âœ¨
ã€Œä»Šã¯æ±ºæ¸ˆãŒæ€ªã—ã„ã‹ã‚‰ã€**å³åº§ã«â€œä»Šã¯ç„¡ç†â€ã§è¿”ã™**ã€ã«åˆ‡ã‚Šæ›¿ãˆã¦ã€æ³¨æ–‡APIã‚’å»¶å‘½ã™ã‚‹ğŸ›¡ï¸

---

## çŠ¶æ…‹ã®è‚Œæ„Ÿè¦šï¼šClosed / Open / Half-Open ğŸš¦

```mermaid
stateDiagram-v2
    [*] --> Closed
    
    Closed --> Open: å¤±æ•—ãŒé–¾å€¤ã‚’è¶…ãˆãŸ!ğŸ’¥
    note right of Open
        é®æ–­ä¸­: å‘¼ã‚“ã§ã‚‚å³ã‚¨ãƒ©ãƒ¼(Fail Fast)
    end note
    
    Open --> HalfOpen: é®æ–­æ™‚é–“ãŒçµŒéâ³
    note right of HalfOpen
        æ§˜å­è¦‹: 1å›ã ã‘è©¦ã—ã¦ã¿ã‚‹
    end note
    
    HalfOpen --> Closed: æˆåŠŸã—ãŸ!ğŸ‰
    HalfOpen --> Open: ã¾ãŸå¤±æ•—ã—ãŸ...ğŸ˜¢
```




![cap_cs_study_023_circuit_breaker_states](./picture/cap_cs_study_023_circuit_breaker_states.png)

ã–ã£ãã‚Šã“ã®3ã¤ãŒè¶…å¤§äº‹ï¼

* **Closedï¼ˆé€šå¸¸ï¼‰**ï¼šæ™®é€šã«å‘¼ã¶âœ…
* **Openï¼ˆé®æ–­ï¼‰**ï¼šã—ã°ã‚‰ãå‘¼ã°ãªã„ğŸš«ï¼ˆå‘¼ã‚“ã§ã‚‚å³å¤±æ•—ï¼â€œFail Fastâ€ï¼‰
* **Half-Openï¼ˆæ§˜å­è¦‹ï¼‰**ï¼šå°‘ã—ã ã‘è©¦ã—ã¦ã€æˆåŠŸã—ãŸã‚‰Closedã¸ã€å¤±æ•—ã—ãŸã‚‰Openã¸æˆ»ã‚‹ğŸ”

ã“ã®çŠ¶æ…‹é·ç§»ãŒã€Œã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã®å¿ƒè‡“ã€ã ã‚ˆğŸ«€([Microsoft Learn][1])

---

## ä½•ã‚’è¦‹ã¦ã€Œé®æ–­ã™ã‚‹ã€ã£ã¦æ±ºã‚ã‚‹ã®ï¼ŸğŸ“‰

ã‚ˆãä½¿ã†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã“ã®4ã¤ğŸ‘‡ï¼ˆã“ã“ãŒâ€œè¨­è¨ˆãƒã‚¤ãƒ³ãƒˆâ€ï¼ï¼‰

* **FailureRatioï¼ˆå¤±æ•—ç‡ï¼‰**ï¼šä½•å‰²å¤±æ•—ã—ãŸã‚‰å±é™ºï¼Ÿï¼ˆä¾‹ï¼š50%ï¼‰
* **MinimumThroughputï¼ˆæœ€ä½è©¦è¡Œæ•°ï¼‰**ï¼šã‚µãƒ³ãƒ—ãƒ«ãŒå°‘ãªã™ãã‚‹ã¨ãƒ–ãƒ¬ã‚‹ã®ã§ã€æœ€ä½ä½•å›ã¯è¦‹ã‚ˆã†ï¼Ÿï¼ˆä¾‹ï¼š8å›ï¼‰
* **SamplingDurationï¼ˆè¦³æ¸¬æ™‚é–“ï¼‰**ï¼šç›´è¿‘ã©ã‚Œãã‚‰ã„ã®æœŸé–“ã‚’è¦‹ã‚‹ï¼Ÿï¼ˆä¾‹ï¼š10ç§’ï¼‰
* **BreakDurationï¼ˆé®æ–­æ™‚é–“ï¼‰**ï¼šOpenã«ãªã£ãŸã‚‰ã©ã‚Œãã‚‰ã„æ­¢ã‚ã‚‹ï¼Ÿï¼ˆä¾‹ï¼š5ç§’ï¼‰

æ¨™æº–ã®HTTPãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹è¨­å®šã§ã‚‚ã€ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã¯ **å¤±æ•—ç‡10%ãƒ»æœ€ä½100å›ãƒ»è¦³æ¸¬30ç§’ãƒ»é®æ–­5ç§’**ã¿ãŸã„ãªæ—¢å®šå€¤ãŒã‚ã‚‹ã‚ˆã€‚([Microsoft Learn][2])
ãŸã ã—ã€å­¦ç¿’ç”¨ã‚„å°è¦æ¨¡ã‚·ã‚¹ãƒ†ãƒ ã ã¨ **MinimumThroughput=100** ã¯ãªã‹ãªã‹åˆ°é”ã—ãªã„ã®ã§ã€ä»Šå›ã¯â€œå‹•ããŒè¦‹ãˆã‚‹â€å€¤ã«ä¸‹ã’ã¦ä½“é¨“ã™ã‚‹ã­ğŸ˜Š

---

## ã€Œãƒªãƒˆãƒ©ã‚¤ã€ã¨ã®é–¢ä¿‚ã¯ï¼ŸğŸ”ğŸ§ 

* **ãƒªãƒˆãƒ©ã‚¤**ï¼šãŸã¾ãŸã¾ã®å¤±æ•—ãªã‚‰ã€ã‚‚ã†ä¸€å›ã‚„ã£ã¦ã¿ã‚‹ï¼ˆå„ªã—ã„ï¼‰ğŸ’
* **ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«**ï¼šå¤±æ•—ãŒç¶šããªã‚‰ã€ã‚‚ã†çªæ’ƒã—ãªã„ï¼ˆå®ˆã‚‹ï¼‰ğŸ›¡ï¸

æ¨™æº–ã®HTTPãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã¯ã€ï¼ˆå¤–å´â†’å†…å´ï¼‰ã« **ãƒ¬ãƒ¼ãƒˆåˆ¶é™â†’å…¨ä½“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ†’ãƒªãƒˆãƒ©ã‚¤â†’ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«â†’è©¦è¡Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** ã¿ãŸã„ã«ç©ã¾ã‚Œã‚‹ã‚ˆã€‚([Microsoft Learn][2])
ã¤ã¾ã‚Šã€Œã¾ãšãƒªãƒˆãƒ©ã‚¤ã§è»½ãç²˜ã‚‹ â†’ ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãŒç¶šããªã‚‰é®æ–­ã€ã£ã¦ç™ºæƒ³ã«ãªã£ã¦ã‚‹ğŸ˜Š

---

# ãƒŸãƒ‹æ¼”ç¿’ï¼šé®æ–­ãƒ«ãƒ¼ãƒ«ã‚’è€ƒãˆã¦ã¿ã‚ˆã†âœï¸ğŸ§¯

CampusCafe ã®ã€Œæ±ºæ¸ˆã€ã‚’æƒ³åƒã—ã¦ã€æ¬¡ã‚’æ±ºã‚ã¦ã¿ã‚ˆã†ğŸ’­ğŸ’³

1. **å¤±æ•—ç‡ï¼ˆFailureRatioï¼‰**ï¼šä½•å‰²å¤±æ•—ã—ãŸã‚‰é®æ–­ï¼Ÿï¼ˆä¾‹ï¼š0.5ï¼‰
2. **æœ€ä½å›æ•°ï¼ˆMinimumThroughputï¼‰**ï¼šä½•å›è¦‹ãŸã‚‰åˆ¤æ–­ã—ã¦ã„ã„ï¼Ÿï¼ˆä¾‹ï¼š8ï¼‰
3. **è¦³æ¸¬æ™‚é–“ï¼ˆSamplingDurationï¼‰**ï¼šç›´è¿‘ä½•ç§’ã®å‡ºæ¥äº‹ã‚’è¦‹ã‚‹ï¼Ÿï¼ˆä¾‹ï¼š10ç§’ï¼‰
4. **é®æ–­æ™‚é–“ï¼ˆBreakDurationï¼‰**ï¼šé®æ–­ã¯ä½•ç§’ï¼Ÿï¼ˆä¾‹ï¼š5ç§’ï¼‰

ğŸ’¡è€ƒãˆæ–¹ã®ã‚³ãƒ„

* åˆ©ç”¨è€…ãŒå¤šã„æ™‚é–“å¸¯ã¯ã€çŸ­æ™‚é–“ã§ã‚‚å¤±æ•—ãŒé›†ä¸­ã—ã‚„ã™ã„â†’æ—©ã‚ã«é®æ–­ãŒå½¹ç«‹ã¤ã‹ã‚‚ğŸ“ˆ
* é®æ–­ãŒé•·ã™ãã‚‹ã¨ã€Œå¾©æ´»ã—ã¦ã‚‹ã®ã«æ©Ÿä¼šæå¤±ã€ã«ãªã‚‹â†’çŸ­ã‚ï¼‹Half-Openã§æ§˜å­è¦‹ãŒç„¡é›£ã‹ã‚‚ğŸ£

---

# ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šå£Šã‚Œã‚‹æ±ºæ¸ˆAPIã‚’ä½œã£ã¦ã€é®æ–­ã‚’ä½“é¨“ã—ã‚ˆã†â˜•ğŸ’¥â†’ğŸ§¯âœ¨

## 1) æ±ºæ¸ˆã‚¹ã‚¿ãƒ–ï¼ˆPaymentStubï¼‰ã‚’ä½œã‚‹ğŸ’³ğŸ§ª

ã‚„ã‚‹ã“ã¨ï¼š**æˆåŠŸã—ãŸã‚Šå¤±æ•—ã—ãŸã‚Šã€ãŸã¾ã«é…ã„**APIã‚’ç”¨æ„ã™ã‚‹ï¼ˆç¾å®Ÿã£ã½ã„ï¼ï¼‰

### PaymentStub / Program.cs

```csharp
using Microsoft.AspNetCore.Mvc;

var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

var random = new Random();

// å¤±æ•—ç‡ã¨é…å»¶ã‚’é›‘ã«å†ç¾ï¼ˆå­¦ç¿’ç”¨ï¼‰
const double failRate = 0.7;      // 70% å¤±æ•—
const int slowRatePercent = 30;   // 30% é…ã„
const int slowMs = 1500;          // é…ã„ã¨ã 1.5s

app.MapGet("/health", () => Results.Ok(new { ok = true }));

app.MapPost("/charge", async ([FromBody] ChargeRequest req) =>
{
    // ãŸã¾ã«é…ãã™ã‚‹
    if (random.Next(100) < slowRatePercent)
        await Task.Delay(slowMs);

    // ã‚ˆãè½ã¡ã‚‹
    if (random.NextDouble() < failRate)
        return Results.StatusCode(500);

    return Results.Ok(new { paid = true, orderId = req.OrderId, amount = req.Amount });
});

app.Run();

record ChargeRequest(string OrderId, int Amount);
```

---

## 2) æ³¨æ–‡APIï¼ˆOrderApiï¼‰å´ã«ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã‚’å…¥ã‚Œã‚‹ğŸ§¯ğŸš§

ã“ã“ã§ã¯ **HttpClientã«ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼ˆCircuit Breaker + Timeoutï¼‰** ã‚’ä»˜ã‘ã‚‹ã‚ˆã€‚

ã“ã®ç« ã®ãƒã‚¤ãƒ³ãƒˆã¯ã€Œ**ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãŒOpenã®ã¨ãã€å³å¤±æ•—ï¼ˆFail Fastï¼‰ã«ãªã£ã¦æ³¨æ–‡APIãŒè»½ããªã‚‹**ã€ã‚’ä½“æ„Ÿã™ã‚‹ã“ã¨âœ¨

### OrderApi / è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ğŸ“¦

* `Microsoft.Extensions.Http.Resilience`

ï¼ˆMicrosoft Learn ã§ã‚‚ `AddResilienceHandler` ã¨ `HttpCircuitBreakerStrategyOptions` ã‚’ä½¿ã†ä¾‹ãŒè¼‰ã£ã¦ã‚‹ã‚ˆï¼‰([Microsoft Learn][2])

### OrderApi / Program.csï¼ˆé‡è¦ãªã¨ã“ã‚ã ã‘ï¼‰

```csharp
using System.Diagnostics;
using System.Net;
using System.Net.Http.Json;
using Microsoft.AspNetCore.Mvc;
using Polly.CircuitBreaker;
using Polly.Timeout;

var builder = WebApplication.CreateBuilder(args);

// Payment ã¸ã® HttpClient
builder.Services.AddHttpClient("payment", client =>
{
    client.BaseAddress = new Uri("http://localhost:5005"); // PaymentStub ã®URLã«åˆã‚ã›ã¦ã­
})
.AddResilienceHandler("payment-pipeline", static pipeline =>
{
    // â‘  ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ï¼ˆå­¦ç¿’ç”¨ã« â€œå‹•ãå€¤â€ ã«èª¿æ•´ï¼‰
    pipeline.AddCircuitBreaker(new HttpCircuitBreakerStrategyOptions
    {
        SamplingDuration = TimeSpan.FromSeconds(10),
        FailureRatio = 0.5,
        MinimumThroughput = 8,
        BreakDuration = TimeSpan.FromSeconds(5),

        // ä½•ã‚’ã€Œå¤±æ•—ã€ã¨ã—ã¦æ•°ãˆã‚‹ã‹ï¼ˆä¾‹ï¼š5xx / 408 / 429 / ä¾‹å¤–ï¼‰
        ShouldHandle = static args =>
        {
            if (args.Outcome.Exception is HttpRequestException or TimeoutRejectedException)
                return ValueTask.FromResult(true);

            var code = args.Outcome.Result?.StatusCode;
            return ValueTask.FromResult(code is
                >= HttpStatusCode.InternalServerError or
                HttpStatusCode.RequestTimeout or
                HttpStatusCode.TooManyRequests);
        }
    });

    // â‘¡ 1å›ã®è©¦è¡Œã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆé…ã„ç›¸æ‰‹ã«å¾…ã¡ç¶šã‘ãªã„ï¼‰
    pipeline.AddTimeout(TimeSpan.FromMilliseconds(700));
});

var app = builder.Build();

app.MapPost("/orders", async ([FromBody] PlaceOrderRequest req, IHttpClientFactory factory) =>
{
    var client = factory.CreateClient("payment");
    var sw = Stopwatch.StartNew();

    try
    {
        var res = await client.PostAsJsonAsync("/charge", new { orderId = req.OrderId, amount = req.Amount });

        // æ±ºæ¸ˆãŒ500ãªã‚‰ã€ãã®ã¾ã¾ã€Œä¸€æ™‚çš„å¤±æ•—ã€ã¨ã—ã¦æ‰±ã†
        if (!res.IsSuccessStatusCode)
        {
            return Results.Problem(
                title: "æ±ºæ¸ˆãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸã‚ˆâ€¦ğŸ˜¢",
                detail: $"status={(int)res.StatusCode}, elapsed={sw.ElapsedMilliseconds}ms",
                statusCode: 502);
        }

        return Results.Ok(new
        {
            ok = true,
            message = "æ³¨æ–‡ã§ããŸã‚ˆã€œâ˜•âœ¨",
            elapsedMs = sw.ElapsedMilliseconds
        });
    }
    catch (BrokenCircuitException ex)
    {
        // ã“ã“ãŒâ€œFail Fastâ€ä½“é¨“ãƒã‚¤ãƒ³ãƒˆâœ¨
        var retryAfter = ex.RetryAfter?.TotalSeconds;

        return Results.Problem(
            title: "ã„ã¾æ±ºæ¸ˆãŒæ··é›‘ä¸­ãªã®ã§ã€å°‘ã—å¾…ã£ã¦ã­ğŸ§¯ğŸ’¦",
            detail: $"circuit=OPEN, elapsed={sw.ElapsedMilliseconds}ms, retryAfterSeconds={retryAfter}",
            statusCode: 503);
    }
    catch (TimeoutRejectedException)
    {
        return Results.Problem(
            title: "æ±ºæ¸ˆãŒé…ã™ããŸã®ã§ä¸­æ–­ã—ãŸã‚ˆâ±ï¸ğŸ’¦",
            detail: $"elapsed={sw.ElapsedMilliseconds}ms",
            statusCode: 504);
    }
});

app.Run();

record PlaceOrderRequest(string OrderId, int Amount);
```

* `BrokenCircuitException` ã¯ã€Œå›è·¯ãŒOpenã ã‹ã‚‰å³é®æ–­ã—ãŸã‚ˆï¼ã€ã®åˆå›³ã§ã€`RetryAfter` ã‚’æŒã¦ã‚‹ã‚ˆã€‚([PollyDocs][3])
* `HttpCircuitBreakerStrategyOptions` ã‚’ `AddResilienceHandler` ã§è¶³ã™å½¢ã¯ Microsoft Learn ã®ä¾‹ã¨åŒã˜æµã‚Œã ã‚ˆã€‚([Microsoft Learn][2])

---

## 3) ä½“é¨“ï¼šOpenã«ãªã‚‹ã¨â€œé€Ÿãå¤±æ•—ã™ã‚‹â€ã®ã‚’è¦‹ã‚ˆã†ğŸ‘€âš¡

åŒã˜æ³¨æ–‡ã‚’é€£æ‰“ã—ã¦ã€æœ€åˆã¯ã€Œé…ãå¤±æ•—ã€â†’ ã—ã°ã‚‰ãã™ã‚‹ã¨ã€Œä¸€ç¬ã§503ã€ã«ãªã‚‹ã®ãŒè¦‹ãˆãŸã‚‰æˆåŠŸğŸ‰

PowerShellã§ã®é€£æ‰“ä¾‹ï¼ˆOrderApiã®URLã¯è‡ªåˆ†ã®ã«åˆã‚ã›ã¦ã­ï¼‰

```powershell
1..25 | % {
  try {
    $body = @{ orderId = "o-$_"; amount = 500 } | ConvertTo-Json
    $r = Invoke-WebRequest -Method Post -Uri "http://localhost:5001/orders" -ContentType "application/json" -Body $body
    "$($_): $($r.StatusCode)"
  } catch {
    "$($_): $($_.Exception.Response.StatusCode.value__)"
  }
}
```

âœ… è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆ

* **é®æ–­å‰**ï¼š500ã‚„504ãŒå‡ºã‚‹ã€‚ã—ã‹ã‚‚é…ã„ã¨ãã¯å¾…ãŸã•ã‚Œã‚‹ğŸ¢
* **é®æ–­å¾Œï¼ˆOpenï¼‰**ï¼š503ãŒå¢—ãˆã‚‹ã€‚ã—ã‹ã‚‚è¿”ã£ã¦ãã‚‹ã®ãŒé€Ÿã„âš¡ï¼ˆæ³¨æ–‡APIãŒå®ˆã‚‰ã‚Œã¦ã‚‹ï¼ï¼‰

---

# é–¾å€¤ã®æ±ºã‚æ–¹ï¼šè¶…å…¥é–€ã®â€œå‹â€ğŸ“ŒğŸ˜Š

è¿·ã£ãŸã‚‰ã“ã®é †ã§è€ƒãˆã‚‹ã¨ãƒ©ã‚¯ã ã‚ˆã€œâœ¨

1. **ã¾ãšã¯ã€Œã©ã‚Œãã‚‰ã„å¾…ãŸã›ãŸããªã„ï¼Ÿã€** â†’ Timeout ã‚’æ±ºã‚ã‚‹â±ï¸
2. **æ¬¡ã«ã€Œä½•å‰²å¤±æ•—ã—ãŸã‚‰å±é™ºï¼Ÿã€** â†’ FailureRatioï¼ˆä¾‹ï¼š0.5ï¼‰ğŸ“‰
3. **ã€Œèª¤åˆ¤å®šãŒæ€–ã„ã€ãªã‚‰æœ€ä½å›æ•°ã‚’ä¸Šã’ã‚‹** â†’ MinimumThroughputğŸ“Š
4. **ã€Œå¾©æ´»ãŒæ—©ã„ç›¸æ‰‹ã€ãªã‚‰é®æ–­ã‚’çŸ­ã** â†’ BreakDurationğŸ£

å…¬å¼ã®æ—¢å®šå€¤ï¼ˆå¤±æ•—ç‡10%ãªã©ï¼‰ã‚‚ã‚ã‚‹ã‘ã©ã€äº¤é€šé‡ãŒå°‘ãªã„ç’°å¢ƒã ã¨ MinimumThroughput ãŒåŠ¹ãã™ãã‚‹ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã€çŠ¶æ³ã«åˆã‚ã›ã¦èª¿æ•´ãŒå¿…è¦ã ã‚ˆã€‚([Microsoft Learn][2])

---

# ã‚ã‚ŠãŒã¡ãªå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³é›†ğŸ˜‡ğŸ’¥

## âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šé®æ–­ã—ãªã„ï¼ˆçªæ’ƒã—ç¶šã‘ã‚‹ï¼‰

â†’ è‡ªåˆ†ã®APIãŒè©°ã¾ã£ã¦å·»ãæ·»ãˆã§è½ã¡ã‚‹ğŸ˜µâ€ğŸ’«

## âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šé®æ–­ãŒé•·ã™ãã‚‹

â†’ ã‚‚ã†æ²»ã£ã¦ã‚‹ã®ã«ãšã£ã¨503ã§æ©Ÿä¼šæå¤±ğŸ¥²

## âŒ å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒå°‘ãªã„ã®ã« MinimumThroughput ãŒå¤§ãã„

â†’ ã„ã¤ã¾ã§çµŒã£ã¦ã‚‚Openã«ãªã‚‰ãšã€ŒåŠ¹ã„ã¦ã‚‹ã®ã‹åˆ†ã‹ã‚‰ãªã„ã€å•é¡ŒğŸ¤”
ï¼ˆä»Šå›ã¯å­¦ç¿’ç”¨ã«å°ã•ãã—ãŸã­ï¼‰

---

# AIæ´»ç”¨ã‚³ãƒ¼ãƒŠãƒ¼ğŸ¤–ğŸ’¡ï¼ˆã‚³ãƒ”ãƒšOKï¼‰

* ã€Œæ±ºæ¸ˆAPIãŒè½ã¡ã‚„ã™ã„ã‚“ã ã‘ã©ã€FailureRatio/MinimumThroughput/SamplingDuration/BreakDuration ã®åˆæœŸæ¡ˆã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³å‡ºã—ã¦ã€‚æ ¹æ‹ ã‚‚çŸ­ãã€ğŸ“Œ
* ã€ŒCampusCafeã®â€œæ±ºæ¸ˆå¤±æ•—æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ–‡è¨€â€ã‚’ã€ä¸å®‰ã«ã•ã›ãªã„æ„Ÿã˜ã§10æ¡ˆã¡ã‚‡ã†ã ã„ğŸ’¬ğŸŒ¸ã€
* ã€Œ503ãŒå‡ºãŸæ™‚ã«ã€UXã¨ã—ã¦ä½•ã‚’ç”»é¢ã«å‡ºã™ã¹ãï¼Ÿï¼ˆå†è©¦è¡Œãƒœã‚¿ãƒ³ã€å¾…ã¡æ™‚é–“ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«å°ç·šï¼‰ã€ğŸ§¯âœ¨

---

# ã¾ã¨ã‚ğŸ§¯âœ¨

* ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ã¯ã€Œå£Šã‚Œã¦ã‚‹ç›¸æ‰‹ã«çªæ’ƒã—ç¶šã‘ãªã„ã€ãŸã‚ã®å®‰å…¨è£…ç½®ğŸš§
* **Openã«ãªã£ãŸã‚‰Fail Fast**ã§ã€è‡ªåˆ†ã®ã‚µãƒ¼ãƒ“ã‚¹ã®å¯ç”¨æ€§ã‚’å®ˆã‚Œã‚‹ğŸ›¡ï¸
* é–¾å€¤ã¯ **å¤±æ•—ç‡ãƒ»æœ€ä½å›æ•°ãƒ»è¦³æ¸¬æ™‚é–“ãƒ»é®æ–­æ™‚é–“** ã®4ç‚¹ã‚»ãƒƒãƒˆã§æ±ºã‚ã‚‹ğŸ“‰
* `HttpClient` ã«ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã‚’ä»˜ã‘ã‚‹ãªã‚‰ã€`AddResilienceHandler` ã§ `HttpCircuitBreakerStrategyOptions` ã‚’è¨­å®šã§ãã‚‹ã‚ˆã€‚([Microsoft Learn][2])

[1]: https://learn.microsoft.com/en-us/azure/architecture/patterns/circuit-breaker "Circuit Breaker Pattern - Azure Architecture Center | Microsoft Learn"
[2]: https://learn.microsoft.com/en-us/dotnet/core/resilience/http-resilience "Build resilient HTTP apps: Key development patterns - .NET | Microsoft Learn"
[3]: https://www.pollydocs.org/strategies/circuit-breaker.html "Circuit breaker resilience strategy | Polly "
