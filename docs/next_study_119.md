# ç¬¬119ç« ï¼šMiddlewareã£ã¦ãªã«ï¼Ÿï¼ˆãƒ«ãƒ¼ãƒˆã«å…¥ã‚‹å‰ã®é–€ç•ªï¼‰ğŸ§¤

ä»Šæ—¥ã¯ **Next.jsã®Middlewareï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰** ã‚’ã€ã€Œãªã«ã‚‚ã®ï¼Ÿã€ã£ã¦ã¨ã“ã‚ã‹ã‚‰ã€**å‹•ãæœ€å°ä¾‹**ã¾ã§ã‚„ã£ã¦ã¿ã‚‹ã‚ˆã€œï¼ğŸ˜ŠğŸ’–
çµè«–ã‹ã‚‰è¨€ã†ã¨ã€Middlewareã¯ **ãƒšãƒ¼ã‚¸ã‚„APIã«å…¥ã‚‹â€œç›´å‰â€ã«å‹•ãã€ã¡ã„ã•ãªé–€ç•ª** ã§ã™ğŸ§¤ğŸš¦

---

## 1) Middlewareã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆè¶…ã–ã£ãã‚Šï¼‰ğŸ§ âœ¨

![next_study_119_gatekeeper](./picture/next_study_119_gatekeeper.png)


* ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã‚‹ğŸ“¨
* **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã‚‹å‰**ã«MiddlewareãŒãƒã‚§ãƒƒã‚¯ã™ã‚‹ğŸ§¤
* OKãªã‚‰ãƒšãƒ¼ã‚¸ã¸ã€ãƒ€ãƒ¡ãªã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚„æ›¸ãæ›ãˆãŒã§ãã‚‹ğŸš¦â¡ï¸

ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ãªã‚‰ `/login` ã«é£›ã°ã™ã€ã¿ãŸã„ãªã®ãŒå¾—æ„ã§ã™ğŸ”ğŸ’¨

---

## 2) ã©ã“ã§å‹•ãã®ï¼Ÿã„ã¤å‹•ãã®ï¼Ÿâ±ï¸ğŸ‘€

![next_study_119_middleware_location](./picture/next_study_119_middleware_location.png)


Middlewareã¯ **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹**ã« `middleware.ts`ï¼ˆã¾ãŸã¯ `middleware.js`ï¼‰ã‚’ç½®ãã¨å‹•ãã¾ã™ğŸ“âœ¨
`app/` ã®ä¸­ã˜ã‚ƒãªãã¦ã€`app/` ã¨åŒã˜éšå±¤ã«ç½®ãã®ãŒãƒã‚¤ãƒ³ãƒˆã ã‚ˆã€œï¼âœ…

---

## 3) å›³ã§è¦‹ã‚‹ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€šã‚Šé“ğŸ—ºï¸ğŸ§¤

![ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€šã‚Šé“](./picture/next_study_119_middleware_intro.png)

```mermaid
flowchart LR
  A["Browser / Client ğŸ§‘â€ğŸ’»"] --> B["Next.js ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ğŸ“¨"]
  B --> C["Middleware ğŸ§¤ ãƒ«ãƒ¼ãƒˆå‰ãƒã‚§ãƒƒã‚¯"]
  C -->|"OK"| D["Route / Page / APIã¸ ğŸšª"]
  C -->|"æ­¢ã‚ã‚‹"| E["redirect / rewrite / response ğŸš¦"]
  D --> F["Response ã‚’è¿”ã™ ğŸ“¦"]
  E --> F
  F --> A
```

---

## 4) ä½•ãŒã§ãã‚‹ã®ï¼Ÿï¼ˆã§ãã‚‹ã“ã¨ãƒªã‚¹ãƒˆï¼‰ğŸ§°âœ¨

Middlewareã§ã‚ˆãã‚„ã‚‹ã“ã¨ã¯ã“ã‚“ãªæ„Ÿã˜ğŸ‘‡ğŸ˜Š

* **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**ï¼šåˆ¥ãƒšãƒ¼ã‚¸ã¸é£›ã°ã™ğŸš¦â¡ï¸
* **ãƒªãƒ©ã‚¤ãƒˆ**ï¼šURLã¯ãã®ã¾ã¾ä¸­èº«ã ã‘åˆ¥ãƒ«ãƒ¼ãƒˆã«ã™ã‚‹ğŸª„
* **ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸**ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹/ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ğŸ§¾
* **Cookieã‚’è¦‹ã‚‹**ï¼šãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®šã®ææ–™ã«ã™ã‚‹ğŸª
* **ãƒ‘ã‚¹åˆ¤å®š**ï¼š`/admin` ã ã‘å®ˆã‚‹ã€ã¿ãŸã„ãªæ¡ä»¶åˆ†å²ğŸ›¡ï¸

---

## 5) ã¾ãšå‹•ã‹ã—ã¦ã¿ã‚ˆã†ï¼šæœ€å°ã®MiddlewareğŸ§ªâœ¨

### âœ… 5-1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ï¼‰ğŸ“

`middleware.ts` ã‚’ä½œã£ã¦ã€ã“ã†æ›¸ã„ã¦ã­ğŸ‘‡ï¼ˆãƒ­ã‚°å‡ºã™ã ã‘ã®è¶…ãƒŸãƒ‹ç‰ˆï¼‰

```ts
import { NextResponse, type NextRequest } from "next/server";

export function middleware(request: NextRequest) {
  console.log("ğŸ§¤ middleware:", request.nextUrl.pathname);
  return NextResponse.next(); // ã“ã®ã¾ã¾é€šã—ã¦OKğŸ‘Œ
}
```

### âœ… 5-2. èµ·å‹•ã—ã¦ç¢ºèªï¼ˆWindows / PowerShellã§ã‚‚OKï¼‰ğŸ–¥ï¸ğŸ’¨

![next_study_119_console_log](./picture/next_study_119_console_log.png)


```bash
npm run dev
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000/` ã‚’é–‹ã„ã¦ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«

* `ğŸ§¤ middleware: /`

ã¿ãŸã„ãªãƒ­ã‚°ãŒå‡ºãŸã‚‰æˆåŠŸã€œï¼ğŸ‰âœ¨

---

## 6) â€œé–€ç•ªã£ã½ã„â€ä¾‹ï¼š/secret ã«å…¥ã‚ã†ã¨ã—ãŸã‚‰ /login ã¸ğŸš¦ğŸ”

![next_study_119_secret_redirect](./picture/next_study_119_secret_redirect.png)


ã€Œé–€ç•ªæ„Ÿã€ã‚’å‡ºã™ãŸã‚ã«ã€**/secret ã¯å¼·åˆ¶ã§ /login ã«é£›ã°ã™**ä¾‹ã‚’ã‚„ã£ã¦ã¿ã‚ˆã€œï¼ğŸ§¤ğŸ’¨

### âœ… 6-1. ãƒšãƒ¼ã‚¸ã‚’2ã¤ä½œã‚‹ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ğŸ“„âœ¨

`app/login/page.tsx`

```tsx
export default function LoginPage() {
  return (
    <main style={{ padding: 24 }}>
      <h1>ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆä»®ï¼‰ğŸ”</h1>
      <p>ã“ã“ã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãŒå…¥ã‚‹æƒ³å®šã ã‚ˆã€œğŸ˜Š</p>
    </main>
  );
}
```

`app/secret/page.tsx`

```tsx
export default function SecretPage() {
  return (
    <main style={{ padding: 24 }}>
      <h1>ã²ã¿ã¤ãƒšãƒ¼ã‚¸ãŠ™ï¸</h1>
      <p>æœ¬å½“ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸäººã ã‘ãŒè¦‹ã‚Œã‚‹ã‚„ã¤ï¼âœ¨</p>
    </main>
  );
}
```

### âœ… 6-2. middleware.ts ã‚’â€œé–€ç•ªâ€ã«é€²åŒ–ã•ã›ã‚‹ğŸ§¤ğŸš¦

```ts
import { NextResponse, type NextRequest } from "next/server";

export function middleware(request: NextRequest) {
  const pathname = request.nextUrl.pathname;

  console.log("ğŸ§¤ middleware:", pathname);

  // ä¾‹ï¼š/secret ã«æ¥ãŸã‚‰ /login ã«é£›ã°ã™
  if (pathname.startsWith("/secret")) {
    const url = request.nextUrl.clone();
    url.pathname = "/login";
    url.searchParams.set("from", pathname); // ã©ã“ã‹ã‚‰æ¥ãŸã‹ãƒ¡ãƒ¢ğŸ“
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
}
```

### âœ… 6-3. å‹•ä½œãƒã‚§ãƒƒã‚¯ğŸ¯âœ¨

* `http://localhost:3000/secret` ã«è¡Œã
* è‡ªå‹•ã§ `http://localhost:3000/login?from=%2Fsecret` ã«é£›ã¹ãŸã‚‰æˆåŠŸğŸ‰ğŸ’–

---

## 7) Middlewareã®æ³¨æ„ç‚¹ï¼ˆç¬¬119ç« ã§æœ€ä½é™ã“ã“ã ã‘ï¼‰âš ï¸ğŸ§¤

Middlewareã¯ä¾¿åˆ©ã ã‘ã©ã€**â€œè–„ãâ€ä½œã‚‹**ã®ãŒã‚³ãƒ„ã ã‚ˆã€œğŸª¶âœ¨

* é‡ã„å‡¦ç†ï¼ˆã‚´ãƒªã‚´ãƒªè¨ˆç®—ãƒ»å·¨å¤§ãªDBå‡¦ç†ï¼‰ã¯ç½®ã‹ãªã„ğŸ™…â€â™€ï¸ğŸ’¦
* **åŸºæœ¬ã¯åˆ¤å®šã—ã¦ã€é€šã™ or é£›ã°ã™**ãã‚‰ã„ãŒæ°—æŒã¡ã„ã„ğŸ˜Š
* ã¾ãšã¯ã€Œãƒ«ãƒ¼ãƒˆå‰ã«1å›ã ã‘æŒŸã‚ã‚‹å ´æ‰€ãŒã‚ã‚‹ã€ã£ã¦æ„Ÿè¦šã‚’æ´ã‚ã°OKğŸ«¶

---

## 8) ã¾ã¨ã‚ï¼ˆä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ï¼‰ğŸ€âœ…

* Middlewareã¯ **ãƒ«ãƒ¼ãƒˆã«å…¥ã‚‹å‰ã®é–€ç•ª**ğŸ§¤ğŸšª
* `middleware.ts` ã‚’ **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹**ã«ç½®ãã¨å‹•ãğŸ“
* `NextResponse.next()` ã§é€šã™ / `redirect()` ã§é£›ã°ã™ğŸš¦âœ¨
* ã¾ãšã¯è–„ãä½¿ã†ã®ãŒæ­£è§£ğŸª¶ğŸ˜Š

ä»¥ä¸Šï¼ã“ã‚ŒãŒ **ç¬¬119ç« ** ã ã‚ˆã€œğŸ‰ğŸ’–
