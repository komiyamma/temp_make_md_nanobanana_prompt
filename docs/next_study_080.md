# ç¬¬80ç« ï¼š`next: { revalidate }` ã®é›°å›²æ°—ã‚’æ´ã‚€ğŸ§©

ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯ã“ã‚Œã ã‘ï¼âœ¨
**ã€Œã“ã®ãƒ‡ãƒ¼ã‚¿ã€ãšã£ã¨æœ€æ–°ã˜ã‚ƒãªãã¦ã„ã„ã‹ã‚‚â€¦ã€**ã£ã¦æ™‚ã«ã€**ä½•ç§’ã”ã¨ã«æ›´æ–°ã™ã‚‹ã‹**ã‚’ã€Œfetch 1å›ã”ã¨ã€ã«æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã ã‚ˆã€œğŸ˜ŠğŸµ
ï¼ˆã“ã‚Œã€**ã»ã©ã‚ˆãé€Ÿã**ã§ãã¦ã‚ã£ã¡ã‚ƒä¾¿åˆ©ï¼ï¼‰

---

## 1) ã¾ãšçµè«–ï¼šnext: \{ revalidate \} ã¯ä½•ï¼ŸğŸ§ âœ¨

![next_study_080_syntax_visual.png](./picture/next_study_080_syntax_visual.png)

Server å´ã® fetch ã«ã“ã†æ›¸ãã‚„ã¤ğŸ‘‡

```ts
fetch("https://...", { next: { revalidate: 60 } })
```

æ„å‘³ã¯è¶…ã–ã£ãã‚Šã“ã†ï¼ğŸ‘‡

* **æœ€å¤§ 60 ç§’é–“**ã¯ã€å‰ã«å–ã£ã¦ããŸçµæœï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã‚’ä½¿ã†ğŸ§Š
* **60 ç§’ã‚’éããŸã‚ã¨**ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã€ã¾ãšã¯å¤ã„çµæœã‚’ãƒ‘ãƒƒã¨è¿”ã—ã¦ï¼ˆé€Ÿã„ï¼‰ğŸš€
  è£ã§ã“ã£ãã‚Šå–ã‚Šç›´ã—ã¦æ›´æ–°ã™ã‚‹ï¼ˆæ¬¡ã®äººã‹ã‚‰æ–°ã—ã„ã®ãŒå‡ºã‚‹ï¼‰ğŸ”âœ¨
  â€»ã„ã‚ã‚†ã‚‹ ISR çš„ãªã€Œå¤ã„ã®è¿”ã—ã¤ã¤è£ã§æ›´æ–°ã€æŒ™å‹•ã ã‚ˆã€œ ([Next.js][1])

ã€Œrevalidateã€è‡ªä½“ã¯ **ç§’æ•°**ã§ã€Next.js ã® fetch æ‹¡å¼µã§ **false / 0 / æ•°å­—**ãŒæŒ‡å®šã§ãã‚‹ã‚ˆğŸ‘‡ ([Next.js][2])

* **false**ï¼šãšã£ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã»ã¼ç„¡æœŸé™ï¼‰ğŸ§Š
* **0**ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ï¼ˆæ¯å›å–ã‚Šã«ã„ãï¼‰ğŸ”¥
* **æ•°å­—**ï¼šãã®ç§’æ•°ã‚’ä¸Šé™ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥â±ï¸

---

## 2) å›³ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ã€Œ1å›ç›®ã¯å–ã‚Šã«è¡Œã â†’ æœŸé™å†…ã¯å†åˆ©ç”¨ â†’ æœŸé™åˆ‡ã‚Œã¯è£ã§æ›´æ–°ã€ğŸ§ŠğŸ”

```mermaid
sequenceDiagram
  participant B as ãƒ–ãƒ©ã‚¦ã‚¶
  participant N as Next.js
  participant C as Data Cache
  participant API as å¤–éƒ¨API

  B->>N: ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼ˆæœ€åˆï¼‰
  N->>API: fetchï¼ˆrevalidate=10ï¼‰
  API-->>N: ãƒ‡ãƒ¼ã‚¿
  N->>C: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆ10ç§’ï¼‰
  N-->>B: è¡¨ç¤ºï¼ˆæ–°é®®âœ¨ï¼‰

  B->>N: 10ç§’ä»¥å†…ã«æ›´æ–°
  N->>C: ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‚ç…§
  C-->>N: æ–°é®®ğŸ§Š
  N-->>B: ã™ãè¡¨ç¤ºğŸš€

  B->>N: 10ç§’ã‚’éãã¦æ›´æ–°
  N->>C: ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‚ç…§
  C-->>N: æœŸé™åˆ‡ã‚Œï¼ˆå¤ã„ï¼‰
  N-->>B: å¤ã„ã®ã‚’å…ˆã«è¿”ã™ï¼ˆé€Ÿã„âš¡ï¼‰
  N->>API: è£ã§å†å–å¾—ğŸ”
  API-->>N: æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿âœ¨
  N->>C: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°âœ…
```

![Next Revalidate Flow](./picture/next_study_080_next_revalidate.png)

---

## 3) ãƒãƒ³ã‚ºã‚ªãƒ³ï¼š10ç§’ã”ã¨ã«ã€Œæ™‚åˆ»APIã€ã‚’æ›´æ–°ã—ã¦ã¿ã‚ˆã†ğŸ•°ï¸ğŸŒ¸

### æ‰‹é †Aï¼šãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹ğŸ“„âœ¨

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­ã§ã€æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ã­ğŸ‘‡

* `app/revalidate-demo/page.tsx`

ä¸­èº«ã‚’ã“ã‚Œã«ã™ã‚‹ã‚ˆã€œğŸ˜Šï¼ˆã‚³ãƒ”ãƒšOKï¼ï¼‰

```tsx
type WorldTimeApiResponse = {
  datetime: string; // ä¾‹: "2025-12-25T12:34:56.789+09:00"
  timezone: string; // ä¾‹: "Asia/Tokyo"
};

async function getTokyoTime(): Promise<WorldTimeApiResponse> {
  const res = await fetch("https://worldtimeapi.org/api/timezone/Asia/Tokyo", {
    next: { revalidate: 10 }, // â˜…ã“ã“ãŒç¬¬80ç« ãƒã‚¤ãƒ³ãƒˆï¼
  });

  if (!res.ok) {
    throw new Error("æ™‚åˆ»APIã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸğŸ¥²");
  }

  return res.json();
}

export default async function Page() {
  const data = await getTokyoTime();

  return (
    <main style={{ padding: 24, fontFamily: "system-ui" }}>
      <h1 style={{ fontSize: 24, marginBottom: 12 }}>
        revalidate-demo â±ï¸ğŸ§Š
      </h1>

      <p style={{ marginBottom: 8 }}>
        ã“ã‚Œã¯ <b>next: {"{ revalidate: 10 }"}</b> ã‚’ä½¿ã£ãŸãƒ‡ãƒ¢ã ã‚ˆğŸ˜Šâœ¨
      </p>

      <ul style={{ lineHeight: 1.8 }}>
        <li>timezoneï¼š{data.timezone} ğŸŒ</li>
        <li>
          APIã®datetimeï¼š<b>{data.datetime}</b> ğŸ•°ï¸
        </li>
      </ul>

      <p style={{ marginTop: 16, opacity: 0.8 }}>
        ã‚³ãƒ„ï¼š10ç§’ä»¥å†…ã«æ›´æ–°ã™ã‚‹ã¨åŒã˜å€¤ã«ãªã‚Šã‚„ã™ã„ã‚ˆğŸ§Š / 10ç§’è¶…ãˆãŸã‚‰æŒ™å‹•ã‚’è¦³å¯Ÿã—ã¦ã­ğŸ”âœ¨
      </p>
    </main>
  );
}
```

### æ‰‹é †Bï¼šæœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§ç¢ºèªã™ã‚‹ï¼ˆãŠã™ã™ã‚ï¼‰âœ…ğŸš€

é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¦‹ãˆæ–¹ãŒãƒ–ãƒ¬ã‚‹ã“ã¨ãŒã‚ã‚‹ã‹ã‚‰ã€**æŒ™å‹•ã‚’è¦‹ãŸã„æ—¥ã¯æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰**ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã€œğŸ˜Šâœ¨ ([Next.js][2])

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ğŸ‘‡

```bash
npm run build
npm start
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ğŸ‘‡

* `http://localhost:3000/revalidate-demo`

---

## 4) è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆï¼ˆã“ã“ãŒæ¥½ã—ã„ï¼‰ğŸ‘€âœ¨



![next_study_080_swr_flow.png](./picture/next_study_080_swr_flow.png)


1. ãƒšãƒ¼ã‚¸ã‚’é–‹ãï¼ˆ1å›ç›®ï¼‰
2. **10ç§’ä»¥å†…**ã«ãƒªãƒ­ãƒ¼ãƒ‰ â†’ **åŒã˜ datetime** ãŒå‡ºã‚„ã™ã„ğŸ§Š
3. **10ç§’ã‚’éãã¦**ãƒªãƒ­ãƒ¼ãƒ‰ â†’

   * 1å›ç›®ã¯å¤ã„ã®ãŒå‡ºã‚‹ã“ã¨ãŒã‚ã‚‹ï¼ˆé€Ÿã„ã‹ã‚‰ï¼‰âš¡
   * ã‚‚ã†1å›ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ–°ã—ã„ã®ãŒå‡ºã‚‹ã“ã¨ãŒã‚ã‚‹ğŸ”âœ¨
     â€»ã“ã‚ŒãŒã€Œå¤ã„ã®è¿”ã—ã¤ã¤è£ã§æ›´æ–°ã€ã£ã½ã„æŒ™å‹•ã ã‚ˆã€œ ([Next.js][1])

---

## 5) ã‚ˆãã‚ã‚‹ãƒãƒã‚Šï¼ˆå›é¿ã—ã‚ˆã£ï¼‰ğŸª¤ğŸ¥²

### ãƒãƒã‚Šâ‘ ï¼šDevTools ã®ã€Œãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰ã€ã§åŠ¹ã‹ãªã„ğŸ˜µ



![next_study_080_hard_reload.png](./picture/next_study_080_hard_reload.png)


é–‹ç™ºä¸­ã®ãƒãƒ¼ãƒ‰ãƒªãƒ­ãƒ¼ãƒ‰ç­‰ã§ `cache-control: no-cache` ãŒä»˜ãã¨ã€**cache / revalidate / tags ãŒç„¡è¦–**ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆã€œ ([Next.js][2])
ğŸ‘‰ ã¾ãšã¯æ™®é€šã®ãƒªãƒ­ãƒ¼ãƒ‰ã§è©¦ã™ã®ãŒãŠã™ã™ã‚ğŸ˜Š

### ãƒãƒã‚Šâ‘¡ï¼šåŒã˜URLã‚’é•ã†ç§’æ•°ã§ revalidate ã—ã¦æ··ä¹±ğŸ¤¯

åŒã˜URLã‚’åŒã˜ç”»é¢å†…ã§è¤‡æ•°å› fetch ã—ã¦ã€revalidate ãŒé•ã†ã¨ **å°ã•ã„ç§’æ•°ãŒå„ªå…ˆ**ã•ã‚ŒãŸã‚Šã™ã‚‹ã‚ˆã€œ ([Next.js][2])
ğŸ‘‰ è¿·ã£ãŸã‚‰ã€Œãã®URLã¯ã“ã®ç§’æ•°ã€ã£ã¦æƒãˆã‚‹ã®ãŒå®‰å…¨âœ¨

### ãƒãƒã‚Šâ‘¢ï¼šcache: "no-store" ã¨ä¸€ç·’ã«æ›¸ã„ã¡ã‚ƒã£ãŸğŸ˜‡



![next_study_080_conflict_warning.png](./picture/next_study_080_conflict_warning.png)


`revalidate` ã¨ `no-store` ã¯ã‚±ãƒ³ã‚«ã—ãŒã¡ã§ã€çŸ›ç›¾ã™ã‚‹ã¨ç„¡è¦–ã•ã‚Œã‚‹ï¼ˆé–‹ç™ºã ã¨è­¦å‘Šï¼‰ã“ã¨ãŒã‚ã‚‹ã‚ˆã€œ ([Next.js][2])
ğŸ‘‰ â€œæ¯å›æœ€æ–°â€ã«ã—ãŸã„ãªã‚‰ **revalidate: 0** ã‹ **no-store** ã®ã©ã£ã¡ã‹ã«å¯„ã›ã‚‹ã®ãŒâ—

---

## 6) ã¾ã¨ã‚ï¼ˆç¬¬80ç« ã®åˆè¨€è‘‰ï¼‰ğŸ€âœ¨



![next_study_080_summary_badge.png](./picture/next_study_080_summary_badge.png)


* **next: \{ revalidate: ç§’ \}** ã¯ã€Œã“ã® fetch ã®æ›´æ–°é »åº¦ã€ã‚’æ±ºã‚ã‚‹â±ï¸
* **é€Ÿã•**ã¨**æ–°ã—ã•**ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹ä»•çµ„ã¿ğŸ§Šâš¡
* æœŸé™åˆ‡ã‚Œå¾Œã¯ **å¤ã„ã®ã‚’è¿”ã—ã¦è£ã§æ›´æ–°**ã€ãŒèµ·ãã‚„ã™ã„ï¼ˆISRã£ã½ã„ï¼‰ğŸ” ([Next.js][1])

---

## ãŠã¾ã‘ãƒŸãƒ‹ç¢ºèªã‚¯ã‚¤ã‚ºğŸ“ğŸ’¡

1. `revalidate: 0` ã¯ã©ã‚“ãªæ„å‘³ï¼ŸğŸ”¥
2. åŒã˜URLã‚’ `revalidate: 60` ã¨ `revalidate: 10` ã§æ··ãœãŸã‚‰ã€ã©ã£ã¡ãŒåŠ¹ãã‚„ã™ã„ï¼ŸğŸ§ 
3. 10ç§’ã‚’éããŸç›´å¾Œã®æœ€åˆã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã€Œå¤ã„å€¤ã€ãŒå‡ºã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã¯ãªãœï¼ŸğŸ”

ï¼ˆç­”ãˆåˆã‚ã›ã—ãŸã‘ã‚Œã°ã€é€ã£ã¦ãã‚ŒãŸã‚‰ä¸€ç·’ã«ã‚„ã‚‹ã‚ˆã€œğŸ˜ŠğŸŒ¸ï¼‰

[1]: https://nextjs.org/docs/app/guides/incremental-static-regeneration?utm_source=chatgpt.com "How to implement Incremental Static Regeneration (ISR)"
[2]: https://nextjs.org/docs/app/api-reference/functions/fetch "Functions: fetch | Next.js"
