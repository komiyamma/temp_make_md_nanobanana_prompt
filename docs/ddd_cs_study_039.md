# ç¬¬39ç« ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç½®ãå ´æ‰€ ğŸ˜µâ€ğŸ’«â¡ï¸ğŸ˜Œâœ¨

![ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç½®ãå ´æ‰€](./picture/ddd_cs_study_039_validation.png)

**ä¸æ­£ãªå€¤ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ã“ã®ä¸–ã«èª•ç”Ÿã•ã›ãªã„**ğŸ’ªğŸ‘¶ğŸš«

---

## ã­ã‚‰ã„ ğŸ¯

ã“ã®ç« ã‚’èª­ã¿çµ‚ãˆã‚‹ã¨â€¦

* ã€Œã©ã“ã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã®ãŒæ­£è§£ï¼Ÿã€ãŒè¿·ã‚ãªããªã‚‹ğŸ˜Œâœ¨
* **â€œä¸æ­£ãªçŠ¶æ…‹ã®ã¾ã¾ç”Ÿãã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆâ€**ã‚’ä½œã‚‰ãªããªã‚‹ğŸ§Ÿâ€â™‚ï¸ğŸš«
* AIï¼ˆCopilotç­‰ï¼‰ã«ãŠé¡˜ã„ã™ã‚‹ã¨ãã‚‚ã€æŒ‡ç¤ºãŒãƒ–ãƒ¬ãªããªã‚‹ğŸ¤–ğŸ§ âœ¨

---

## ã¾ãšçµè«–ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Œå¢ƒç•Œã€ã¨ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã«ç½®ã ğŸ§±ğŸšªğŸ’

![two_validation_layers](./picture/ddd_cs_study_039_two_validation_layers.png)

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ¤œè¨¼ï¼‰ã£ã¦ã€å®Ÿã¯ç¨®é¡ãŒæ··ã–ã‚Šã‚„ã™ã„ã‚“ã§ã™ğŸ˜µâ€ğŸ’«
ã ã‹ã‚‰ã€ç½®ãå ´æ‰€ã‚’ **2ã¤ã«åˆ†ã‘ã¦è€ƒãˆã‚‹** ã®ãŒã‚³ãƒ„ã§ã™ğŸ‘‡

### â‘  å¢ƒç•Œï¼ˆå…¥åŠ›ã®å…¥ã‚Šå£ï¼‰ã§ã‚„ã‚‹ã‚‚ã® ğŸšªğŸ“

* æ–‡å­—æ•°ã€å¿…é ˆã€å½¢å¼ï¼ˆãƒ¡ãƒ¼ãƒ«ã£ã½ã„ï¼Ÿï¼‰
* â€œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨ã—ã¦ä¸è‡ªç„¶â€ ãªã‚‚ã®ã‚’å¼¾ã
  ä¾‹ï¼šç©ºæ¬„ã€é•·ã™ãã€æ•°å­—ã ã‘ã€ãªã©

ğŸ‘‰ ã“ã“ã¯ **UI / API / Applicationå±¤** å´ã§OKğŸ‘Œâœ¨
ï¼ˆDTOã®æ¤œè¨¼ã€FluentValidationã€DataAnnotations ãªã©ï¼‰

### â‘¡ ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆãƒ«ãƒ¼ãƒ«ã®ä¸­æ ¸ï¼‰ã§ã‚„ã‚‹ã‚‚ã® ğŸ’ğŸ“œ

* ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆä»•æ§˜ï¼‰ã¨ã—ã¦çµ¶å¯¾ã«å®ˆã‚ŠãŸã„ã“ã¨
* ç ´ã£ãŸã‚‰ã‚·ã‚¹ãƒ†ãƒ ãŒå£Šã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã®ã€Œä¸å¤‰æ¡ä»¶ï¼ˆinvariantï¼‰ã€

ğŸ‘‰ ã“ã“ã¯ **Domainå±¤ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ / Factory / ãƒ¡ã‚½ãƒƒãƒ‰å†…** ã«ç½®ãã¾ã™ğŸ”¥

```mermaid
flowchart TD
    Input["User Input ğŸ—£ï¸"] --> Boundary["â‘  Boundary Check ğŸšª<br/>(Format, Required)"]
    Boundary -- OK --> Domain["â‘¡ Domain Check ğŸ’<br/>(Invariant, Rules)"]
    Domain -- OK --> Object["Valid Object âœ…"]
    
    Boundary -- Fail --> Error1["UI Error ğŸ“"]
    Domain -- Fail --> Error2["System Error / Exception ğŸ§¨"]
```

---

## é‡è¦ãƒ•ãƒ¬ãƒ¼ã‚ºï¼š**ã€Œä¸æ­£ãªçŠ¶æ…‹ã‚’ä½œã‚Œãªã„ã€è¨­è¨ˆ** ğŸ›¡ï¸âœ¨

![born_valid](./picture/ddd_cs_study_039_born_valid.png)

DDDã®ãƒãƒªã ã¨ã“ã†ã§ã™ğŸ‘‡

* âŒ ä½œã£ã¦ã‹ã‚‰ `Validate()` ã—ã¦ã€Œã‚¨ãƒ©ãƒ¼ã§ã—ãŸã€
* âœ… **ä½œã‚‹æ™‚ç‚¹ã§å¼¾ã„ã¦ã€ãã‚‚ãã‚‚ç”Ÿã¾ã‚Œãªã„** ğŸ‘¶ğŸš«

ã“ã‚ŒãŒã§ãã‚‹ã¨ã€ã‚³ãƒ¼ãƒ‰ãŒä¸€æ°—ã«å®‰å¿ƒã«ãªã‚Šã¾ã™ğŸ˜ŒğŸŒ¸
ã€Œã©ã“ã‹ã§ãƒã‚§ãƒƒã‚¯ã—ãŸã¯ãšâ€¦ã€ãŒæ¶ˆãˆã¾ã™ğŸ«¥ğŸ§¨

---

## ã‚ã‚ŠãŒã¡ãªäº‹æ•…ãƒ‘ã‚¿ãƒ¼ãƒ³ ğŸ˜±ğŸ’¥

### ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼šDTOã§ãƒã‚§ãƒƒã‚¯ã—ãŸã‹ã‚‰OKã ã¨æ€ã£ãŸ

![bypassing_check](./picture/ddd_cs_study_039_bypassing_check.png)

ã€ŒAPIã§å¼¾ã„ãŸã—ï¼ã€â†’ **åˆ¥ãƒ«ãƒ¼ãƒˆã‹ã‚‰å…¥ã£ã¦ç ´æ»…**ğŸ˜‡
ï¼ˆãƒãƒƒãƒå‡¦ç†ã€ç®¡ç†ç”»é¢ã€å°†æ¥ã®è¿½åŠ æ©Ÿèƒ½ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰â€¦ï¼‰

âœ… **ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚‚å®ˆã‚‹**ï¼šæœ€çµ‚é˜²è¡›ãƒ©ã‚¤ãƒ³ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ğŸ’ğŸ›¡ï¸

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼šEntityãŒã€Œå¾Œã‹ã‚‰è¨­å®šã€ã§ç„¡é™ã«å£Šã‚Œã‚‹

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ `set;` ãŒç”Ÿãã¦ã‚‹ã¨â€¦
ã„ã¤ã§ã‚‚ä¸æ­£ãªçŠ¶æ…‹ã«ã§ãã¾ã™ğŸ˜±ğŸ”“

âœ… **ä¸å¤‰ã«ã—ãŸã‚Šã€å¤‰æ›´ã¯ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±ã«ã™ã‚‹**âœ¨

---

## C#ã§ã®ç‹é“ï¼šValue Objectã¯ã€Œä½œã‚‹æ™‚ã«æ¤œè¨¼ã€ğŸ¥‡ğŸ“¦

![single_entry](./picture/ddd_cs_study_039_single_entry.png)

ä¾‹ï¼šEmailï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ğŸ“§
**ä¸æ­£ãªEmailã¯ç”Ÿæˆã§ããªã„**ã‚ˆã†ã«ã—ã¾ã™ğŸ”¥

#### âœ… Resultãƒ‘ã‚¿ãƒ¼ãƒ³ç‰ˆï¼ˆä¾‹å¤–ã‚’æŠ•ã’ãªã„æ´¾ï¼‰ğŸ™‚

```csharp
using System.Text.RegularExpressions;

public readonly record struct Email
{
    private static readonly Regex EmailRegex =
        new(@"^[^@\s]+@[^@\s]+\.[^@\s]+$", RegexOptions.Compiled);

    public string Value { get; }

    private Email(string value) => Value = value;

    public static Result<Email> Create(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Result.Fail<Email>("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™ğŸ“§");

        value = value.Trim();

        if (value.Length > 254)
            return Result.Fail<Email>("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé•·ã™ãã¾ã™ğŸ˜µ");

        if (!EmailRegex.IsMatch(value))
            return Result.Fail<Email>("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒä¸æ­£ã§ã™ğŸ™…â€â™€ï¸");

        return Result.Ok(new Email(value));
    }

    public override string ToString() => Value;
}

public sealed record Result(bool IsSuccess, string? Error)
{
    public static Result Ok() => new(true, null);
    public static Result Fail(string error) => new(false, error);
}

public sealed record Result<T>(bool IsSuccess, T? Value, string? Error)
{
    public static Result<T> Ok(T value) => new(true, value, null);
    public static Result<T> Fail(string error) => new(false, default, error);
}
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã“ğŸ‘‡ğŸ˜

* `private` ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ **å‹æ‰‹ã«newã§ããªã„**ğŸ”’
* `Create()` ãŒå”¯ä¸€ã®å…¥å£ğŸšª
* å¤±æ•—æ™‚ã¯ `Result.Fail`ï¼ˆUIã«ãã®ã¾ã¾å‡ºã›ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚OKï¼‰ğŸ“âœ¨

---

## Entity/é›†ç´„ã§ã¯ã€Œä¸å¤‰æ¡ä»¶ã€ã‚’å®ˆã‚‹ ğŸ§‘â€âš–ï¸ğŸ”¥

![guarding_state](./picture/ddd_cs_study_039_guarding_state.png)

ãŸã¨ãˆã°ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ç©ºã«ã§ããªã„ã€ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã¯ã€
**Entityã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å®ˆã‚‹**ã®ãŒå®šç•ªã§ã™ğŸ™‚

```csharp
public sealed class User
{
    public Guid Id { get; }
    public string Name { get; private set; }
    public Email Email { get; private set; }

    private User(Guid id, string name, Email email)
    {
        Id = id;
        Name = name;
        Email = email;
    }

    public static Result<User> Create(string? name, Email email)
    {
        if (string.IsNullOrWhiteSpace(name))
            return Result.Fail<User>("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¿…é ˆã§ã™ğŸ™‚");

        name = name.Trim();

        if (name.Length > 50)
            return Result.Fail<User>("ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒé•·ã™ãã¾ã™ğŸ˜µ");

        return Result.Ok(new User(Guid.NewGuid(), name, email));
    }

    public Result ChangeName(string? newName)
    {
        if (string.IsNullOrWhiteSpace(newName))
            return Result.Fail("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ç©ºã«ã§ãã¾ã›ã‚“ğŸ™…â€â™€ï¸");

        newName = newName.Trim();

        if (newName.Length > 50)
            return Result.Fail("ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒé•·ã™ãã¾ã™ğŸ˜µ");

        Name = newName;
        return Result.Ok();
    }
}
```

âœ… â€œã©ã®ãƒ«ãƒ¼ãƒˆã‹ã‚‰å‘¼ã°ã‚Œã¦ã‚‚å£Šã‚Œãªã„â€ ã®ãŒå¼·ã„ã§ã™ğŸ’ªâœ¨
UIã§å¼¾ã„ã¦ã¦ã‚‚ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæœ€å¾Œã«å®ˆã‚Šã¾ã™ğŸ›¡ï¸ğŸ’

---

## ã©ã“ã¾ã§ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã®è²¬å‹™ï¼Ÿè¿·ã£ãŸã‚‰ã“ã‚Œã§æ±ºã‚ã‚‹ ğŸ§­âœ¨

### âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç½®ãï¼ˆçµ¶å¯¾å®ˆã‚‹ï¼‰ğŸ’

* ãã‚ŒãŒç ´ã‚‰ã‚Œã‚‹ã¨ã€Œãã®æ¦‚å¿µãŒæˆç«‹ã—ãªã„ã€
  ä¾‹ï¼šMoneyãŒãƒã‚¤ãƒŠã‚¹ç¦æ­¢ã€äºˆç´„çµ‚äº†æ—¥ãŒé–‹å§‹æ—¥ã‚ˆã‚Šå‰ã¯ãƒ€ãƒ¡ã€ãªã©

### âœ… å¢ƒç•Œã«ç½®ãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®éƒ½åˆï¼‰ğŸšª

* â€œå…¥åŠ›ã¨ã—ã¦å¤‰â€ ã ã‘ã©ã€æ¦‚å¿µã¨ã—ã¦ã¯æˆç«‹ã™ã‚‹ã‹ã‚‚
  ä¾‹ï¼šä½æ‰€ã®å…¥åŠ›ãŒç©ºæ¬„ã€éƒµä¾¿ç•ªå·ã®ãƒã‚¤ãƒ•ãƒ³ã€ãªã©ï¼ˆä»•æ§˜æ¬¡ç¬¬ï¼‰

ğŸ“Œ ãŸã ã—â€¦
**å¢ƒç•Œã§ã‚„ã£ãŸæ¤œè¨¼ã‚’ç†ç”±ã«ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼ã‚’çœç•¥ã—ãªã„**ğŸ™…â€â™€ï¸ğŸ”¥
ï¼ˆäº‹æ•…ã‚‹ã®ã§â€¦ğŸ˜‡ğŸ’¥ï¼‰

---

## AIã«é ¼ã‚€ã¨ãã®ã€Œè‰¯ã„æŒ‡ç¤ºã€ãƒ†ãƒ³ãƒ—ãƒ¬ ğŸ¤–âœ¨

Copilotç­‰ã«æŠ•ã’ã‚‹ã¨ãã¯ã€ã“ã†è¨€ã†ã¨å®‰å®šã—ã¾ã™ğŸ‘‡

* ã€Œã“ã®å‹ã¯ **ä¸æ­£ãªå€¤ãŒç”Ÿæˆã§ããªã„** ã‚ˆã†ã«ã—ã¦ã€ğŸ›¡ï¸
* ã€Œã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ privateã€ç”Ÿæˆã¯ Create() ã®ã¿ã€ğŸ”’ğŸšª
* ã€Œå¤±æ•—ã¯ Result ã§è¿”ã—ã¦ã€ğŸ“¦
* ã€Œå®ˆã‚‹ã¹ãä¸å¤‰æ¡ä»¶ï¼ˆinvariantï¼‰ã¯ã€‡ã€‡ã€ğŸ“œ

ä¾‹ï¼š
ã€ŒEmailå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ã€‚ç©º/å½¢å¼/é•·ã•ã‚’Createã§æ¤œè¨¼ã€‚newã§ããªã„ã‚ˆã†ã«ã€‚Resultã§è¿”ã—ã¦ã€ğŸ“§ğŸ¤–âœ¨

---

## ãƒŸãƒ‹æ¼”ç¿’ âœï¸ğŸ§ªï¼ˆæ‰‹ã‚’å‹•ã‹ã™ã¨å®šç€ã—ã¾ã™ï¼ï¼‰

æ¬¡ã®ã©ã‚Œã‹1ã¤ã‚’ã€**â€œä¸æ­£ã«ç”Ÿæˆã§ããªã„â€**ã§ä½œã£ã¦ã¿ã¦ã­ğŸ˜Šâœ¨

1. `Money` ğŸ’°

* é‡‘é¡ã¯0ä»¥ä¸Š
* é€šè²¨ã‚³ãƒ¼ãƒ‰ã¯ `"JPY"` ãªã©3æ–‡å­—å›ºå®š

2. `UserName` ğŸ™‹â€â™€ï¸

* ç©ºç™½ç¦æ­¢
* 1ã€œ50æ–‡å­—

3. `DateRange` ğŸ“…

* End >= Start
* æœŸé–“æœ€å¤§ 365æ—¥ã¾ã§

ã§ããŸã‚‰æœ€å¾Œã«ğŸ‘‡ã‚‚è¿½åŠ ã™ã‚‹ã¨è¶…ã‚ˆã„ã§ã™ğŸŒŸ

* ã€Œå¤±æ•—ã‚±ãƒ¼ã‚¹ã€ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’2ã¤ä»¥ä¸ŠğŸ§ªâœ¨

---

## ã¾ã¨ã‚ ğŸ¥°ğŸ“Œ

* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Œå¢ƒç•Œã€ã¨ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã«åˆ†ã‘ã‚‹ğŸšªğŸ’
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ **ä¸æ­£ãªçŠ¶æ…‹ã‚’ä½œã‚Œãªã„** ã‚ˆã†ã«ã™ã‚‹ğŸ›¡ï¸âœ¨
* ç”Ÿæˆæ™‚ï¼ˆCreate/Factory/ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼‰ï¼†å¤‰æ›´æ™‚ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰ã§å®ˆã‚‹ğŸ”¥
* AIã«é ¼ã‚€ã¨ãã‚‚ã€Œä¸æ­£ãŒèª•ç”Ÿã—ãªã„ã€ã‚’åˆè¨€è‘‰ã«ã™ã‚‹ã¨å¼·ã„ğŸ¤–ğŸ’ª

---

æ¬¡ã®ç« ï¼ˆç¬¬40ç« ï¼‰ã¯ **Entity** ã«å…¥ã£ã¦ã„ãã‚ˆã€œï¼ğŸ§â€â™€ï¸ğŸ†”âœ¨
å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ä½•ãŒé•ã†ã‹ã€ã“ã“ã¾ã§ã®è©±ãŒåŠ¹ã„ã¦ãã¾ã™ğŸ˜†ğŸ‰
