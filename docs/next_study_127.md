# ç¬¬127ç« ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šç›´æ¥å©ã‹ã‚Œã‚‹å‰æã§å®ˆã‚‹ğŸ›¡ï¸

Webã‚¢ãƒ—ãƒªã£ã¦ã­ã€**ç”»é¢ï¼ˆUIï¼‰ã‹ã‚‰ã ã‘ä½¿ã‚ã‚Œã‚‹**â€¦ã¨æ€ã„ãŒã¡ã ã‘ã©ã€å®Ÿã¯é•ã†ã‚“ã ã‚ˆã€œğŸ˜³
**APIã‚„ãƒšãƒ¼ã‚¸ã¯ã€Œç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹å‰æã€**ã§ä½œã‚‹ã®ãŒè¶…å¤§äº‹ï¼ğŸ”âœ¨

---

## 1) ã€Œç›´æ¥å©ã‹ã‚Œã‚‹ã€ã£ã¦ã©ã†ã„ã†ã“ã¨ï¼Ÿ

![Thief jumping over a fence (UI)](./picture/next_study_127_direct_access_risk.png)
ğŸ•µï¸â€â™€ï¸ğŸ’»

ãŸã¨ãˆã° `/api/todos` ãŒã‚ã‚‹ã¨ã™ã‚‹ã‚ˆã­ï¼Ÿ
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç”»é¢ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä½¿ã†ã‹ã‚‚ã ã‘ã©â€¦å®Ÿéš›ã¯ **URLã‚’çŸ¥ã£ã¦ã‚Œã°èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹**ï¼ˆå¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰ã‚“ã ã‚ˆã€œğŸ˜±

* ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‹ã‚‰ç›´ã«ã‚¢ã‚¯ã‚»ã‚¹ğŸ§­
* åˆ¥ã®ã‚¢ãƒ—ãƒªã‚„ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ğŸ“¡ï¼ˆâ€»ã“ã“ã§ã¯ã‚„ã‚‰ãªã„ã‚ˆï¼ï¼‰
* ç”»é¢ã§éš ã—ã¦ã¦ã‚‚URLã¯æ¨æ¸¬ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ğŸ”

---

## 2) ã‚¤ãƒ¡ãƒ¼ã‚¸å›³ï¼šUIã®å¤–ã‹ã‚‰ã‚‚æ¥ã‚‹ğŸšªâš ï¸ï¼ˆå›³è§£ï¼‰

![ã‚¤ãƒ¡ãƒ¼ã‚¸å›³](./picture/next_study_127_direct_attack.png)

```mermaid
flowchart LR
  U[æ™®é€šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ğŸ˜Š] --> UI[ç”»é¢/UI]
  UI --> S[Next.jsã‚µãƒ¼ãƒãƒ¼ğŸ§ ]

  A[æ‚ªæ„ã®ã‚ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ğŸ˜ˆ] -->|UIã‚’é€šã‚‰ãš| S
  S --> API[Route Handler / Server Action]
  API --> DB[(DBğŸ—ƒï¸)]
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡
**UIã‚’é€šã‚‰ãªãã¦ã‚‚ã€ã‚µãƒ¼ãƒãƒ¼(API/DB)ã«æ¥ã‚‹ãƒ«ãƒ¼ãƒˆãŒã‚ã‚‹**ã£ã¦ã“ã¨ï¼ğŸš¨

---

## 3) å®ˆã‚Šæ–¹ã®åŸºæœ¬ï¼šã‚µãƒ¼ãƒãƒ¼å´ã§ã€Œå¿…ãšã€ãƒã‚§ãƒƒã‚¯âœ…ğŸ”’

### âœ… çµ¶å¯¾ã‚„ã‚‹ã“ã¨ 3ç‚¹ã‚»ãƒƒãƒˆ

![Three security shields](./picture/next_study_127_three_security_shields.png)


1. **èªè¨¼ï¼ˆAuthenticationï¼‰**ï¼šãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ï¼ŸğŸªª
2. **èªå¯ï¼ˆAuthorizationï¼‰**ï¼šãã®äººãŒãã‚Œã‚’æ“ä½œã—ã¦ã„ã„ï¼ŸğŸ‘‘
3. **å…¥åŠ›æ¤œè¨¼ï¼ˆValidationï¼‰**ï¼šå¤‰ãªå€¤ã˜ã‚ƒãªã„ï¼ŸğŸ§¼

UIã§ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™ã®ã¯ã€Œè¦ªåˆ‡ã€ã ã‘ã©ã€**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã˜ã‚ƒãªã„**ã‚ˆğŸ™…â€â™€ï¸ğŸ’¦
**æœ¬ä½“ã¯ã‚µãƒ¼ãƒãƒ¼ã§å®ˆã‚‹**ã®ãŒæ­£è§£ï¼ğŸ›¡ï¸

---

## 4) Next.jsã§ã€Œã©ã“ã‚’å®ˆã‚‹ï¼Ÿã€ãƒãƒƒãƒ—

![Castle map of security layers](./picture/next_study_127_security_map_castle.png)
ğŸ—ºï¸âœ¨

* **Middleware**ï¼šå…¥å£ã®é–€ç•ªğŸ§¤ï¼ˆã–ã£ãã‚Šæ­¢ã‚ã‚‹ã®ã«å¼·ã„ï¼‰
* **Server Component / page.tsx**ï¼šãƒšãƒ¼ã‚¸è¡¨ç¤ºã®æ™‚ã«ã‚¬ãƒ¼ãƒ‰ã§ãã‚‹ğŸ 
* **Route Handlerï¼ˆapp/api/...ï¼‰**ï¼šAPIã¯ã“ã“ãŒæœ€é‡è¦ğŸ”¥
* **Server Actions**ï¼šãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚‚ã€ã“ã“ã§å¿…ãšãƒã‚§ãƒƒã‚¯ğŸ”¥
* **DBã‚¢ã‚¯ã‚»ã‚¹**ï¼šæœ€çµ‚é˜²è¡›ç·šï¼ˆã€Œãã®ãƒ‡ãƒ¼ã‚¿ã¯ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚‚ã®ï¼Ÿã€ï¼‰ğŸ§±

---

## 5) å®Ÿè·µâ‘ ï¼šAPIã‚’ã€Œãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã€ã«ã™ã‚‹ğŸ”ğŸªï¼ˆRoute Handlerï¼‰

> ã“ã“ã§ã¯å­¦ç¿’ç”¨ã«ã€Œcookieã«ãƒ­ã‚°ã‚¤ãƒ³ã£ã½ã„å°ã€ã‚’å…¥ã‚Œã‚‹ã ã‘ã®ä¾‹ã ã‚ˆğŸª
> æœ¬ç•ªã¯ Auth.js ãªã©ã®ä»•çµ„ã¿ã‚’ä½¿ã†ã®ãŒãŠã™ã™ã‚ğŸ™âœ¨

### `app/api/secret/route.ts`ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ã¨401ï¼‰

```ts
import { cookies } from "next/headers";
import { NextResponse } from "next/server";

export async function GET() {
  // ä¾‹ï¼šcookieã« session=1 ãŒã‚ã£ãŸã‚‰ãƒ­ã‚°ã‚¤ãƒ³æ‰±ã„ï¼ˆå­¦ç¿’ç”¨ï¼‰
  const cookieStore = await cookies();
  const session = cookieStore.get("session")?.value;

  if (!session) {
    return NextResponse.json(
      { error: "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã ã‚ˆğŸªğŸ”" },
      { status: 401 }
    );
  }

  return NextResponse.json({ message: "ã²ã¿ã¤ãƒ‡ãƒ¼ã‚¿ã ã‚ˆğŸ¤«âœ¨" });
}
```

### ãŸã‚ã—ã¦ã¿ã‚ˆã†ğŸ§ª

* `http://localhost:3000/api/secret` ã«ã‚¢ã‚¯ã‚»ã‚¹
* cookieãŒç„¡ã„ãªã‚‰ **401** ãŒè¿”ã‚‹ã¯ãšï¼ğŸš«

---

## 6) å®Ÿè·µâ‘¡ï¼šMiddlewareã§ã€Œå…¥å£ãƒã‚§ãƒƒã‚¯ã€ã‚‚ã™ã‚‹ğŸ§¤ğŸš¦

Middlewareã¯ã€Œæœ€åˆã«æ­¢ã‚ã‚‹ã€ä¿‚ï¼
ã§ã‚‚æ³¨æ„ï¼š**Middlewareã ã‘ã§å®‰å¿ƒã—ãªã„**ã§ã­ï¼ˆAPIå´ã‚‚å¿…é ˆï¼‰ğŸ’¡

### `middleware.ts`ï¼ˆ/dashboard ã‚’ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã«ã™ã‚‹ä¾‹ï¼‰

```ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function middleware(req: NextRequest) {
  const session = req.cookies.get("session")?.value;

  const isDashboard = req.nextUrl.pathname.startsWith("/dashboard");
  if (isDashboard && !session) {
    const url = req.nextUrl.clone();
    url.pathname = "/login";
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/dashboard/:path*"],
};
```

---

## 7) ã€Œèªå¯ã€ã“ãå‘½

![User accessing their own locker](./picture/next_study_127_authorization_my_data.png)
ï¼šä»–äººã®ãƒ‡ãƒ¼ã‚¿ã‚’è§¦ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ğŸ§±ğŸ—ƒï¸

ã“ã“ã€ã‚ã¡ã‚ƒå¤§äº‹ï¼ï¼ğŸ’¥
ãŸã¨ãˆã° `/api/todos/123` ãŒã‚ã£ã¦ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¦ã‚‚â€¦

* âœ… è‡ªåˆ†ã®Todoãªã‚‰OK
* âŒ ä»–äººã®Todoãªã‚‰ **çµ¶å¯¾ã«NG** ğŸ™…â€â™€ï¸

### å®‰å…¨ãªè€ƒãˆæ–¹ï¼ˆDBã§ã€Œè‡ªåˆ†ã®ã‚‚ã®ã€ã ã‘å–ã‚‹ï¼‰

ï¼ˆPrismaã£ã½ã„é›°å›²æ°—ã®ä¾‹ã ã‚ˆğŸ§ï¼‰

```ts
// "id ãŒä¸€è‡´"ã ã‘ã§å–ã‚‹ã®ã¯å±é™ºã«ãªã‚ŠãŒã¡
// "id ã¨ userId ã®ä¸¡æ–¹ä¸€è‡´"ã§å–ã‚‹ã®ãŒå®‰å…¨âœ¨

const todo = await prisma.todo.findFirst({
  where: {
    id: todoId,
    userId: sessionUserId,
  },
});

if (!todo) {
  return NextResponse.json({ error: "è¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆğŸ˜¢" }, { status: 404 });
}
```

ã“ã®ç™ºæƒ³ã§ã€Œä»–äººã®ãƒ‡ãƒ¼ã‚¿ã«è§¦ã‚Œãªã„ã€ã‚’ä½œã‚Œã‚‹ã‚ˆğŸ”âœ¨

---

## 8) ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ€è€ƒã®åˆè¨€è‘‰

![Server Judge making the final call](./picture/next_study_127_server_final_judgment.png)
ğŸ“£ğŸ’–

### âœ… ã€Œä¿¡ç”¨ã—ãªã„ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

* ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¯ä¿¡ç”¨ã—ãªã„ğŸ§¨
* cookie / header / hidden input ã‚‚ä¿¡ç”¨ã—ãªã„ğŸªğŸ™…â€â™€ï¸
* ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆUIï¼‰ã¯å®ˆã‚Šã˜ã‚ƒãªã„ğŸ–¥ï¸ğŸ’­
* **ã‚µãƒ¼ãƒãƒ¼ãŒæœ€çµ‚åˆ¤æ–­**ğŸ§ âš–ï¸
* DBå–å¾—ã¯ã€Œæœ¬äººã®ãƒ‡ãƒ¼ã‚¿ã ã‘ã€ã«çµã‚‹ğŸ—ƒï¸ğŸ”’

---

## 9) ãƒŸãƒ‹èª²é¡ŒğŸ’âœ¨ï¼ˆæ‰‹ã‚’å‹•ã‹ã™ã‚„ã¤ï¼ï¼‰

### èª²é¡ŒAï¼š/dashboard ã‚’å®ˆã‚ã†ğŸ§¤ğŸ 

1. `middleware.ts` ã‚’å…¥ã‚Œã¦ `/dashboard` ã‚’ `/login` ã«é£›ã°ã™
2. `/dashboard/page.tsx` ã‚‚ã€Œä¿é™ºã€ã§ã‚¬ãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãªã‘ã‚Œã° `redirect("/login")`ï¼‰ã—ã¦ã¿ã‚ˆã†ğŸš¦

### èª²é¡ŒBï¼š/api/todos ã«ã‚‚ã€Œãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã€ã‚’ä»˜ã‘ã‚ˆã†ğŸ“‹ğŸ”

* `GET /api/todos` ã§ `session` ãŒç„¡ã‹ã£ãŸã‚‰ 401 ã«ã™ã‚‹
* UIã‚’ä½œã£ã¦ãªãã¦ã‚‚OKï¼ã¾ãšã¯APIã‚’å›ºã‚ã‚ˆã†ğŸ’ªâœ¨

---

## ã¾ã¨ã‚ğŸ€ğŸ§ 

* **URLã‚„APIã¯ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹å‰æ**ã§ä½œã‚‹ã‚ˆğŸšªğŸ’¥
* å®ˆã‚‹ã®ã¯ **UIã˜ã‚ƒãªãã¦ã‚µãƒ¼ãƒãƒ¼**ğŸ›¡ï¸
* å¿…é ˆã¯ **èªè¨¼ãƒ»èªå¯ãƒ»å…¥åŠ›æ¤œè¨¼**ã®3ç‚¹ã‚»ãƒƒãƒˆâœ…âœ…âœ…
* Middlewareã¯ä¾¿åˆ©ã ã‘ã©ã€**APIå´ã®ãƒã‚§ãƒƒã‚¯ã‚‚å¿…ãš**ğŸ”¥
* DBã¯ã€Œæœ¬äººã®ãƒ‡ãƒ¼ã‚¿ã ã‘å–ã‚‹ã€ã§äº‹æ•…ã‚’é˜²ãğŸ—ƒï¸ğŸ”’

---

æ¬¡ã®ç« ï¼ˆç¬¬128ç« ï¼‰ã§ã€ã€Œã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯UIã˜ã‚ƒãªãã‚µãƒ¼ãƒãƒ¼ğŸ™…ã€ã‚’ã‚‚ã£ã¨ãƒãƒƒã‚­ãƒªå›ºã‚ã¦ã„ã“ã†ã­ã€œï¼ğŸ’–ğŸš€
