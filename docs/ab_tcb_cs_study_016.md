# ç¬¬16ç« ï¼šå¢ƒç•Œã‚’åˆ‡ã‚‹ç·´ç¿’ï¼ˆãƒ¯ãƒ¼ã‚¯3æœ¬ï¼‰âœï¸ğŸ€

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ğŸ¯âœ¨

* ã€Œã“ã®ãƒ«ãƒ¼ãƒ«ã¯åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®ˆã‚‹ï¼Ÿã‚ã¨ã§æƒãˆã°OKï¼Ÿã€ã‚’åˆ†ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹â±ï¸â³
* é›†ç´„ï¼ˆAggregateï¼‰ã®å¢ƒç•Œæ¡ˆã‚’ **è¤‡æ•°å‡ºã—ã¦** æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹âš–ï¸ğŸ‘€
* ã€Œè·¨ãæ›´æ–°ã—ãŸããªã‚‹èª˜æƒ‘ã€ã¸ã®å¯¾å‡¦ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‹ã‚‹ğŸ™…â€â™€ï¸ğŸ§ 

---

## 0. å¢ƒç•Œã‚’åˆ‡ã‚‹ãŸã‚ã®â€œå‹â€ğŸ§ğŸ§ 

![ab_tcb_cs_study_016_5_steps](./picture/ab_tcb_cs_study_016_5_steps.png)


å¢ƒç•Œã‚’åˆ‡ã‚‹ã¨ãã¯ã€ã ã„ãŸã„ã“ã®é †ç•ªã§OKã ã‚ˆğŸ‘‡âœ¨

1. **ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆ1å›ã®æ“ä½œï¼‰ã‚’1è¡Œã§æ›¸ã**âœï¸
2. **ä¸å¤‰æ¡ä»¶ï¼ˆçµ¶å¯¾å®ˆã‚‹ãƒ«ãƒ¼ãƒ«ï¼‰ã‚’ç®‡æ¡æ›¸ã**ğŸ”
3. **å³æ™‚æ•´åˆï¼ˆã„ã¾çµ¶å¯¾ï¼‰/ æœ€çµ‚çš„æ•´åˆï¼ˆã‚ã¨ã§OKï¼‰ã‚’åˆ†é¡**âš–ï¸
4. **é›†ç´„å€™è£œã‚’3æ¡ˆä½œã£ã¦æ¯”è¼ƒ**ï¼ˆã“ã“ãŒæœ¬ç« ã®ç·´ç¿’ï¼ï¼‰ğŸŒ³ğŸŒ³ğŸŒ³
5. **â€œæ›´æ–°ã®å…¥å£â€ï¼é›†ç´„ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹**ğŸ‘‘ğŸšª

```mermaid
flowchart TD
    Step1[1. ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å®šç¾©] --> Step2[2. ä¸å¤‰æ¡ä»¶ã®æŠ½å‡º]
    Step2 --> Step3[3. æ•´åˆæ€§ã®åˆ†é¡]
    Step3 --> Step4[4. å¢ƒç•Œæ¡ˆã®æ¯”è¼ƒ]
    Step4 --> Step5[5. é›†ç´„ãƒ«ãƒ¼ãƒˆã®æ±ºå®š]
```

---

## 1. ã¾ãšã¯å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆã“ã‚Œã‚’åŸ‹ã‚ã‚‹ã ã‘ï¼‰ğŸ§¾âœ¨

![å¢ƒç•Œã¥ã‘ã‚­ãƒ£ãƒ³ãƒã‚¹](./picture/ab_tcb_cs_study_016_canvas.png)


## å¢ƒç•Œã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆ1ã‚±ãƒ¼ã‚¹ã«ã¤ãã“ã‚Œ1æšï¼‰ğŸ“„ğŸŒ¸

* ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆ1è¡Œï¼‰ï¼š
* ä¸»è¦ãªç”¨èªï¼ˆåè©ï¼‰ï¼š
* ä¸»è¦ãªæ“ä½œï¼ˆå‹•è©ï¼‰ï¼š
* ä¸å¤‰æ¡ä»¶ï¼ˆçµ¶å¯¾å®ˆã‚‹ï¼‰ï¼š
* æœ€çµ‚çš„æ•´åˆã§ã‚‚OKï¼š
* é›†ç´„æ¡ˆAï¼š
* é›†ç´„æ¡ˆBï¼š
* é›†ç´„æ¡ˆCï¼š
* æ¡ç”¨æ¡ˆã¨ç†ç”±ï¼š

## æ¯”è¼ƒã®è¦³ç‚¹ï¼ˆè¿·ã£ãŸã‚‰ã“ã“ã‚’è¦‹ã‚‹ï¼‰ğŸ‘€âš–ï¸

![ab_tcb_cs_study_016_comparison_mindmap](./picture/ab_tcb_cs_study_016_comparison_mindmap.png)


* **åŒæ™‚ã«å®ˆã‚‹å¿…è¦ãŒã‚ã‚‹ãƒ«ãƒ¼ãƒ«**ãŒåŒã˜é›†ç´„ã«åã¾ã£ã¦ã‚‹ï¼Ÿâœ…
* ãã®é›†ç´„ã€**å¤§ãã™ããªã„ï¼Ÿ**ï¼ˆå¤‰æ›´ã—ã¥ã‚‰ã„/é‡ã„ï¼‰ğŸ“¦ğŸ’¥
* **å°ã•ã™ããªã„ï¼Ÿ**ï¼ˆè·¨ãæ›´æ–°ã—ãŸããªã‚‹ï¼‰ğŸ§©ğŸ˜µ
* ä»–é›†ç´„ã‚’ **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã—ã¦ãªã„ï¼Ÿï¼ˆIDå‚ç…§ã«ãªã£ã¦ã‚‹ï¼Ÿï¼‰** ğŸ†”âœ¨
* ã€Œå¤–éƒ¨I/Oï¼ˆæ±ºæ¸ˆ/ãƒ¡ãƒ¼ãƒ«/åœ¨åº«APIãªã©ï¼‰ã€ã‚’åŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å…¥ã‚Œã¦ãªã„ï¼ŸğŸŒğŸš«

```mermaid
mindmap
    root((å¢ƒç•Œã®æ¯”è¼ƒè¦³ç‚¹))
        æ•´åˆæ€§
            ä¸å¤‰æ¡ä»¶ã‚’å®ˆã‚Œã‚‹ã‹
        ã‚µã‚¤ã‚º
            å¤§ãã™ããªã„ã‹
            å°ã•ã™ããªã„ã‹
        çµåˆ
            ä»–é›†ç´„ã‚’IDå‚ç…§ã‹
        å¤–éƒ¨è¦å› 
            å¤–éƒ¨IOã‚’åˆ†é›¢ã‹
```

---

## 2. AIã«ã€Œå¢ƒç•Œæ¡ˆã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³ã€å‡ºã•ã›ã‚‹å‹ğŸ¤–âœ¨

## ä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼ˆã‚³ãƒ”ãƒšOKï¼‰ğŸ“‹ğŸ’¬

ï¼ˆCopilot Chat / Codexç³»ã®ãƒãƒ£ãƒƒãƒˆã«æŠ•ã’ã‚‹æƒ³å®šã ã‚ˆï¼‰

```text
ã‚ãªãŸã¯DDDå…¥é–€è€…å‘ã‘ã®è¨­è¨ˆã‚³ãƒ¼ãƒã§ã™ã€‚
æ¬¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è¦ä»¶ã«å¯¾ã—ã¦ã€Aggregateï¼ˆé›†ç´„ï¼‰å¢ƒç•Œã®æ¡ˆã‚’3ãƒ‘ã‚¿ãƒ¼ãƒ³ææ¡ˆã—ã¦ãã ã•ã„ã€‚

- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆ1è¡Œï¼‰:
- ãƒ«ãƒ¼ãƒ«ï¼ˆä¸å¤‰æ¡ä»¶ï¼‰:
- å³æ™‚æ•´åˆãŒå¿…è¦ãªã‚‚ã® / æœ€çµ‚çš„æ•´åˆã§ã‚ˆã„ã‚‚ã®:
- ç™»å ´ã™ã‚‹æ¦‚å¿µï¼ˆåè©ï¼‰:

å‡ºåŠ›æ¡ä»¶:
1) æ¡ˆA/B/Cãã‚Œãã‚Œã§ã€Œé›†ç´„ãƒ«ãƒ¼ãƒˆã€ã€Œé›†ç´„ã«å«ã‚ã‚‹ã‚‚ã®ã€ã€ŒIDå‚ç…§ã§å¤–ã«å‡ºã™ã‚‚ã®ã€ã‚’æ˜è¨˜
2) ãã‚Œãã‚Œã®ãƒ¡ãƒªãƒƒãƒˆ/ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼ˆå·¨å¤§åŒ–/è·¨ãæ›´æ–°/çµåˆåº¦/å¤‰æ›´å®¹æ˜“æ€§ï¼‰ã‚’æ›¸ã„ã¦
3) æœ€å¾Œã«ã€Œã“ã®æ¡ä»¶ãªã‚‰ç§ã¯æ¡ˆXã‚’æ¨ã™ã€ã‚’ç†ç”±ä»˜ãã§
4) åˆå¿ƒè€…ãŒã‚„ã‚ŠãŒã¡ãªåœ°é›·ã‚‚æ›¸ã„ã¦
```

## AIã®ç­”ãˆã‚’æ¡ç”¨ã™ã‚‹å‰ã®â€œãƒã‚§ãƒƒã‚¯è³ªå•â€ğŸ§ ğŸ”

* ã€Œãã®ä¸å¤‰æ¡ä»¶ã€**ã©ã®ç¬é–“ã«ç ´ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹**ï¼Ÿã€
* ã€Œãã‚Œã‚’å®ˆã‚‹ã®ã« **åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦**ï¼Ÿã€
* ã€Œå¤–éƒ¨I/OãŒæ··ã–ã£ã¦ãªã„ï¼Ÿæ··ã–ã‚‹ãªã‚‰åˆ†é›¢ã§ããªã„ï¼Ÿã€
* ã€Œä»–é›†ç´„å‚ç…§ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã«ãªã£ã¦ãªã„ï¼ŸIDå‚ç…§ï¼Ÿã€

---

## 3. ãƒ¯ãƒ¼ã‚¯1ï¼šã‚«ãƒ•ã‚§æ³¨æ–‡ï¼ˆåŸºæœ¬ï¼‰â˜•ï¸ğŸ°

## 3-1. ãŠé¡Œï¼ˆè¶…ã–ã£ãã‚Šè¦ä»¶ï¼‰ğŸ“‹âœ¨

* ãŠå®¢ã•ã‚“ãŒæ³¨æ–‡ã‚’ä½œã‚‹ï¼ˆå•†å“è¿½åŠ ãƒ»æ•°é‡å¤‰æ›´ï¼‰ğŸ§â•
* æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹ï¼ˆç¢ºå®šå¾Œã¯å¤‰æ›´ä¸å¯ï¼‰âœ…ğŸ”’
* æ”¯æ‰•ã„ã¯å¤–éƒ¨æ±ºæ¸ˆï¼ˆæˆåŠŸ/å¤±æ•—ãŒã‚ã‚‹ï¼‰ğŸ’³ğŸ’¥
* æ”¯æ‰•ã„ãŒæˆåŠŸã—ãŸã‚‰ã€Œæ”¯æ‰•ã„æ¸ˆã¿ã€ã«ãªã‚‹ğŸ§¾âœ…

## 3-2. ä¸å¤‰æ¡ä»¶ï¼ˆä¾‹ï¼‰ğŸ”

* æ³¨æ–‡ç¢ºå®šã¯ **æ˜ç´°ãŒ1ã¤ä»¥ä¸Š** å¿…è¦ğŸ§¾â•
* ç¢ºå®šå¾Œã¯ **æ˜ç´°å¤‰æ›´ã§ããªã„** ğŸš«
* æ”¯æ‰•ã„æ¸ˆã¿ã®æ³¨æ–‡ã‚’ **å†åº¦æ”¯æ‰•ã„ã«å›ã•ãªã„** ğŸ”ğŸš«

## 3-3. å³æ™‚æ•´åˆ / æœ€çµ‚çš„æ•´åˆã®åˆ†é¡âš–ï¸

* å³æ™‚ã§å®ˆã‚‹ï¼ˆåŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæ°—æŒã¡ã„ã„ï¼‰âœ…

  * ã€Œç¢ºå®šå¾Œã¯æ˜ç´°å¤‰æ›´ã§ããªã„ã€
  * ã€Œç¢ºå®šã¯æ˜ç´°1ä»¶ä»¥ä¸Šã€
* æœ€çµ‚çš„æ•´åˆã§ã‚‚OKï¼ˆå¤–éƒ¨I/OãŒçµ¡ã¿ã‚„ã™ã„ï¼‰â³

  * ã€Œæ”¯æ‰•ã„æˆåŠŸ â†’ æ”¯æ‰•ã„æ¸ˆã¿åæ˜ ã€
  * ã€Œãƒ¬ã‚·ãƒ¼ãƒˆç™ºè¡Œ/é€šçŸ¥ã€

## 3-4. å¢ƒç•Œæ¡ˆA/B/Cï¼ˆæ¯”è¼ƒç·´ç¿’ï¼‰ğŸŒ³âš–ï¸

![ab_tcb_cs_study_016_cafe_options](./picture/ab_tcb_cs_study_016_cafe_options.png)


### æ¡ˆAï¼šå·¨å¤§æ¡ˆï¼ˆOrderã®ä¸­ã«Paymentã¾ã§å…¥ã‚Œã‚‹ï¼‰ğŸ“¦ğŸ’¥

* **é›†ç´„ãƒ«ãƒ¼ãƒˆ**ï¼šOrder
* **å«ã‚ã‚‹**ï¼šOrderItems, Paymentæƒ…å ±ï¼ˆçŠ¶æ…‹/çµæœï¼‰
* **å¤–ã«å‡ºã™ï¼ˆIDå‚ç…§ï¼‰**ï¼šCustomerId, MenuItemId
* âœ…ãƒ¡ãƒªãƒƒãƒˆï¼šè¦‹ãŸç›®ã¯ã€Œå…¨éƒ¨ã“ã“ã§å®Œçµã€ã£ã½ã„
* âŒãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šå¤–éƒ¨æ±ºæ¸ˆï¼ˆé…ã„/å¤±æ•—/å†è©¦è¡Œï¼‰ã§ **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåœ°ç„**ã€å¤‰æ›´ã‚‚æ€–ã„ğŸ˜±

### æ¡ˆBï¼šãŠã™ã™ã‚å¯„ã‚Šï¼ˆOrder ã¨ Payment ã‚’åˆ†ã‘ã‚‹ï¼‰ğŸŒ¿âœ¨

* **é›†ç´„ãƒ«ãƒ¼ãƒˆ**ï¼šOrder / Paymentï¼ˆåˆ¥é›†ç´„ï¼‰
* **Orderã«å«ã‚ã‚‹**ï¼šOrderItems, Statusï¼ˆDraft/Confirmedï¼‰
* **Paymentã«å«ã‚ã‚‹**ï¼šOrderId, Statusï¼ˆPending/Succeeded/Failedï¼‰, ProviderRef
* âœ…ãƒ¡ãƒªãƒƒãƒˆï¼šæ³¨æ–‡ç¢ºå®šã®æ•´åˆæ€§ã¨ã€æ±ºæ¸ˆã®ä¸ç¢ºå®Ÿã•ã‚’åˆ†é›¢ã§ãã‚‹ğŸ§ 
* âœ…ãƒ¡ãƒªãƒƒãƒˆï¼šæ±ºæ¸ˆã¯å†è©¦è¡Œãƒ»Webhookãªã©ã«ã‚‚å¯¾å¿œã—ã‚„ã™ã„ğŸ”
* âŒãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šçŠ¶æ…‹ãŒ2ã¤ã«åˆ†ã‹ã‚Œã‚‹ã®ã§UIè¨­è¨ˆãŒå¿…è¦ï¼ˆã€Œæ±ºæ¸ˆå‡¦ç†ä¸­ã€è¡¨ç¤ºãªã©ï¼‰ğŸ‘€ğŸ’¬

### æ¡ˆCï¼šç´°ã‹ã™ãæ¡ˆï¼ˆOrderItemã‚’åˆ¥é›†ç´„ã«åˆ†ã‘ã‚‹ï¼‰ğŸ§©ğŸ˜µ

* **é›†ç´„ãƒ«ãƒ¼ãƒˆ**ï¼šOrder / OrderItem
* âœ…ãƒ¡ãƒªãƒƒãƒˆï¼šå€‹åˆ¥æ›´æ–°ã¯è»½ã„
* âŒãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šç¢ºå®šæ™‚ã« **è·¨ãæ›´æ–°ã—ãŸããªã‚‹**ï¼ˆOrderã¨Itemã‚’åŒæ™‚ã«â€¦ï¼‰â†’çµå±€ã¤ã‚‰ã„ğŸ’¥

âœ…ã“ã®ã‚±ãƒ¼ã‚¹ã®â€œç€åœ°â€ã¯ **æ¡ˆB** ãŒè‡ªç„¶ã ã‚ˆï¼ˆæ³¨æ–‡ç¢ºå®šã¯å³æ™‚ã€æ±ºæ¸ˆã¯åˆ¥ã§æ‰±ã†ï¼‰ğŸŒ¸

```mermaid
graph TD
    subgraph Plan_A [æ¡ˆA: å…¨éƒ¨å…¥ã‚Š]
        Order1[Order] --- Payment1[Payment]
    end
    subgraph Plan_B [æ¡ˆB: åˆ†é›¢]
        Order2[Order] -. IDå‚ç…§ .-> Payment2[Payment]
    end
    subgraph Plan_C [æ¡ˆC: ç´°ç²’åº¦]
        Order3[Order] --- Item3[Item1]
        Order3 --- Item4[Item2]
    end
```

---

## 3-5. C#ãƒŸãƒ‹éª¨æ ¼ï¼ˆâ€œé›†ç´„ã£ã½ã•â€ã‚’æ‰‹ã§æ´ã‚€ï¼‰ğŸ› ï¸âœ¨

```csharp
public readonly record struct OrderId(Guid Value);
public readonly record struct PaymentId(Guid Value);

public enum OrderStatus { Draft, Confirmed }
public enum PaymentStatus { Pending, Succeeded, Failed }

public sealed class Order
{
    public OrderId Id { get; }
    public OrderStatus Status { get; private set; } = OrderStatus.Draft;

    private readonly List<OrderItem> _items = new();
    public IReadOnlyList<OrderItem> Items => _items;

    public Order(OrderId id) => Id = id;

    public void AddItem(string menuItemCode, int qty)
    {
        if (Status != OrderStatus.Draft) throw new InvalidOperationException("ç¢ºå®šå¾Œã¯ç·¨é›†ã§ãã¾ã›ã‚“");
        if (qty <= 0) throw new ArgumentOutOfRangeException(nameof(qty));
        _items.Add(new OrderItem(menuItemCode, qty));
    }

    public void Confirm()
    {
        if (Status != OrderStatus.Draft) return;
        if (_items.Count == 0) throw new InvalidOperationException("æ˜ç´°ãŒ0ä»¶ã§ã¯ç¢ºå®šã§ãã¾ã›ã‚“");
        Status = OrderStatus.Confirmed;
    }
}

public sealed record OrderItem(string MenuItemCode, int Quantity);
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚Œã ã‘ğŸ‘†âœ¨

* **æ›´æ–°ã¯ãƒ¡ã‚½ãƒƒãƒ‰çµŒç”±**ï¼ˆå‹æ‰‹ã«å£Šã•ã‚Œãªã„ï¼‰ğŸ”
* **åŒã˜é›†ç´„ã§å®ˆã‚‹ãƒ«ãƒ¼ãƒ«ã ã‘**å…¥ã‚Œã‚‹ï¼ˆæ±ºæ¸ˆçµæœã¾ã§æŠ±ãˆãªã„ï¼‰ğŸ’³ğŸš«

---

## 4. ãƒ¯ãƒ¼ã‚¯2ï¼šã‚µãƒ–ã‚¹ã‚¯èª²é‡‘ï¼ˆæ›´æ–°ã¨å‚ç…§ãŒåˆ†ã‹ã‚Œã‚„ã™ã„ï¼‰ğŸ’³ğŸ“†

## 4-1. ãŠé¡Œï¼ˆè¦ä»¶ï¼‰ğŸ“‹âœ¨

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ©ãƒ³å¥‘ç´„ã™ã‚‹ï¼ˆé–‹å§‹æ—¥ãƒ»æ›´æ–°æ—¥ãŒã‚ã‚‹ï¼‰ğŸ—“ï¸
* æ¯æœˆè«‹æ±‚ãŒç™ºç”Ÿï¼ˆè«‹æ±‚æ›¸/æ”¯æ‰•ã„ï¼‰ğŸ§¾
* æ”¯æ‰•ã„æˆåŠŸã§åˆ©ç”¨å¯èƒ½ã€å¤±æ•—ã§åœæ­¢ï¼ˆçŒ¶äºˆæœŸé–“ã‚ã‚Šï¼‰âš ï¸
* ãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»è§£ç´„ãŒã‚ã‚‹ğŸ”ğŸšª

## 4-2. ä¸å¤‰æ¡ä»¶ï¼ˆä¾‹ï¼‰ğŸ”

* æœ‰åŠ¹ãªå¥‘ç´„ã¯ **é–‹å§‹æ—¥ <= ä»Šæ—¥**
* æœ‰åŠ¹ãªå¥‘ç´„ã¯ **åŒæ™‚ã«2ã¤æŒã¦ãªã„**ï¼ˆåŒä¸€ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ğŸš«
* è«‹æ±‚æ›¸ã¯ **åŒã˜æœˆã«äºŒé‡ä½œæˆã—ãªã„** ğŸ”ğŸš«

## 4-3. å¢ƒç•Œæ¡ˆï¼ˆã‚³ãƒ„ï¼šæ™‚é–“ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãŒçµ¡ã‚€ï¼‰â³ğŸ“£

### æ¡ˆAï¼šSubscriptioné›†ç´„ã«Invoice/Paymentå…¨éƒ¨å…¥ã‚ŠğŸ“¦ğŸ’¥

* âŒæœˆæ¬¡å‡¦ç†ã€Webhookã€å†è©¦è¡Œâ€¦ã§å·¨å¤§åŒ–ã—ã‚„ã™ã„ğŸ˜µ

### æ¡ˆBï¼šSubscription / Invoice / Payment ã‚’åˆ†ã‘ã‚‹ï¼ˆæ¨ã—ï¼‰ğŸŒ¿âœ¨

![ab_tcb_cs_study_016_subscription_time](./picture/ab_tcb_cs_study_016_subscription_time.png)


* **Subscriptioné›†ç´„**ï¼šå¥‘ç´„çŠ¶æ…‹ï¼ˆActive/Suspended/Cancelledï¼‰ã¨æ¬¡å›è«‹æ±‚æ—¥ğŸ“†
* **Invoiceé›†ç´„**ï¼šè«‹æ±‚ã®äº‹å®Ÿï¼ˆè«‹æ±‚æœˆã€é‡‘é¡ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ğŸ§¾
* **Paymenté›†ç´„**ï¼šå¤–éƒ¨æ±ºæ¸ˆã®çµæœï¼ˆSucceeded/Failedãªã©ï¼‰ğŸ’³
* âœ…ã€Œå¥‘ç´„ã®ãƒ«ãƒ¼ãƒ«ã€ã¨ã€ŒãŠé‡‘ã®ä¸ç¢ºå®Ÿã•ã€ã‚’åˆ†ã‘ã‚‰ã‚Œã‚‹ğŸ§ 
* âœ…ãƒªãƒˆãƒ©ã‚¤/ç›£æŸ»ãƒ­ã‚°ã«ã‚‚å¼·ã„ğŸ”

### æ¡ˆCï¼šInvoiceã‚’Subscriptionã®å†…å´ã«å…¥ã‚Œã‚‹ï¼ˆã»ã©ã»ã©ï¼‰ğŸ§©

* ã‚±ãƒ¼ã‚¹ã«ã‚ˆã£ã¦ã¯OKã ã‘ã©ã€è«‹æ±‚å±¥æ­´ãŒå¤šã„ã¨é‡ããªã‚ŠãŒã¡ğŸ“šğŸ’¦

ã“ã®ãƒ¯ãƒ¼ã‚¯ã®å­¦ã³ã¯ã“ã‚ŒğŸ‘‡âœ¨

* ã‚µãƒ–ã‚¹ã‚¯ã¯ **æ™‚é–“ãŒå‹æ‰‹ã«é€²ã‚€**ï¼ˆæœˆæ¬¡ãƒãƒƒãƒ/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©/Webhookï¼‰â°
* ã ã‹ã‚‰ã€Œå…¨éƒ¨ã‚’1ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã€ã¯ç„¡ç†ã«ãªã‚Šã‚„ã™ã„ğŸ™…â€â™€ï¸
* å¢ƒç•Œã¯ **â€œæœªæ¥ã®é‹ç”¨â€ã‚’å®ˆã‚‹ãŸã‚**ã«åˆ‡ã‚‹ğŸ›¡ï¸

â€»C# 14 ã¯ .NET 10 SDK ã¨ Visual Studio 2026 ã§è©¦ã›ã‚‹ã‚ˆğŸ“Œâœ¨ ([Microsoft Learn][1])

---

## 5. ãƒ¯ãƒ¼ã‚¯3ï¼šåœ¨åº«å¼•å½“ï¼ˆè·¨ãæ›´æ–°ã®èª˜æƒ‘ãŒå¼·ã„ï¼‰ğŸ“¦ğŸ”¥

## 5-1. ãŠé¡Œï¼ˆè¦ä»¶ï¼‰ğŸ“‹âœ¨

* æ³¨æ–‡ãŒå…¥ã£ãŸã‚‰åœ¨åº«ã‚’å¼•ãå½“ã¦ãŸã„ï¼ˆç¢ºä¿ï¼‰ğŸ§º
* åœ¨åº«ãŒè¶³ã‚Šãªã‘ã‚Œã°ä¿ç•™/ã‚­ãƒ£ãƒ³ã‚»ãƒ«â³âŒ
* åŒæ™‚ã«æ³¨æ–‡ãŒæ¥ã‚‹ï¼ˆç«¶åˆï¼‰ğŸ’¥
* å¼•å½“å¾Œã«æ”¯æ‰•ã„å¤±æ•—ã§åœ¨åº«ã‚’æˆ»ã™ã“ã¨ã‚‚ã‚ã‚‹â†©ï¸

## 5-2. ä¸å¤‰æ¡ä»¶ï¼ˆä¾‹ï¼‰ğŸ”

* åœ¨åº«ã®ã€Œç¢ºä¿æ¸ˆã¿ + åˆ©ç”¨å¯èƒ½ã€ã¯ **ç·åœ¨åº«ã‚’è¶…ãˆãªã„** ğŸš«
* åŒã˜æ³¨æ–‡ã«å¯¾ã—ã¦ **äºŒé‡å¼•å½“ã—ãªã„** ğŸ”ğŸš«

## 5-3. ã“ã“ãŒæœ€å¤§ã®ç½ âš ï¸ğŸ˜‡

ã‚„ã‚ŠãŒã¡ï¼š

* Orderé›†ç´„ã§ã€Œåœ¨åº«ã‚’æ¸›ã‚‰ã—ã¦ã€æ³¨æ–‡ã‚’æ›´æ–°ã—ã¦â€¦ã€ã‚’ **åŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚„ã‚ŠãŸããªã‚‹**ğŸ™ˆğŸ’¥
  ã§ã‚‚ãã‚Œã‚’ã‚„ã‚‹ã¨ğŸ‘‡
* **å·¨å¤§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**ï¼ˆé‡ã„ãƒ»é…ã„ãƒ»å¤±æ•—ã—ã‚„ã™ã„ï¼‰
* åŒæ™‚æ›´æ–°ã§äº‹æ•…ã‚Šã‚„ã™ã„ï¼ˆå¾Œã®ç« ã§å­¦ã¶ã‚„ã¤ï¼‰ğŸš‘

## 5-4. å¢ƒç•Œæ¡ˆA/B/Cï¼ˆã“ã®ç« ã®ãƒ¡ã‚¤ãƒ³ç·´ç¿’ï¼‰ğŸŒ³âš–ï¸

### æ¡ˆAï¼šOrderãŒInventoryã‚’ç›´æ¥æ›´æ–°ï¼ˆè·¨ãæ›´æ–°ï¼‰ğŸ™…â€â™€ï¸

* âŒå¢ƒç•Œå´©å£Šã‚³ãƒ¼ã‚¹ï¼ˆçµåˆãŒå¼·ã™ãï¼‰ğŸ§·ğŸ’¥

### æ¡ˆBï¼šInventoryé›†ç´„ã§Reservationï¼ˆå¼•å½“ï¼‰ã‚’ç®¡ç†ï¼ˆãŠã™ã™ã‚ï¼‰ğŸŒ¿âœ¨

![ab_tcb_cs_study_016_inventory_strategy](./picture/ab_tcb_cs_study_016_inventory_strategy.png)


* **Inventoryé›†ç´„ãƒ«ãƒ¼ãƒˆ**ï¼šInventoryItemï¼ˆSKUå˜ä½ï¼‰
* **å«ã‚ã‚‹**ï¼šAvailableQty / ReservedQty / Reservationsï¼ˆOrderIdå˜ä½ï¼‰
* **Orderé›†ç´„**ï¼šOrderStatusï¼ˆReservingStock / StockReserved / StockFailedï¼‰ã¿ãŸã„ã«çŠ¶æ…‹ã‚’æŒã¤
* âœ…ã€Œåœ¨åº«ã®ä¸å¤‰æ¡ä»¶ã€ã‚’ **Inventoryå´ã«é›†ã‚ã‚‰ã‚Œã‚‹**ğŸ”
* âœ…Orderã¯ã€Œå¼•å½“çµæœã‚’å¾…ã¤ã€çŠ¶æ…‹ã§è¡¨ç¾ã§ãã‚‹ğŸ‘€â³

### æ¡ˆCï¼šReservationã‚’åˆ¥é›†ç´„ã«ã—ã¦åˆ†æ•£ï¼ˆé«˜è² è·å‘ã‘ï¼‰âš™ï¸

* å¼•å½“ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆReservationï¼‰ã‚’ç‹¬ç«‹ã•ã›ã¦ç«¶åˆã‚’ä¸‹ã’ã‚‹
* âœ…ã‚¹ã‚±ãƒ¼ãƒ«ã—ã‚„ã™ã„
* âŒå…¥é–€ã ã¨æ¦‚å¿µãŒå¢—ãˆã‚‹ï¼ˆã¾ãšã¯Bã§OKï¼‰ğŸ˜Š

> åœ¨åº«ã¿ãŸã„ã«ç«¶åˆãŒå¼·ã„å ´æ‰€ã¯ã€EF Core ã§ã¯æ¥½è¦³çš„åŒæ™‚å®Ÿè¡Œï¼ˆrowversionãªã©ï¼‰ã§è¡çªæ¤œå‡ºã™ã‚‹ã‚„ã‚Šæ–¹ãŒå®šç•ªã ã‚ˆğŸ“Œï¼ˆè©³ã—ãã¯å¾ŒåŠç« ã§ï¼ï¼‰ ([Microsoft Learn][2])

---

## 6. 3ã‚±ãƒ¼ã‚¹å…±é€šï¼šæ¡ç”¨æ¡ˆã®â€œèª¬æ˜ãƒ†ãƒ³ãƒ—ãƒ¬â€ğŸ—£ï¸ğŸŒ¸

ç™ºè¡¨ï¼ˆèª¬æ˜ï¼‰ã™ã‚‹ã¨ãã¯ã€ã“ã®é †ã§è¨€ãˆã°å‹ã¡ğŸ†âœ¨

1. **ã“ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§å³æ™‚ã«å®ˆã‚ŠãŸã„ä¸å¤‰æ¡ä»¶ã¯ã“ã‚Œ**ğŸ”
2. **ã ã‹ã‚‰åŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§é–‰ã˜ã‚‹ç¯„å›²ã¯ã“ã“**ğŸ”’
3. **å¤–éƒ¨I/Oã‚„æ™‚é–“ãŒçµ¡ã‚€ã‚‚ã®ã¯å¤–ã«å‡ºã™**â³ğŸŒ
4. **ä»–é›†ç´„å‚ç…§ã¯IDã§æŒã¤**ğŸ†”
5. **å·¨å¤§åŒ–/è·¨ãæ›´æ–°ã®ãƒªã‚¹ã‚¯ã‚’ã“ã†é¿ã‘ãŸ**ğŸ›¡ï¸

---

## 7. ä»•ä¸Šã’ãƒŸãƒ‹èª²é¡Œï¼ˆæå‡ºç‰©ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ğŸ“ğŸ€

## æå‡ºç‰©Aï¼šå¢ƒç•Œã‚­ãƒ£ãƒ³ãƒã‚¹3æšğŸ“„ğŸ“„ğŸ“„

* ã‚«ãƒ•ã‚§æ³¨æ–‡
* ã‚µãƒ–ã‚¹ã‚¯èª²é‡‘
* åœ¨åº«å¼•å½“

## æå‡ºç‰©Bï¼šå„ã‚±ãƒ¼ã‚¹ã€Œæ¡ˆA/B/Cã®æ¯”è¼ƒè¡¨ã€1æšãšã¤âš–ï¸ğŸ‘€

* ãƒ¡ãƒªãƒƒãƒˆ
* ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
* ã©ã®ä¸å¤‰æ¡ä»¶ã‚’å®ˆã‚Šã‚„ã™ã„ã‹
* ã©ã“ãŒé‹ç”¨ã§è¾›ããªã‚Šãã†ã‹

## æå‡ºç‰©Cï¼šC#ã®è¶…ãƒŸãƒ‹éª¨æ ¼ï¼ˆ1ã‚±ãƒ¼ã‚¹ã§OKï¼‰ğŸ› ï¸âœ¨

* é›†ç´„ãƒ«ãƒ¼ãƒˆã®ã‚¯ãƒ©ã‚¹
* ä¸å¤‰æ¡ä»¶ã‚’å®ˆã‚‹ãƒ¡ã‚½ãƒƒãƒ‰2ã¤ä»¥ä¸Š
* ä»–é›†ç´„ã¯IDå‚ç…§ã«ãªã£ã¦ã„ã‚‹ã“ã¨ğŸ†”

---

## 8. ã‚ˆãã‚ã‚‹ãƒŸã‚¹é›†ï¼ˆå…ˆã«è¸ã¿æŠœãå›é¿ï¼‰ğŸš§ğŸ˜…

![ab_tcb_cs_study_016_common_mistakes](./picture/ab_tcb_cs_study_016_common_mistakes.png)


* ã€Œå…¨éƒ¨ã¾ã¨ã‚ãŸã‚‰å®‰å¿ƒã€â†’ **å·¨å¤§é›†ç´„ã§è©°ã‚€**ğŸ“¦ğŸ’¥
* ã€Œåˆ†ã‘ã‚Œã°æ­£ç¾©ã€â†’ **è·¨ãæ›´æ–°ã—ãŸããªã£ã¦è©°ã‚€**ğŸ§©ğŸ˜µ
* ã€Œå‚ç…§ãŒæ¬²ã—ã„ã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã€â†’ **å¯†çµåˆã§è©°ã‚€**ğŸ§·ğŸš«
* ã€Œæ±ºæ¸ˆ/å¤–éƒ¨APIã‚‚ä¸€ç·’ã«ç¢ºå®šã€â†’ **å¤±æ•—ã¨å†è©¦è¡Œã§è©°ã‚€**ğŸ’³ğŸ”ğŸ’¥

---

## ã¾ã¨ã‚ğŸŒ¸âœ¨

* å¢ƒç•Œã¯ã€ŒDBã®éƒ½åˆã€ã˜ã‚ƒãªãã¦ **â€œåŒæ™‚ã«å®ˆã‚‹ã¹ããƒ«ãƒ¼ãƒ«â€ã®éƒ½åˆ**ã§åˆ‡ã‚‹ğŸ§ ğŸ”’
* **æ¡ˆã‚’3ã¤å‡ºã—ã¦æ¯”è¼ƒ**ã™ã‚‹ã¨ã€å¢ƒç•ŒãŒâ€œèª¬æ˜ã§ãã‚‹è¨­è¨ˆâ€ã«ãªã‚‹âœï¸âš–ï¸
* ã€Œå¤–éƒ¨I/Oã€ã€Œæ™‚é–“ãŒå‹æ‰‹ã«é€²ã‚€ã€ã€Œç«¶åˆãŒå¼·ã„ã€â€¦ã“ã“ãŒåˆ†é›¢ã®ã‚µã‚¤ãƒ³ğŸ‘€â³ğŸ“¦

[1]: https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-14?utm_source=chatgpt.com "What's new in C# 14"
[2]: https://learn.microsoft.com/en-us/ef/core/saving/concurrency?utm_source=chatgpt.com "Handling Concurrency Conflicts - EF Core"
