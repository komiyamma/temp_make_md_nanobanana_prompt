# ç¬¬17ç« ï¼šç¾å®Ÿãã®â‘¢ã€Œæ¥ãªã„/é…ã„ï¼ˆå–ã‚Šã“ã¼ã—ãƒ»é…å»¶ï¼‰ã€ğŸ•³ï¸ğŸ¢

## 1) ã“ã®ç« ã§ã¤ã‹ã‚€â€œè‚Œæ„Ÿè¦šâ€ğŸ¯âœ¨

åˆ†æ•£ã®ä¸–ç•Œã§ã¯ã€**ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼å¤±æ•—ã€ã˜ã‚ƒãªã„**ã“ã¨ãŒæ™®é€šã«èµ·ãã¾ã™ğŸ˜³ğŸ’¦
ã‚€ã—ã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€ã ã„ãŸã„ã“ã†ã„ã†æ„å‘³ã§ã™ğŸ‘‡

* **ã€ŒçµæœãŒã¾ã åˆ†ã‹ã‚‰ãªã„ï¼ˆæœªç¢ºå®šï¼‰ã€**ğŸ«¥â³
* **ç›¸æ‰‹ãŒæ­»ã‚“ã ã¨ã¯é™ã‚‰ãªã„**ï¼ˆãŸã é…ã„ã ã‘ã‹ã‚‚ï¼‰ğŸ¢ğŸ’¨
* **å¾Œã‹ã‚‰æˆåŠŸãŒå±Šãã“ã¨ãŒã‚ã‚‹**ï¼ˆã„ã¡ã°ã‚“æ··ä¹±ãƒã‚¤ãƒ³ãƒˆï¼ï¼‰ğŸ­

ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯ã“ã‚ŒğŸ‘‡âœ¨
**â€œæœªç¢ºå®šâ€ã‚’ã¡ã‚ƒã‚“ã¨è¨­è¨ˆã™ã‚‹ï¼ˆä»•æ§˜ãƒ»UXãƒ»å®Ÿè£…ãƒ»é‹ç”¨ãœã‚“ã¶ï¼‰** ğŸ§©ğŸ› ï¸ğŸŒˆ

---

## 2) CampusCafeã§èµ·ãã‚‹â€œé…ã„/æ¥ãªã„â€ã‚ã‚‹ã‚ã‚‹â˜•ğŸ“±âš¡

ãŸã¨ãˆã°ã€å­¦é£Ÿãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ã§â€¦

### ã‚±ãƒ¼ã‚¹Aï¼šæ±ºæ¸ˆãŒé…ã„ï¼ˆã§ã‚‚æˆåŠŸã™ã‚‹ï¼‰ğŸ’³ğŸ¢âœ…

* æ³¨æ–‡API â†’ æ±ºæ¸ˆAPIã‚’å‘¼ã¶
* 2ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆæ³¨æ–‡ç”»é¢ã¯å¤±æ•—è¡¨ç¤ºï¼‰ğŸ˜µâ€ğŸ’«
* ã§ã‚‚æ±ºæ¸ˆå´ã¯ **5ç§’å¾Œã«æˆåŠŸ**ã—ã¦ã‚‹ï¼ˆæ±ºæ¸ˆã ã‘é€šã£ã¦ã‚‹ï¼‰ğŸ˜‡ğŸ’¦

### ã‚±ãƒ¼ã‚¹Bï¼šé€šçŸ¥ãŒæ¥ãªã„ï¼ˆå®Ÿã¯ã©ã“ã‹ã«è©°ã¾ã£ã¦ã‚‹ï¼‰ğŸ””ğŸ•³ï¸

* OrderPaid ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡ºã—ãŸ
* é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ãŒè½ã¡ã¦ã¦å‡¦ç†ã§ããªã„
* ã™ã‚‹ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ **DLQï¼ˆDead-letter queueï¼‰** ã«å…¥ã£ãŸã‚Šã™ã‚‹ğŸ“®ğŸ§Ÿâ€â™€ï¸
  ï¼ˆAzure Service Bus ã®DLQã¯ã€Œå‡¦ç†ã§ããªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é¿é›£å ´æ‰€ã€ã ã‚ˆã€œï¼‰ ([Microsoft Learn][1])

### ã‚±ãƒ¼ã‚¹Cï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒâ€œé…ã‚Œã¦â€æ¥ã‚‹ï¼ˆé †ç•ªã‚‚å´©ã‚Œã‚„ã™ã„ï¼‰ğŸ“¨ğŸ¢ğŸ”€

* åœ¨åº«ç¢ºä¿ã‚¤ãƒ™ãƒ³ãƒˆãŒé…å»¶
* å…ˆã«ã€Œæ±ºæ¸ˆå®Œäº†ã€ãŒæ¥ã¦ã€å¾Œã‹ã‚‰åœ¨åº«ãŒå‹•ãâ€¦ã¿ãŸã„ãªã“ã¨ãŒèµ·ãã‚‹ğŸ˜µâ€ğŸ’«

---

## 3) ã¾ãšè¶…é‡è¦ï¼šçµæœã¯3ç¨®é¡ã‚ã‚‹ã‚ˆğŸ§ ğŸ§Š

åˆ†æ•£ã‚ã‚‹ã‚ã‚‹ã‚’é›‘ã«ã¾ã¨ã‚ã‚‹ã¨ğŸ‘‡

* **æˆåŠŸ** âœ…
* **å¤±æ•—** âŒ
* **æœªç¢ºå®šï¼ˆUnknownï¼‰** ğŸ«¥ â† ã“ã“ãŒè¨­è¨ˆã®ä¸»å½¹ï¼

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€ãŸã„ã¦ã„ **ã€Œæœªç¢ºå®šã€** ã§ã™â±ï¸ğŸ«¥
ã“ã®â€œæœªç¢ºå®šâ€ã‚’ **å¤±æ•—æ‰±ã„** ã™ã‚‹ã¨ã€ã‚ã¨ã§åœ°ç„ãŒæ¥ã¾ã™ğŸ”¥ğŸ‘¹
ï¼ˆã€Œå¤±æ•—è¡¨ç¤ºã—ãŸã®ã«è«‹æ±‚ã¯é€šã£ã¦ã‚‹ã€ã¿ãŸã„ãªã‚„ã¤â€¦ï¼‰

---

## 4) ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®æ­£ä½“ï¼šã©ã“ã§åˆ‡ã‚Œã¦ã‚‹ï¼Ÿâ›“ï¸âœ‚ï¸

![cap_cs_study_017_timeout_unknown_state](./picture/cap_cs_study_017_timeout_unknown_state.png)

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã¯å±¤ãŒã‚ã‚‹ã‚ˆã€œğŸ§…âœ¨

### (1) ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶/ã‚¢ãƒ—ãƒªï¼‰ğŸ“±â±ï¸

UIãŒå¾…ã¡ãã‚Œãªãã¦ã€Œé€šä¿¡å¤±æ•—ã€ã«ãªã‚‹ã‚„ã¤ã€‚

### (2) ã‚µãƒ¼ãƒãƒ¼å´ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå—ä¿¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ï¼‰ğŸ–¥ï¸â³

ASP.NET Core ã«ã¯ **Request timeouts middleware** ãŒã‚ã£ã¦ã€
å…¨ä½“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ¥ã®ãƒãƒªã‚·ãƒ¼ãŒä½œã‚Œã‚‹ã‚ˆğŸ§°
ï¼ˆ`AddRequestTimeouts` ã‚„ `WithRequestTimeout` ãªã©ï¼‰ ([Microsoft Learn][2])

### (3) ã‚µãƒ¼ãƒãƒ¼â†’ä¸‹æµã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆHttpClientï¼‰ğŸŒâ±ï¸

`HttpClient.Timeout` ã®æ—¢å®šå€¤ã¯ **100ç§’**ï¼ˆæ„å¤–ã¨é•·ã„ï¼ï¼‰ ([Microsoft Learn][3])
æ”¾ç½®ã™ã‚‹ã¨ã€Œãšã£ã¨å¾…ã£ã¦è©°ã¾ã‚‹ã€ç³»ã®äº‹æ•…ãŒèµ·ãã‚„ã™ã„ğŸ˜µâ€ğŸ’«ğŸ’¦

### (4) ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®TTLï¼ˆæ™‚é–“åˆ‡ã‚Œã§æœŸé™åˆ‡ã‚Œï¼‰ğŸ“¨âŒ›

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã§ã¯ **TTLï¼ˆTime to Liveï¼‰** ãŒã‚ã£ã¦ã€æœŸé™ã‚’éãã‚‹ã¨æ¶ˆãˆãŸã‚ŠDLQã«è¡Œã£ãŸã‚Šã™ã‚‹è¨­è¨ˆã«ãªã‚‹ã‚ˆğŸ“®
ï¼ˆAzure Service Bus ã® TTL ã®èª¬æ˜ï¼‰ ([Azure æ–‡æ¡£][4])

---

## 5) è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šæœªç¢ºå®šã‚’å®‰å…¨ã«ã™ã‚‹â€œå‹â€ğŸ§©ğŸ›Ÿâœ¨

```mermaid
mindmap
  root((ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–æ”»ç•¥))
    å—ä»˜ã¨ç¢ºå®šã‚’åˆ†é›¢
      202 Acceptedã‚’è¿”ã™
      çŠ¶æ…‹ã‚’Processingã«ã™ã‚‹
    çµæœç…§ä¼šAPI
      GET /orders/id
      ãƒãƒ¼ãƒªãƒ³ã‚°/å®šæœŸå–å¾—
    UnknownçŠ¶æ…‹ã®å®šç¾©
      Unknownã‚’1ç´šå¸‚æ°‘ã«ã™ã‚‹
      æ›–æ˜§ãªã¾ã¾çŠ¶æ…‹ã‚’æŒã¤
    ã‚¤ãƒ³ãƒ•ãƒ©/ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
      IHttpClientFactory
      Polly(Retry/CircuitBreaker)
    UX/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      ã€Œå®‰å¿ƒã•ã›ã‚‹ã€æ–‡è¨€
      æ¬¡ã®è¡Œå‹•ã‚’æŒ‡ã—ç¤ºã™
```


CampusCafeã§ãŠã™ã™ã‚ã®è€ƒãˆæ–¹ã‚’ã€å®Ÿæˆ¦å¯„ã‚Šã«ã¾ã¨ã‚ã‚‹ã­ğŸ˜ŠğŸ«¶

### ãƒ‘ã‚¿ãƒ¼ãƒ³â‘ ï¼šåŒæœŸã§ç¢ºå®šã•ã›ãªã„ï¼ˆ202 Acceptedã«é€ƒãŒã™ï¼‰ğŸƒâ€â™€ï¸ğŸ’¨

**æ³¨æ–‡ã¯ã€Œå—ä»˜ã€ã ã‘å…ˆã«è¿”ã™**âœ¨

* è¿”ã™ï¼š`orderId`ã€çŠ¶æ…‹=`Processing`
* æ±ºæ¸ˆã¯è£ã§é€²ã‚ã‚‹
* ç”»é¢ã¯ã€Œå‡¦ç†ä¸­ã€ã€Œã‚ã¨ã§ç¢ºå®šã€è¡¨ç¤º

ã“ã‚Œã§ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ **â€œå¤±æ•—â€ã£ã¦è¨€ã„åˆ‡ã‚‰ãªãã¦æ¸ˆã‚€**ğŸ™†â€â™€ï¸ğŸŒ¸

### ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¡ï¼šçµæœç…§ä¼šAPIã‚’ç”¨æ„ã™ã‚‹ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°OKï¼‰ğŸ”„ğŸ“¡

`GET /orders/{orderId}` ã¿ãŸã„ã«ã—ã¦ã€çŠ¶æ…‹ã‚’å–ã‚Šã«ã„ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹âœ…
UIã¯ã€Œæœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã ã‘ã§ã‚‚å®‰å¿ƒæ„ŸãŒçˆ†ä¸ŠãŒã‚ŠğŸ’–âœ¨

### ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¢ï¼šçŠ¶æ…‹ã‚’â€œæ®µéšâ€ã«åˆ†ã‘ã‚‹ï¼ˆæ›–æ˜§ã‚’æ›–æ˜§ã®ã¾ã¾æŒã¤ï¼‰ğŸš¦

ä¾‹ğŸ‘‡

* `Accepted`ï¼ˆå—ä»˜ï¼‰ğŸ“¥
* `PaymentProcessing`ï¼ˆæ±ºæ¸ˆä¸­ï¼‰ğŸ’³
* `Paid`ï¼ˆç¢ºå®šï¼‰âœ…
* `PaymentUnknown`ï¼ˆæœªç¢ºå®šï¼‰ğŸ«¥
* `Failed`ï¼ˆç¢ºå®šå¤±æ•—ï¼‰âŒ

**Unknown ã‚’ã¡ã‚ƒã‚“ã¨çŠ¶æ…‹ã¨ã—ã¦èªã‚ã‚‹**ã®ãŒã‚³ãƒ„ã ã‚ˆã€œğŸ«¶ğŸ§ 

### ãƒ‘ã‚¿ãƒ¼ãƒ³â‘£ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€Œå¤±æ•—ã€ã˜ã‚ƒãªãã€Œä¿ç•™ã€æ‰±ã„ğŸ«¥â±ï¸

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚„ã‚‹ã¹ãã“ã¨ğŸ‘‡

* çŠ¶æ…‹ã‚’ `Unknown`ï¼ˆã¾ãŸã¯ `Processing`ï¼‰ã«ã™ã‚‹
* è£ã§ã€Œç…§åˆã€ã‚„ã€Œå†å–å¾—ã€ã‚’ã™ã‚‹
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã¯ã€Œç¢ºèªä¸­ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã™ã‚‹ğŸ’¬ğŸŒ¸

### ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¤ï¼šHttpClientã¯IHttpClientFactoryã§ç®¡ç†ï¼ˆæ¯ã‚ŒãŸç‹é“ï¼‰ğŸ—ï¸âœ¨

.NETã§ã¯ **HttpClient ã®ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰**ãŒã‚ã£ã¦ã€ä½¿ã„å›ã—/Factoryé‹ç”¨ãŒæ¨å¥¨ã ã‚ˆã€œï¼ˆãƒãƒ¼ãƒˆæ¯æ¸‡å›é¿ãªã©ï¼‰ ([Microsoft Learn][5])

### ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¥ï¼šãƒªãƒˆãƒ©ã‚¤ã¯â€œæ­£ã—ãâ€ã‚„ã‚‹ï¼ˆè€éšœå®³ã®ä½œæ³•ï¼‰ğŸ”ğŸ§ 

.NETã«ã¯å›å¾©æ€§ï¼ˆresilienceï¼‰ã®ä»•çµ„ã¿ãŒæ•´ã£ã¦ãã¦ã¦ã€`Microsoft.Extensions.Http.Resilience` / `Microsoft.Extensions.Resilience` ãŒ **Pollyãƒ™ãƒ¼ã‚¹**ã§æä¾›ã•ã‚Œã¦ã‚‹ã‚ˆğŸ§°âœ¨ ([Microsoft Learn][6])
ã•ã‚‰ã« HttpClient ã«ã¯æ¨™æº–ã®ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ãƒ»ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä»˜ã‘ã‚‰ã‚Œã¦ã€**ã‚€ã‚„ã¿ã«é‡ã­ã¦ç©ã‚€ã®ã¯é¿ã‘ã‚ˆã†**ã£ã¦ã‚¬ã‚¤ãƒ‰ã‚‚ã‚ã‚‹ã‚ˆâœ… ([Microsoft Learn][7])

> ãŸã ã—æ³¨æ„âš ï¸
> ãƒªãƒˆãƒ©ã‚¤ã¯ã€ŒåŒã˜å‡¦ç†ãŒ2å›èµ·ãã‚‹ã€ä¸–ç•Œã¨ã‚»ãƒƒãƒˆãªã®ã§ã€**å†ªç­‰æ€§ï¼ˆæ¬¡ç« ä»¥é™ï¼‰**ã¨ä¸€ç·’ã«è¨­è¨ˆã™ã‚‹ã®ãŒå‰æã ã‚ˆğŸ›¡ï¸ğŸ”‘

---

## 6) UXã®å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«â€œå®‰å¿ƒâ€ã‚’ä½œã‚‹ğŸ’¬ğŸŒ¸âœ¨

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚ã¡ã‚ƒä¸å®‰ã«ãªã‚Šã¾ã™ğŸ¥ºğŸ’¦
ã ã‹ã‚‰ã€Œè¨€ã„æ–¹ã€ã§æ•‘ãˆã‚‹ã‚ˆã€œğŸ«¶

### ä½¿ã„ã‚„ã™ã„æ–‡è¨€ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆä¾‹ï¼‰ğŸ“âœ¨

* ã€ŒãŸã ã„ã¾ç¢ºèªä¸­ã§ã™ã€‚çµæœãŒç¢ºå®šã—ãŸã‚‰åæ˜ ã—ã¾ã™ã€ğŸ«¥âœ…
* ã€Œé€šä¿¡ãŒæ··ã¿åˆã£ã¦ã„ã¾ã™ã€‚æ³¨æ–‡ã®å—ä»˜ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€ğŸ“¥ğŸ¢
* ã€Œæ±ºæ¸ˆã®ç¢ºå®šã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å±¥æ­´ã§çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã™ã€ğŸ’³ğŸ“œ
* ã€ŒäºŒé‡æ³¨æ–‡ã‚’é˜²ããŸã‚ã€åŒã˜æ“ä½œã¯ç¹°ã‚Šè¿”ã•ãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€ğŸ›¡ï¸âœ¨

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡

* **å¤±æ•—ã¨è¨€ã„åˆ‡ã‚‰ãªã„**ï¼ˆæœªç¢ºå®šã ã‹ã‚‰ï¼‰ğŸ«¥
* **æ¬¡ã«ä½•ã‚’ã™ã‚Œã°ã„ã„ã‹**ã‚’å¿…ãšæ›¸ãğŸ§­âœ¨
* **äºŒé‡æ“ä½œã—ãªãã¦ã„ã„**å®‰å¿ƒã‚’å‡ºã™ğŸ›¡ï¸ğŸ’–

---

## 7) ãƒŸãƒ‹æ¼”ç¿’ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã®ã«â€œå¾Œã‹ã‚‰æˆåŠŸâ€ã‚’è¦³å¯Ÿã™ã‚‹â±ï¸ğŸ˜³ğŸ”¬

ã“ã“ã‹ã‚‰å®Ÿé¨“ã ã‚ˆã€œï¼âœ¨
**ã€Œæ³¨æ–‡APIã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ‰±ã„ã€‚ã§ã‚‚æ±ºæ¸ˆã¯å¾Œã‹ã‚‰æˆåŠŸã—ã¦ã‚‹ã€**ã‚’ã€ç›®ã§è¦‹ã¦ç´å¾—ã—ã‚ˆã†ğŸ‘€ğŸ’¡

### 7.1 ã‚„ã‚‹ã“ã¨ï¼ˆå®Œæˆå½¢ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ğŸ§©

* `POST /orders/place?delayMs=5000&timeoutMs=2000`

  * æ³¨æ–‡APIã¯ 2ç§’ã§è«¦ã‚ã‚‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›¸å½“ï¼‰â±ï¸
* ã§ã‚‚è£ã§æ±ºæ¸ˆAPIã¯ 5ç§’ã‹ã‘ã¦å‡¦ç†ã—ã¦ **æˆåŠŸã«ã™ã‚‹**ğŸ¢âœ…
* `GET /orders/{orderId}` ã§çŠ¶æ…‹ã‚’è¦‹ã‚‹ã¨
  **æœ€åˆã¯ Timeout/Unknown â†’ æ•°ç§’å¾Œã« Paid** ã«å¤‰ã‚ã‚‹ğŸ˜³âœ¨

### 7.2 Program.csï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿé¨“ï¼‰ğŸ§ª

```csharp
using System.Collections.Concurrent;
using System.Net;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

// HttpClient ã¯ Factory çµŒç”±ã§ä½¿ã†ï¼ˆç‹é“ï¼‰
// ã“ã“ã§ã¯åŒä¸€ã‚¢ãƒ—ãƒªå†…ã® "fake-payments" ã‚’å©ããŸã‚ BaseAddress ã‚’è‡ªåˆ†ã«å‘ã‘ã‚‹
builder.Services.AddHttpClient("Payments", client =>
{
    // å®Ÿè¡Œãƒ­ã‚°ã«å‡ºã‚‹URL(https://localhost:xxxx)ã«åˆã‚ã›ã¦å¾Œã§ä¸Šæ›¸ãã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    client.Timeout = Timeout.InfiniteTimeSpan; // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ CancellationToken å´ã§ç®¡ç†ã™ã‚‹
});

var app = builder.Build();
app.UseSwagger();
app.UseSwaggerUI();

// --- ã‹ã‚“ãŸã‚“çŠ¶æ…‹ã‚¹ãƒˆã‚¢ï¼ˆæœ¬ç•ªã¯DBæƒ³å®šï¼‰ ---
var orders = new ConcurrentDictionary<Guid, Order>();

app.MapPost("/orders/place", async (HttpContext ctx, IHttpClientFactory factory, int delayMs = 5000, int timeoutMs = 2000) =>
{
    var orderId = Guid.NewGuid();
    orders[orderId] = new Order(orderId, "PaymentProcessing", DateTimeOffset.UtcNow, null);

    // ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªä½“ãŒåˆ‡ã‚ŒãŸã‚‰æ­¢ã‚ãŸã„ã®ã§ RequestAborted ã¨ãƒªãƒ³ã‚¯ã™ã‚‹
    // ã•ã‚‰ã«ã€Œä¸‹æµå‘¼ã³å‡ºã—ã®äºˆç®—ã€ã¨ã—ã¦ timeoutMs ã‚’è¨­å®š
    using var cts = CancellationTokenSource.CreateLinkedTokenSource(ctx.RequestAborted);
    cts.CancelAfter(TimeSpan.FromMilliseconds(timeoutMs));

    // å®Ÿé¨“ã®ãŸã‚ï¼šåŒä¸€ã‚¢ãƒ—ãƒªå†…ã® fake-payments ã‚’å©ã
    // Host(ãƒãƒ¼ãƒˆ)ã¯å®Ÿè¡Œç’°å¢ƒã§å¤‰ã‚ã‚‹ã®ã§ã€å®Ÿéš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® Host ã‚’ä½¿ã†
    var baseUrl = $"{ctx.Request.Scheme}://{ctx.Request.Host}";
    var client = factory.CreateClient("Payments");
    client.BaseAddress = new Uri(baseUrl);

    try
    {
        // ã‚ã–ã¨é…ã„æ±ºæ¸ˆï¼ˆdelayMsï¼‰ã‚’å‘¼ã¶
        var url = $"/fake-payments/charge?orderId={orderId}&delayMs={delayMs}";
        var res = await client.GetAsync(url, cts.Token);

        if (res.IsSuccessStatusCode)
        {
            orders[orderId] = orders[orderId] with { Status = "Paid", PaidAt = DateTimeOffset.UtcNow };
            return Results.Ok(new { orderId, status = "Paid" });
        }

        orders[orderId] = orders[orderId] with { Status = $"PaymentFailed({(int)res.StatusCode})" };
        return Results.Problem("Payment failed", statusCode: (int)HttpStatusCode.BadGateway);
    }
    catch (TaskCanceledException)
    {
        // ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ = å¤±æ•—ç¢ºå®š ã§ã¯ãªãã€Œæœªç¢ºå®šã€
        orders[orderId] = orders[orderId] with { Status = "PaymentUnknown(Timeout)" };

        // UXçš„ã«ã¯ã€Œå—ä»˜ã¯ã—ãŸã€æ–¹ãŒå„ªã—ã„ã®ã§ 202 ã‚’è¿”ã™
        return Results.Accepted($"/orders/{orderId}", new
        {
            orderId,
            status = "PaymentUnknown(Timeout)",
            message = "æ±ºæ¸ˆã®ç¢ºå®šã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚æ³¨æ–‡å±¥æ­´ã§çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚"
        });
    }
});

app.MapGet("/orders/{orderId:guid}", (Guid orderId) =>
{
    if (!orders.TryGetValue(orderId, out var order))
        return Results.NotFound(new { message = "Order not found" });

    return Results.Ok(order);
});

// --- é…ã„æ±ºæ¸ˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ ---
// é‡è¦ï¼šã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆRequestAbortedï¼‰ã‚’ç„¡è¦–ã—ã¦æœ€å¾Œã¾ã§èµ°ã‚‹ã€‚
// ç¾å®Ÿã§ã‚‚ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒè«¦ã‚ã¦ã‚‚ç›¸æ‰‹å´ã¯å‡¦ç†ç¶™ç¶šã€ãŒèµ·ãã‚‹ã®ã§ã€ãã‚Œã‚’å†ç¾ã—ã¦ã‚‹ã‚ˆã€‚
app.MapGet("/fake-payments/charge", async (Guid orderId, int delayMs = 5000) =>
{
    await Task.Delay(delayMs); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„ï¼ˆã‚ã–ã¨ï¼‰

    // æ±ºæ¸ˆãŒå¾Œã‹ã‚‰æˆåŠŸã™ã‚‹ï¼ˆï¼æ³¨æ–‡å´ã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ¸ˆã¿ã§ã‚‚ã€çµæœã¯ç¢ºå®šã—ã¦ã„ãï¼‰
    if (orders.TryGetValue(orderId, out var order))
        orders[orderId] = order with { Status = "Paid", PaidAt = DateTimeOffset.UtcNow };

    return Results.Ok(new { orderId, status = "Paid", tookMs = delayMs });
});

app.Run();

public record Order(Guid OrderId, string Status, DateTimeOffset CreatedAt, DateTimeOffset? PaidAt);
```

**ã“ã“ã§ä½¿ã£ã¦ã‚‹çŸ¥è­˜ãƒ¡ãƒ¢**ğŸ“âœ¨

* `CancelAfter` ã§ã€ŒæŒ‡å®šæ™‚é–“ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’ä½œã‚Œã‚‹ã‚ˆ ([Microsoft Learn][8])
* `HttpClient.Timeout` ã®æ—¢å®šã¯ 100ç§’ãªã®ã§ã€æ”¾ç½®ã™ã‚‹ã¨é•·ãå¾…ã¡ãŒã¡ã ã‚ˆ ([Microsoft Learn][3])

### 7.3 å‹•ã‹ã—ã¦è¦³å¯Ÿã—ã‚ˆã†ğŸ‘€âœ¨

1. èµ·å‹•ã—ã¦ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºã‚‹ `https://localhost:xxxx` ã‚’æ§ãˆã‚‹ğŸ“
2. ã¾ãšã¯æ³¨æ–‡ï¼ˆã‚ã–ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ğŸ‘‡

PowerShell ä¾‹ï¼š

```powershell
$base="https://localhost:####"  # å®Ÿéš›ã®ãƒãƒ¼ãƒˆã«ç½®ãæ›ãˆ
Invoke-RestMethod -Method Post "$base/orders/place?delayMs=5000&timeoutMs=2000"
```

è¿”ã£ã¦ãã‚‹ã®ã¯ã ã„ãŸã„ã“ã‚“ãªæ„Ÿã˜ï¼ˆ202ï¼‰ğŸ‘‡

* `status = PaymentUnknown(Timeout)` ğŸ«¥â±ï¸
* `orderId` ãŒã‚‚ã‚‰ãˆã‚‹ğŸ†”âœ¨

3. ã™ãã«çŠ¶æ…‹ã‚’è¦‹ã‚‹ğŸ‘‡

```powershell
Invoke-RestMethod "$base/orders/<orderId>"
```

æœ€åˆï¼š`PaymentUnknown(Timeout)` ğŸ«¥â±ï¸
æ•°ç§’å¾…ã£ã¦ã‚‚ã†ä¸€å›ï¼š`Paid` âœ…ğŸ‰
â†’ **ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã®ã«å¾Œã‹ã‚‰æˆåŠŸã€ãŒç›®ã§è¦‹ãˆã‚‹ï¼** ğŸ˜³âœ¨

---

## 8) â€œæ¥ãªã„â€ä¸–ç•Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­è¨ˆï¼šDLQã¨TTLã®è‚Œæ„Ÿè¦šğŸ“¨ğŸ§Ÿâ€â™€ï¸âŒ›

HTTPã ã‘ã˜ã‚ƒãªãã€ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã§ã‚‚ã€Œæ¥ãªã„/é…ã„ã€ã¯èµ·ãã‚‹ã‚ˆã€œğŸ“¨ğŸ¢

### DLQï¼ˆDead-letter queueï¼‰ã£ã¦ï¼ŸğŸ“®

ã€Œé…ã‚Œãªã„ã€ã€Œå‡¦ç†ã§ããªã„ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš”é›¢ã—ã¦ç½®ã„ã¦ãŠãç®±ã ã‚ˆğŸ§°
å¾Œã§èª¿æŸ»ã—ã¦ã€å¿…è¦ãªã‚‰å†æŠ•å…¥ã§ãã‚‹è¨­è¨ˆã«ã™ã‚‹ã®ãŒç‹é“âœ¨ ([Microsoft Learn][1])

### TTLï¼ˆTime to Liveï¼‰ã£ã¦ï¼ŸâŒ›

ã€Œã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã„ã¤ã¾ã§æœ‰åŠ¹ï¼Ÿã€ã®æœŸé™ã ã‚ˆğŸ“…
æœŸé™ãŒéããŸã‚‰â€œæœŸé™åˆ‡ã‚Œâ€ã«ãªã‚‹ï¼ˆè¨­è¨ˆã§æ‰±ã„ã‚’æ±ºã‚ã‚‹ï¼‰ ([Azure æ–‡æ¡£][4])

### é‹ç”¨ã®ç¾å®Ÿï¼šDLQæƒé™¤ã‚‚å¿…è¦ğŸ§¹

Azure Service Bus ã«ã¯ã€DLQå†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹é‹ç”¨ï¼ˆãƒãƒƒãƒå‰Šé™¤ï¼‰ã‚‚ç”¨æ„ã•ã‚Œã¦ã‚‹ã‚ˆğŸ§¹ğŸ—‘ï¸ ([Microsoft Learn][9])

---

## 9) AIæ´»ç”¨ï¼ˆCopilot / Codexï¼‰ğŸ¤–âœ¨

â€œæœªç¢ºå®šâ€ã¯ä»•æ§˜ã¨æ–‡è¨€ãŒè¶…å¤§äº‹ãªã®ã§ã€AIãŒã‚ã¡ã‚ƒå½¹ç«‹ã¤ã‚ˆã€œğŸ«¶

### 9.1 ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®UXæ–‡è¨€ã‚’ä½œã£ã¦ã‚‚ã‚‰ã†ğŸ’¬ğŸŒ¸

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼š**

* ã€Œå­¦é£Ÿãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ã§ã€æ±ºæ¸ˆãŒæœªç¢ºå®šã®ã¨ãã®ç”»é¢æ–‡è¨€ã‚’10æ¡ˆã€‚å®‰å¿ƒæ„Ÿã€äºŒé‡æ“ä½œé˜²æ­¢ã€æ¬¡ã®è¡Œå‹•ï¼ˆå±¥æ­´ã§ç¢ºèªï¼‰ã‚’å¿…ãšå…¥ã‚Œã¦ã€

### 9.2 â€œæœªç¢ºå®šâ€ã®çŠ¶æ…‹é·ç§»æ¡ˆã‚’ä½œã£ã¦ã‚‚ã‚‰ã†ğŸš¦ğŸ§ 

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼š**

* ã€ŒOrderã®çŠ¶æ…‹é·ç§»ã‚’ææ¡ˆã—ã¦ã€‚Accepted / PaymentProcessing / Paid / PaymentUnknown / Failed ã‚’å«ã‚ã¦ã€å„çŠ¶æ…‹ã®æ„å‘³ã¨é·ç§»æ¡ä»¶ã‚‚ã€

### 9.3 HttpClientã®å›å¾©æ€§ï¼ˆtimeout/retryï¼‰æ–¹é‡ã‚’è‰æ¡ˆã«ã—ã¦ã‚‚ã‚‰ã†ğŸ§°ğŸ”

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼š**

* ã€Œä¸‹æµæ±ºæ¸ˆAPIãŒé…ã„/è½ã¡ã‚‹å‰æã§ã€.NETã®HttpClientå›å¾©æ€§ã®æ–¹é‡æ¡ˆã‚’ä½œã£ã¦ã€‚Retry/Timeout/CircuitBreakerã®å½¹å‰²åˆ†æ‹…ã¨æ³¨æ„ç‚¹ï¼ˆå†ªç­‰æ€§ï¼‰ã‚‚ã€

ï¼ˆ.NETã§ã¯ Polly ãƒ™ãƒ¼ã‚¹ã®å›å¾©æ€§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¬å¼ã«æ•´å‚™ã•ã‚Œã¦ã‚‹ã‚ˆï¼‰ ([Microsoft Learn][6])

---

## 10) ã¾ã¨ã‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ§¾âœ¨

ã“ã®ç« ã®â€œã§ãã¦ã‚‹ï¼Ÿâ€ç¢ºèªã ã‚ˆã€œğŸ˜ŠğŸ«¶

* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ **å¤±æ•—ç¢ºå®š** ã¨æ‰±ã£ã¦ãªã„ï¼ŸğŸ«¥â±ï¸
* â€œæœªç¢ºå®šï¼ˆUnknownï¼‰â€ã‚’ **çŠ¶æ…‹ã¨ã—ã¦æŒã¦ã¦ã‚‹ï¼Ÿ** ğŸš¦
* UIã¯ã€Œæ¬¡ã«ä½•ã‚’ã™ã‚Œã°ã„ã„ã‹ã€ã‚’è¨€ãˆã¦ã‚‹ï¼ŸğŸ’¬ğŸ§­
* çµæœç…§ä¼šï¼ˆ`GET /orders/{id}`ï¼‰ãŒã‚ã‚‹ï¼ŸğŸ”„
* HttpClientã¯Factoryé‹ç”¨ï¼†å¾…ã¡ã™ããªã„è¨­è¨ˆï¼ŸğŸ—ï¸ ([Microsoft Learn][5])
* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã¯DLQ/TTLã‚’å‰æã«è¨­è¨ˆã§ãã¦ã‚‹ï¼ŸğŸ“®âŒ› ([Microsoft Learn][1])

æ¬¡ã®ç« ã§ã¯ã€ã“ã®ã€Œæœªç¢ºå®šã€ã‚„ã€Œãƒªãƒˆãƒ©ã‚¤ã€ãŒå¼•ãèµ·ã“ã™ **äºŒé‡é©ç”¨** ã‚’ã€å†ªç­‰æ€§ã§æ­¢ã‚ã¦ã„ãã‚ˆã€œğŸ›¡ï¸ğŸ”‘âœ¨

[1]: https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dead-letter-queues?utm_source=chatgpt.com "Service Bus dead-letter queues - Azure"
[2]: https://learn.microsoft.com/en-us/aspnet/core/performance/timeouts?view=aspnetcore-10.0 "Request timeouts middleware in ASP.NET Core | Microsoft Learn"
[3]: https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpclient.timeout?view=net-10.0&utm_source=chatgpt.com "HttpClient.Timeout Property (System.Net.Http)"
[4]: https://docs.azure.cn/en-us/service-bus-messaging/message-expiration?utm_source=chatgpt.com "Azure Service Bus - Message expiration (Time to Live)"
[5]: https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/http/httpclient-guidelines?utm_source=chatgpt.com "Guidelines for using HttpClient"
[6]: https://learn.microsoft.com/en-us/dotnet/core/resilience/?utm_source=chatgpt.com "Introduction to resilient app development - .NET"
[7]: https://learn.microsoft.com/en-us/dotnet/core/resilience/http-resilience "Build resilient HTTP apps: Key development patterns - .NET | Microsoft Learn"
[8]: https://learn.microsoft.com/en-us/dotnet/csharp/asynchronous-programming/cancel-async-tasks-after-a-period-of-time?utm_source=chatgpt.com "Cancel async tasks after a period of time\" - C#"
[9]: https://learn.microsoft.com/en-us/azure/service-bus-messaging/batch-delete?utm_source=chatgpt.com "Batch delete messages in Azure Service Bus (Preview)"
