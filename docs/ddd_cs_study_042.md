# ç¬¬42ç« ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹âœ¨

![ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã®å½¹å‰²](./picture/ddd_cs_study_042_domain_service.png)

**ã€œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æŒãŸã›ã‚‹ã¨ä¸è‡ªç„¶ãªè¨ˆç®—ã®â€œç½®ãå ´æ‰€â€ã€œ** ğŸ§ ğŸ’¡

---

## 1. ã¾ãšçµè«–ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã£ã¦ãªã«ï¼ŸğŸ¤”

**ã€Œã“ã®ãƒ«ãƒ¼ãƒ«ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆä¾‹ï¼šOrderï¼‰ã«å…¥ã‚Œã‚‹ã¨å¤‰â€¦ã€**ã£ã¦æ™‚ã«ä½¿ã†ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®â€œè¨ˆç®—ä¿‚â€**ã§ã™ğŸ’ªâœ¨

* ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚„å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å…¥ã‚Œã‚‹ã¨ **å½¹å‰²ãŒä¸è‡ªç„¶**ã«ãªã‚‹
* ã§ã‚‚ã€ãƒ“ã‚¸ãƒã‚¹çš„ã«ã¯ **è¶…é‡è¦ãªãƒ«ãƒ¼ãƒ«**
* ã ã‹ã‚‰ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã„ã†â€œå½¢â€ã§ **ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã«ç½®ã** ğŸ§º

> ã–ã£ãã‚Šè¨€ã†ã¨ï¼š
> **ã€Œä¸»å½¹ï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰ã˜ã‚ƒãªã„ã‘ã©ã€ç‰©èªã®ãƒ«ãƒ¼ãƒ«ã‚’æ¡ã£ã¦ã‚‹äººã€**ã§ã™ğŸ“šâœ¨

![ddd_cs_study_042_referee.png](./picture/ddd_cs_study_042_referee.png)

---

## 2. â€œã‚µãƒ¼ãƒ“ã‚¹â€ã£ã¦èãã¨æ··ä¹±ã—ãŒã¡ãƒã‚¤ãƒ³ãƒˆğŸ˜µâ€ğŸ’«

![ddd_cs_study_042_service_counters.png](./picture/ddd_cs_study_042_service_counters.png)

DDDã«ã¯ â€œã‚µãƒ¼ãƒ“ã‚¹â€ ãŒ3ç¨®é¡ãã‚‰ã„å‡ºã¦ãã¾ã™ã€‚ã¾ãšæ•´ç†ã—ã‚ˆã€œï¼ğŸ§¹âœ¨

* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹**ï¼šãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãã®ã‚‚ã® âœ…ï¼ˆä»Šå›ï¼‰
* **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹**ï¼šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®æ‰‹é †ä¿‚ï¼ˆç™»éŒ²â†’ä¿å­˜â†’é€šçŸ¥â€¦ï¼‰ğŸ§‘â€ğŸ³
* **ã‚¤ãƒ³ãƒ•ãƒ©ã‚µãƒ¼ãƒ“ã‚¹**ï¼šDBã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€å¤–éƒ¨APIãªã©ã®æŠ€è¡“ä¿‚ ğŸ› ï¸

ã“ã®ç« ã®ä¸»å½¹ã¯ **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹**ãªã®ã§ã€
**ã€ŒDBã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ï¼ˆã•ã›ãªã„ï¼‰ã€**æ–¹å‘ã§è¦šãˆã‚‹ã¨è¿·ã„ã«ãã„ã‚ˆğŸ™†â€â™€ï¸âœ¨

---

## 3. ã„ã¤ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†ã®ï¼ŸğŸ§­âœ¨

åˆ¤æ–­ã¯ã“ã‚Œã ã‘ã§OKï¼ğŸ‘‡

### âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã«å‘ã„ã¦ã‚‹ã‚±ãƒ¼ã‚¹

* **è¤‡æ•°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ãŸãŒã‚‹ãƒ«ãƒ¼ãƒ«**ï¼ˆOrderã ã‘ã®è²¬ä»»ã«ã—ã«ãã„ï¼‰
* **â€œå‹•è©â€ã£ã½ã„å‡¦ç†**ï¼ˆCalculate / Decide / Judge / Allocateâ€¦ï¼‰
* ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å…¥ã‚Œã‚‹ã¨
  ã€Œãˆã€Orderã•ã‚“ãã‚ŒçŸ¥ã£ã¦ã‚‹ã®æ°—æŒã¡æ‚ªããªã„ï¼Ÿã€ã£ã¦ãªã‚‹ã‚„ã¤ğŸ˜‡

### âŒ ã‚„ã‚ŠãŒã¡ãªç½ 

* ãªã‚“ã§ã‚‚ã‹ã‚“ã§ã‚‚ã‚µãƒ¼ãƒ“ã‚¹ã«å…¥ã‚Œã¦ **â€œç¥ã‚¯ãƒ©ã‚¹â€åŒ–** ğŸ‘¿

![ddd_cs_study_042_god_class.png](./picture/ddd_cs_study_042_god_class.png)
  â†’ çµå±€ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£ã®è¦ªç‰ã«ãªã‚Šã¾ã™ğŸğŸ’¥

```mermaid
flowchart TD
    Start["ã“ã®å‡¦ç†ã©ã“ç½®ãï¼ŸğŸ¤”"] --> Q1{"1ã¤ã®Entityã ã‘ã§<br/>å®Œçµã™ã‚‹ï¼Ÿ"}
    Q1 -- Yes --> Entity["Entity / ValueObject<br/>ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã™ã‚‹ âœ…"]
    Q1 -- No --> Q2{"è¨ˆç®—ã‚„åˆ¤æ–­ãŒå¿…è¦ï¼Ÿ<br/>(å‹•è©ã£ã½ã„ï¼Ÿ)"}
    
    Q2 -- Yes --> DS["Domain Service ğŸ§ <br/>(è¨ˆç®—ä¿‚)"]
    Q2 -- No --> App["Application Service ğŸ®<br/>(é€²è¡Œä¿‚)"]
```

---

## 4. ä¾‹ã§ç†è§£ã—ã‚ˆã†ï¼šå‰²å¼•è¨ˆç®—ğŸ’¸âœ¨ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹å‘ãï¼ï¼‰

### ğŸ€çŠ¶æ³

ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—ã§ã€åˆè¨ˆé‡‘é¡ã‚’å‡ºã—ãŸã„ï¼ğŸ›’
ãŸã ã—å‰²å¼•ãƒ«ãƒ¼ãƒ«ãŒã‚„ã‚„ã“ã—ã„ï¼š

* ä¼šå“¡ãƒ©ãƒ³ã‚¯ã§å‰²å¼•ç‡ãŒé•ã† ğŸ“
* ã‚¯ãƒ¼ãƒãƒ³ãŒã‚ã‚‹ã¨ã•ã‚‰ã«å‰²å¼• ğŸŸï¸
* ã‚»ãƒ¼ãƒ«æœŸé–“ä¸­ã¯è¿½åŠ å‰²å¼• ğŸ‰

ã“ã‚Œã€`Order` ã«å…¨éƒ¨å…¥ã‚Œã‚‹ã¨â€¦

* `Order` ãŒ **ä¼šå“¡ãƒ©ãƒ³ã‚¯**ã‚’çŸ¥ã£ã¦ã‚‹ï¼Ÿ
* `Order` ãŒ **ã‚¯ãƒ¼ãƒãƒ³**ã‚„**ã‚»ãƒ¼ãƒ«æœŸé–“**ã‚’çŸ¥ã£ã¦ã‚‹ï¼Ÿ
* ãªã‚“ã‹ **ä¸–ç•Œè¦³ãŒå´©ã‚Œã‚‹** ğŸ˜µâ€ğŸ’«

ãªã®ã§ã€**ä¾¡æ ¼è¨ˆç®—ã®å°‚é–€å®¶**ã¨ã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹ï¼ğŸ’ªâœ¨

![ddd_cs_study_042_calculator_robot.png](./picture/ddd_cs_study_042_calculator_robot.png)

---

## 5. å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ï¼ˆæœ€å°æ§‹æˆï¼‰ğŸ‘©â€ğŸ’»âœ¨

### 5-1. å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼šMoneyï¼ˆè¶…ã–ã£ãã‚Šç‰ˆï¼‰ğŸ’°

```csharp
public readonly record struct Money(decimal Amount)
{
    public Money
    {
        if (Amount < 0) throw new ArgumentOutOfRangeException(nameof(Amount));
    }

    public static Money operator +(Money a, Money b) => new(a.Amount + b.Amount);
    public static Money operator -(Money a, Money b) => new(a.Amount - b.Amount);
    public Money Multiply(decimal rate) => new(Amount * rate);
}
```

### 5-2. ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼šOrderï¼ˆåˆè¨ˆâ€œå‰â€ã®ææ–™ã ã‘æŒã¤ï¼‰ğŸ§¾

```csharp
public sealed class Order
{
    private readonly List<OrderLine> _lines = new();
    public IReadOnlyList<OrderLine> Lines => _lines;

    public void AddLine(string productName, Money unitPrice, int quantity)
    {
        if (quantity <= 0) throw new ArgumentOutOfRangeException(nameof(quantity));
        _lines.Add(new OrderLine(productName, unitPrice, quantity));
    }

    public Money Subtotal()
    {
        Money total = new(0);
        foreach (var line in _lines)
        {
            total += line.UnitPrice.Multiply(line.Quantity);
        }
        return total;
    }
}

public sealed record OrderLine(string ProductName, Money UnitPrice, int Quantity);
```

### 5-3. â€œãƒ«ãƒ¼ãƒ«æ‹…å½“â€ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ï¼šPricingService ğŸ§ âœ¨

```csharp
public enum MemberRank { Normal, Student, Premium }

public sealed record Coupon(decimal DiscountRate); // ä¾‹: 0.10m ã§10%OFF

public sealed class PricingService
{
    public Money CalculateTotal(Order order, MemberRank rank, Coupon? coupon, DateOnly today)
    {
        var subtotal = order.Subtotal();

        var rankRate = rank switch
        {
            MemberRank.Normal  => 1.00m,
            MemberRank.Student => 0.95m, // 5%OFF
            MemberRank.Premium => 0.90m, // 10%OFF
            _ => 1.00m
        };

        var afterRank = subtotal.Multiply(rankRate);

        // ã‚»ãƒ¼ãƒ«æœŸé–“ï¼ˆä¾‹ï¼š12/20ã€œ12/31 ã¯ã•ã‚‰ã« 5%OFFï¼‰
        var isSale = today is { Month: 12 } && today.Day >= 20 && today.Day <= 31;
        var saleRate = isSale ? 0.95m : 1.00m;

        var afterSale = afterRank.Multiply(saleRate);

        // ã‚¯ãƒ¼ãƒãƒ³ï¼ˆã•ã‚‰ã«å‰²å¼•ï¼‰
        var couponRate = coupon is null ? 1.00m : (1.00m - coupon.DiscountRate);
        var total = afterSale.Multiply(couponRate);

        // å¿µã®ãŸã‚è² ã«ãªã‚‰ãªã„ã‚ˆã†ã«ï¼ˆãƒ«ãƒ¼ãƒ«æ¬¡ç¬¬ï¼‰
        if (total.Amount < 0) total = new Money(0);

        return total;
    }
}
```

ğŸ‰ãƒã‚¤ãƒ³ãƒˆï¼

* `Order` ã¯ **â€œæ³¨æ–‡ã®ä¸­èº«â€**ã«é›†ä¸­
* ä¾¡æ ¼è¨ˆç®—ã®ãƒ«ãƒ¼ãƒ«ã¯ **PricingService** ã«é›†ä¸­
* ãƒ«ãƒ¼ãƒ«å¤‰æ›´ãŒæ¥ã¦ã‚‚ã€Œã“ã“ç›´ã›ã°OKã€ã«ãªã‚Šã‚„ã™ã„âœ¨

---

## 6. ã˜ã‚ƒã‚ `Order` ã«å…¥ã‚Œã¡ã‚ƒãƒ€ãƒ¡ãªã®ï¼ŸğŸ™…â€â™€ï¸

ãƒ€ãƒ¡ã˜ã‚ƒãªã„ã‚ˆï¼â˜ºï¸
**è‡ªç„¶ãªã‚‰å…¥ã‚Œã¦OK**ã§ã™âœ…

### âœ… `Order` ã«å…¥ã‚Œã¦è‡ªç„¶ãªä¾‹

* `AddLine()`ï¼ˆæ³¨æ–‡ã®ä¸­èº«ã‚’å¢—ã‚„ã™ï¼‰
* `Subtotal()`ï¼ˆæ³¨æ–‡è‡ªèº«ã®æƒ…å ±ã ã‘ã§å‡ºã›ã‚‹ï¼‰

### âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãŒè‡ªç„¶ãªä¾‹

* ä¼šå“¡ãƒ©ãƒ³ã‚¯ãƒ»ã‚¯ãƒ¼ãƒãƒ³ãƒ»æœŸé–“ãªã© **æ³¨æ–‡ä»¥å¤–ã®ä¸–ç•Œã®æƒ…å ±**ãŒå¿…è¦
* â€œä¾¡æ ¼è¨ˆç®—â€ã¨ã„ã† **å°‚é–€è·**ã£ã½ã„è²¬å‹™

---

## 7. è¿·ã‚ãªã„ãŸã‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…âœ¨

![ddd_cs_study_042_sorting_machine.png](./picture/ddd_cs_study_042_sorting_machine.png)

æ¬¡ã®è³ªå•ã«ã€Œã†ã‚“â€¦ã€ã¨ãªã£ãŸã‚‰ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹å€™è£œã ã‚ˆğŸ’¡

* ãã®å‡¦ç†ã€**è¤‡æ•°ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã«é–¢ä¿‚ã—ã¦ã‚‹ï¼ŸğŸ¤
* ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«å…¥ã‚Œã‚‹ã¨ã€**ãªã‚“ã‹ä¸è‡ªç„¶**ï¼ŸğŸ˜‡
* ãã®å‡¦ç†ã€åå‰ãŒ **å‹•è©ï¼ˆCalculate / Decideï¼‰**ã£ã½ã„ï¼ŸğŸƒâ€â™€ï¸
* å¤‰æ›´ã•ã‚Œãã†ãª **é‡è¦ãƒ«ãƒ¼ãƒ«**ï¼ŸğŸ”

---

## 8. AIã«æ‰‹ä¼ã‚ã›ã‚‹ã¨çˆ†é€Ÿâš¡ğŸ¤–âœ¨

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€AIã«â€œãƒ«ãƒ¼ãƒ«æ•´ç†â€ã‚’é ¼ã‚€ã¨ã‚ã¡ã‚ƒæ¥½ï¼ğŸ’•

### ä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼ˆã‚³ãƒ”ãƒšOKï¼‰ğŸ“

```text
ã‚ãªãŸã¯DDDã®è¨­è¨ˆè€…ã§ã™ã€‚
ã€Œåˆè¨ˆé‡‘é¡ã®è¨ˆç®—ãƒ«ãƒ¼ãƒ«ã€ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦è¨­è¨ˆã—ãŸã„ã§ã™ã€‚

æ¡ä»¶ï¼š
- Orderã¯æ³¨æ–‡è¡Œï¼ˆå•†å“åã€å˜ä¾¡ã€æ•°é‡ï¼‰ã ã‘ã‚’æŒã¤
- ä¼šå“¡ãƒ©ãƒ³ã‚¯å‰²å¼•ã€ã‚»ãƒ¼ãƒ«æœŸé–“å‰²å¼•ã€ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•ãŒã‚ã‚‹
- DBã‚¢ã‚¯ã‚»ã‚¹ã‚„å¤–éƒ¨I/Oã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã«å…¥ã‚Œãªã„

ãŠé¡˜ã„ï¼š
1) ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã®è²¬å‹™ã‚’1æ–‡ã§
2) ãƒ¡ã‚½ãƒƒãƒ‰ã‚·ã‚°ãƒãƒãƒ£æ¡ˆï¼ˆå¼•æ•°ã¨æˆ»ã‚Šå€¤ï¼‰
3) å¢ƒç•Œæ¡ä»¶ï¼ˆå‰²å¼•ãŒé‡ãªã‚Šã™ãã‚‹ã€0å††æœªæº€ãªã©ï¼‰
4) xUnitã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’5ã¤
```

AIãŒå‡ºã—ãŸæ¡ˆã‚’è¦‹ã¦ã€ã‚ãªãŸã¯
**ã€Œå¢ƒç•Œæ¡ä»¶ã€ã ã‘æœ€çµ‚åˆ¤æ–­**ã™ã‚Œã°OKã«ãªã‚Šã‚„ã™ã„ã‚ˆâœ¨ğŸ§ 

---

## 9. ãƒŸãƒ‹æ¼”ç¿’ğŸ¯âœ¨

PricingServiceã«ãƒ«ãƒ¼ãƒ«ã‚’1å€‹è¶³ã—ã¦ã¿ã‚ˆã†ï¼

### ãŠé¡Œï¼šé€æ–™ç„¡æ–™ğŸššğŸ’¨

* **å°è¨ˆãŒ 5,000å††ä»¥ä¸Šãªã‚‰é€æ–™ 0å††**
* ãã‚Œæœªæº€ãªã‚‰é€æ–™ 500å††

ãƒ’ãƒ³ãƒˆï¼š

* é€æ–™ã‚‚ `Money` ã«ã—ã¡ã‚ƒã†ã®ãŒæ°—æŒã¡ã„ã„ã‚ˆğŸ’°âœ¨
* ã€Œé€æ–™ã®è¨ˆç®—ã€ã‚‚ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã«å…¥ã‚Œã¦OKï¼ˆPricingServiceã«çµ±åˆã§ã‚‚åˆ†é›¢ã§ã‚‚OKï¼‰ğŸ™†â€â™€ï¸

---

## ã¾ã¨ã‚ğŸ‰

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€**â€œç½®ãå ´æ‰€ã«å›°ã‚‹é‡è¦ãƒ«ãƒ¼ãƒ«â€ã®é¿é›£å…ˆ**ã§ã™ğŸ âœ¨
ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚¹ãƒƒã‚­ãƒªä¿ã¡ãªãŒã‚‰ã€ãƒ«ãƒ¼ãƒ«ã‚’å¼·ãå®ˆã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ’ªğŸ˜Š

æ¬¡ã®ç« ã§ã¯ã€ã„ã‚ˆã„ã‚ˆ **é›†ç´„ï¼ˆAggregateï¼‰** ã«å…¥ã£ã¦ã„ãã‹ã‚‰ã€
ã“ã®ç« ã®ã€Œè²¬å‹™ã®ç½®ãæ–¹ã€ãŒåŠ¹ã„ã¦ãã‚‹ã‚ˆã€œï¼ğŸ”¥ğŸ˜†
