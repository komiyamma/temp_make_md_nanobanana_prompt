# ç¬¬128ç« ï¼šã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯ã€ŒUIã€ã˜ã‚ƒãªãã€Œã‚µãƒ¼ãƒãƒ¼ã€ã§ã‚„ã‚‹ğŸ™…

ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„äººã«ã¯ãƒœã‚¿ãƒ³ã‚’éš ã™ã€ã€Œãƒªãƒ³ã‚¯ã‚’å‡ºã•ãªã„ã€â€¦ã£ã¦ã€è¦‹ãŸç›®ã§å®ˆã£ãŸæ°—ã«ãªã‚ŠãŒã¡ã ã‚ˆã­ğŸ¥º
ã§ã‚‚ãã‚Œã€**å®ˆã‚Œã¦ãªã„**ã“ã¨ãŒå¤šã„ã®â€¦ï¼ğŸ’¥

çµè«–ï¼š**ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯â€œã‚µãƒ¼ãƒãƒ¼å´â€ã§ã‚„ã‚‹ã®ãŒæœ¬ä½“**ã§ã™ğŸ›¡ï¸âœ¨
ï¼ˆUIã¯â€œè¦ªåˆ‡â€ã®ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯â€œã‚µãƒ¼ãƒãƒ¼â€ã®ä»•äº‹ã ã‚ˆã€œï¼ï¼‰

---

## 1) ãªã‚“ã§UIã ã‘ã ã¨ãƒ€ãƒ¡ãªã®ï¼Ÿ

![Mask on a face vs locked door](./picture/next_study_128_ui_mask_useless.png)
ğŸ˜µâ€ğŸ’«

### UIã§éš ã—ã¦ã‚‚ã€å©ã‘ã¡ã‚ƒã†å•é¡ŒğŸ”¨

ãŸã¨ãˆã° `/dashboard` ã‚’ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¶ˆã™ã€ã ã‘ã«ã—ã¦ã‚‚â€¦

* URLã‚’æ‰‹å…¥åŠ›ã•ã‚ŒãŸã‚‰ï¼ŸâŒ¨ï¸
* ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰é–‹ã‹ã‚ŒãŸã‚‰ï¼ŸğŸ”–
* ç›´æ¥ `/api/xxx` ã‚’å©ã‹ã‚ŒãŸã‚‰ï¼ŸğŸ§ª
* DevToolsã§é€šä¿¡ã‚’çœŸä¼¼ã•ã‚ŒãŸã‚‰ï¼ŸğŸ•µï¸â€â™€ï¸

**UIã¯â€œè¡¨ç¤ºâ€ã‚’å¤‰ãˆã‚‹ã ã‘**ã§ã€**ã‚¢ã‚¯ã‚»ã‚¹ãã®ã‚‚ã®ã¯æ­¢ã‚ã‚‰ã‚Œãªã„**ã‚“ã ã‚ˆã­ğŸ¥²

---

## 2) æ­£ã—ã„è€ƒãˆæ–¹ï¼šå®ˆã‚‹å ´æ‰€ã¯2ã¤ï¼‹Î± ğŸ§±âœ¨

### â‘  å…¥å£ã§æ­¢ã‚ã‚‹ï¼šMiddlewareï¼ˆé–€ç•ªï¼‰ğŸ§¤

â†’ ã¾ãš**ä¿è­·ãƒ«ãƒ¼ãƒˆã«å…¥ã‚‹å‰**ã«æ­¢ã‚ã‚‹ğŸš¦

### â‘¡ ä¸­ã§ã‚‚æ­¢ã‚ã‚‹ï¼šServerå´ï¼ˆãƒšãƒ¼ã‚¸/Route Handler/Server Actionsï¼‰ğŸ§Š

â†’ Middlewareã‚’ã™ã‚ŠæŠœã‘ã¦ã‚‚ã€**æœ€çµ‚çš„ã«ã‚µãƒ¼ãƒãƒ¼ãŒæ‹’å¦**ã™ã‚‹ğŸ™…

### â‘¢ ã•ã‚‰ã«ï¼šãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆDBç­‰ï¼‰ğŸ—ƒï¸

â†’ ã€Œãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã‚‚ã€ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã›ãªã„ã€ã¿ãŸã„ãªã‚„ã¤ğŸ‘‘

---

## 3) å›³ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚ˆã€œğŸ§ âœ¨ï¼ˆUIã¯é˜²å£ã˜ã‚ƒãªã„ï¼‰

![ã‚¤ãƒ¡ãƒ¼ã‚¸å›³](./picture/next_study_128_security_layers.png)

```mermaid
flowchart LR
  U["ãƒ¦ãƒ¼ã‚¶ãƒ¼ğŸ‘©â€ğŸ“"] -->|"URLç›´æ‰“ã¡ / é€šä¿¡ã¾ã­"| R["ãƒªã‚¯ã‚¨ã‚¹ãƒˆğŸ“¨"]
  R --> MW["MiddlewareğŸ§¤<br/>å…¥å£ãƒã‚§ãƒƒã‚¯"]
  MW -->|"OK"| S["Serverå´ã®ãƒšãƒ¼ã‚¸/APIğŸ§Š<br/>æœ€çµ‚ãƒã‚§ãƒƒã‚¯"]
  MW -->|"NG"| L["/loginã¸ğŸšª/"]
  S -->|"OK"| OK["ãƒ‡ãƒ¼ã‚¿/HTMLè¿”ã™ğŸ"]
  S -->|"NG"| L2["/403 or /loginã¸ğŸ™…/"]
  OK --> U
```

ãƒã‚¤ãƒ³ãƒˆï¼š**UIã¯å›³ã«ã™ã‚‰å‡ºã¦ã“ãªã„**ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ä¸»æˆ¦å ´ã˜ã‚ƒãªã„ï¼‰ã£ã¦æ„Ÿã˜ğŸ˜‰âœ¨

---

## 4) ä¾‹ï¼š`/dashboard` ã‚’ã‚µãƒ¼ãƒãƒ¼ã§å®ˆã‚‹ğŸ”ï¼ˆNext.js App Routerï¼‰

ã“ã“ã§ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®è¨¼æ‹ ã€ã¨ã—ã¦ã€è¶…ã–ã£ãã‚Š **`session` Cookie** ãŒã‚ã‚‹å‰æã«ã™ã‚‹ã­ğŸª
ï¼ˆæœ¬æ ¼çš„ã«ã¯ Auth.js ãªã©ã‚’ä½¿ã†ã“ã¨ãŒå¤šã„ã‚ˆã€œï¼‰

---

### âœ… 4-1) Middlewareã§å…¥å£ãƒã‚§ãƒƒã‚¯

![Bouncer at the club entrance](./picture/next_study_128_middleware_gatekeeper.png)
ğŸ§¤

`middleware.ts`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ï¼‰ã‚’ä½œã‚‹ã‚ˆğŸ“„

```ts
// middleware.ts
import { NextRequest, NextResponse } from "next/server";

export function middleware(request: NextRequest) {
  const session = request.cookies.get("session")?.value;

  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ãªã‚‰ login ã¸
  if (!session) {
    const url = request.nextUrl.clone();
    url.pathname = "/login";
    // ã©ã“ã‹ã‚‰æ¥ãŸã‹ã‚’ä»˜ã‘ã¦ãŠãã¨è¦ªåˆ‡âœ¨
    url.searchParams.set("from", request.nextUrl.pathname);
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
}

// ã©ã®ãƒ‘ã‚¹ã«é©ç”¨ã™ã‚‹ã‹ï¼ˆä¿è­·ã—ãŸã„å ´æ‰€ã ã‘ï¼ï¼‰
export const config = {
  matcher: ["/dashboard/:path*"],
};
```

âœ¨ã“ã‚Œã§ã€`/dashboard` ã«å…¥ã‚‹å‰ã«ã€Œé–€ç•ªã€ãŒæ­¢ã‚ã¦ãã‚Œã‚‹ï¼

---

### âœ… 4-2) Serverå´ã§ã‚‚æœ€çµ‚ãƒã‚§ãƒƒã‚¯

![Guard inside checking again](./picture/next_study_128_server_double_check.png)
ï¼ˆä¿é™ºï¼‰ğŸ§ŠğŸ›¡ï¸

MiddlewareãŒã‚ã£ã¦ã‚‚ã€**ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒšãƒ¼ã‚¸ã§ã‚‚â€œå¿µã®ãŸã‚â€ãƒã‚§ãƒƒã‚¯**ã™ã‚‹ã®ãŒå¼·ã„ã‚ˆğŸ’ª
ï¼ˆé‹ç”¨ã§middlewareã®è¨­å®šãŒå¤‰ã‚ã£ãŸã‚Šã€ä¾‹å¤–ãŒå‡ºãŸã‚Šâ€¦ãã†ã„ã†æ™‚ã®ä¿é™ºï¼ï¼‰

`app/dashboard/page.tsx`ï¼š

```tsx
// app/dashboard/page.tsx
import { cookies } from "next/headers";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const cookieStore = await cookies();
  const session = cookieStore.get("session")?.value;

  if (!session) {
    redirect("/login");
  }

  return (
    <main>
      <h1>Dashboard ğŸ”</h1>
      <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹äººã ã‘ãŒè¦‹ã‚Œã‚‹ã‚ˆã€œâœ¨</p>
    </main>
  );
}
```

âœ… ã“ã‚ŒãŒã€Œã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯ã‚µãƒ¼ãƒãƒ¼ã§ã‚„ã‚‹ã€ã®å½¢ã ã‚ˆã€œï¼

---

## 5) ã€ŒUIã ã‘ã‚¬ãƒ¼ãƒ‰ã€ãŒå±ãªã„ä¾‹

![Transparent box labeled Secret](./picture/next_study_128_client_component_false_security.png)
âš ï¸ï¼ˆã‚„ã‚ŠãŒã¡â€¦ï¼ï¼‰

ä¾‹ãˆã°Client Componentã§ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ãªã‚‰è¡¨ç¤ºã—ãªã„ã€ã£ã¦ã‚„ã£ã¦ã‚‚â€¦

```tsx
"use client";

export function SecretPanel() {
  const isLoggedIn = false; // ä¾‹ï¼šçŠ¶æ…‹ã§åˆ¤å®šã—ã¦ã‚‹ã¤ã‚‚ã‚Š

  if (!isLoggedIn) return null; // è¡¨ç¤ºã—ãªã„

  return <div>ç§˜å¯†æƒ…å ±ğŸ¤«</div>;
}
```

ã“ã‚Œã£ã¦ã€Œè¦‹ãˆãªã„ã€ã ã‘ã§ã€ã‚‚ã—è£ã§APIå©ã„ã¦ãŸã‚‰â€¦
**APIã‚’ç›´æ¥å©ã‹ã‚ŒãŸã‚‰çµ‚ã‚ã‚Š**ãªã‚“ã ã‚ˆã­ğŸ˜‡ğŸ’¥

---

## 6) è¶…é‡è¦ãƒ¡ãƒ¢

![Glass jar vs Safe](./picture/next_study_128_localstorage_vs_cookie.png)
ï¼š`localStorage` ã‚’â€œãƒ­ã‚°ã‚¤ãƒ³è¨¼æ‹ â€ã«ã—ãªã„ğŸ™…â€â™€ï¸ğŸ§¨

* `localStorage` ã¯ **JavaScriptã‹ã‚‰èª­ã‚ã‚‹**
* XSSãŒèµ·ããŸã‚‰ **ç›—ã¾ã‚Œã‚„ã™ã„**
* ã€Œãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®šï¼localStorageã€ã ã¨äº‹æ•…ã‚ŠãŒã¡ğŸ¥º

ä¸€èˆ¬çš„ã«ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¯

* **HttpOnly Cookieï¼ˆJSã‹ã‚‰èª­ã‚ãªã„ï¼‰**ğŸªğŸ”’
* ã‚‚ã—ãã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä»•çµ„ã¿ï¼ˆAuth.jsç­‰ï¼‰
  ã«å¯„ã›ã‚‹ã“ã¨ãŒå¤šã„ã‚ˆâœ¨

---

## 7) ã¾ã¨ã‚ï¼šå®ˆã‚‹é †ç•ªã¯ã“ã‚ŒğŸ§±âœ¨

```mermaid
flowchart TB
  UI["UIã§ãƒœã‚¿ãƒ³ã‚’éš ã™ğŸ™ˆ<br/>â€»è¦ªåˆ‡ãªã ã‘"] --> MW["Middlewareã§å…¥å£ã‚’æ­¢ã‚ã‚‹ğŸ§¤"]
  MW --> SV["Serverã§æœ€çµ‚ãƒã‚§ãƒƒã‚¯ğŸ§Š"]
  SV --> DB["DB/ãƒ‡ãƒ¼ã‚¿å–å¾—ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ğŸ—ƒï¸ğŸ‘‘"]
```

* UIï¼š**æ¡ˆå†…ä¿‚**ï¼ˆä¾¿åˆ©ã«ã™ã‚‹ï¼‰ğŸ˜Š
* Middlewareï¼š**é–€ç•ª**ï¼ˆå…¥å£ã§æ­¢ã‚ã‚‹ï¼‰ğŸ§¤
* Serverï¼š**æœ¬ä¸¸**ï¼ˆæœ€çµ‚çš„ã«æ‹’å¦ã§ãã‚‹ï¼‰ğŸ›¡ï¸
* DBï¼š**æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯**ï¼ˆä»–äººã®ãƒ‡ãƒ¼ã‚¿ã¯å‡ºã•ãªã„ï¼‰ğŸ‘‘

---

## 8) ãƒŸãƒ‹ç·´ç¿’ï¼ˆ10åˆ†ï¼‰ğŸ“âœ¨

### âœ… ãŠé¡Œï¼šä¿è­·ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚ã†ğŸ”

1. `app/login/page.tsx` ã‚’ä½œã‚‹ï¼ˆä¸­èº«ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã ã‚ˆã€ã£ã¦è¡¨ç¤ºã§OKï¼‰ğŸšª
2. `app/dashboard/page.tsx` ã‚’ä½œã‚‹ï¼ˆä¸Šã®ä¾‹ã§OKï¼‰ğŸ“„
3. `middleware.ts` ã‚’ç½®ã„ã¦ã€`/dashboard` ã‚’å®ˆã‚‹ğŸ§¤
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000/dashboard` ã‚’é–‹ã

   * `session` CookieãŒç„¡ã„ãªã‚‰ `/login` ã«é£›ã¹ã°æˆåŠŸğŸ‰

ï¼ˆCookieã‚’æ‰‹ã§ä»˜ã‘ã‚‹ã®ã¯é›£ã—ã„ã®ã§ã€ä»Šæ—¥ã¯ã€Œé£›ã¶ã®ã‚’ç¢ºèªã€ã§ããŸã‚‰OKã ã‚ˆã€œğŸ˜Šï¼‰

---

## 9) ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸâœ¨

âœ… ã€ŒUIã‚’éš ã™ï¼å®ˆã‚Œã¦ã‚‹ã€ã˜ã‚ƒãªã„ï¼ã£ã¦ç†è§£ã§ããŸ
âœ… Next.jsã§ã¯ **Middleware + Serverå´ãƒã‚§ãƒƒã‚¯**ã§å®ˆã‚‹ã®ãŒåŸºæœ¬ã£ã¦åˆ†ã‹ã£ãŸ
âœ… â€œã‚µãƒ¼ãƒãƒ¼ãŒæœ€å¾Œã«æ‹’å¦ã§ãã‚‹çŠ¶æ…‹â€ãŒæœ€å¼·ã£ã¦ä½“æ„Ÿã—ãŸğŸ”ğŸ’ª

---
