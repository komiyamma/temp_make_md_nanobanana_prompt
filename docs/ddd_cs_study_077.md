# ç¬¬77ç« ï¼šActive Record ã€œDBã‚’â€œãã®ã¾ã¾è§¦ã‚‹â€æ˜”ãªãŒã‚‰ã®æ¥½ãªæ–¹æ³•ğŸ“šâœ¨

Active Recordï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰ã¯ã€ã–ã£ãã‚Šè¨€ã†ã¨â€¦â€¦

**ã€Œ1ã¤ã®ã‚¯ãƒ©ã‚¹ãŒã€ãƒ‡ãƒ¼ã‚¿ï¼ˆçŠ¶æ…‹ï¼‰ã‚‚ã€DBã¸ã®ä¿å­˜/æ¤œç´¢ï¼ˆæ°¸ç¶šåŒ–ï¼‰ã‚‚ã€ãœã‚“ã¶æŒã£ã¡ã‚ƒã†ã€**
ã¨ã„ã†è¨­è¨ˆã§ã™ğŸ§¸ğŸ—ƒï¸

ãŸã¨ãˆã° `Memo` ã¨ã„ã†ã‚¯ãƒ©ã‚¹ãŒã‚ã£ãŸã‚‰ã€

* `Memo.Title` ã‚„ `Memo.Body` ã¿ãŸã„ãª **ãƒ‡ãƒ¼ã‚¿** ã‚’æŒã£ã¦ã„ã¦
* `memo.Save()` / `Memo.Find(id)` ã¿ãŸã„ãª **DBæ“ä½œ** ã‚‚è‡ªåˆ†ã§ã‚„ã‚‹

â€¦ã£ã¦æ„Ÿã˜ã§ã™ğŸ™Œâœ¨
DDDã®æ–‡è„ˆã ã¨ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã¨DBãŒå¯†ç€ã—ã™ãã‚‹ã€ã®ã§å«Œã‚ã‚ŒãŒã¡ã ã‘ã©ã€**1äººé–‹ç™ºã§çˆ†é€Ÿã—ãŸã„å ´é¢**ã§ã¯æ™®é€šã«ã‚¢ãƒªã§ã™ğŸš€ğŸ’¨

![Active Record Concept](./picture/ddd_cs_study_077_active_record.png)

---

## 1. Active RecordãŒâ€œæ°—æŒã¡ã„ã„â€ç†ç”±ğŸ˜†ğŸ’—

![ddd_cs_study_077_speed_vs_debt](./picture/ddd_cs_study_077_speed_vs_debt.png)

### âœ… è‰¯ã„ã¨ã“ã‚ï¼ˆå¼·ã„ï¼ï¼‰
 
 ```mermaid
 classDiagram
     class Memo {
         +int Id
         +string Title
         +string Body
         +DateTime UpdatedAt
         
         +SaveAsync()
         +DeleteAsync()
         +FindAsync(id)$
     }
     
     note for Memo "ãƒ‡ãƒ¼ã‚¿ã‚‚DBæ“ä½œã‚‚\nå…¨éƒ¨æŒã£ã¦ã‚‹ï¼ğŸ’ª"
 ```
 
 * **ä½œã‚‹ã®ãŒé€Ÿã„**ï¼ˆæœ€çŸ­ã§CRUDãŒã§ãã‚‹ï¼‰âš¡
 * ã‚¯ãƒ©ã‚¹1å€‹è¦‹ã‚Œã°ã€Œä½•ãŒã§ãã‚‹ã‹ã€ã ã„ãŸã„åˆ†ã‹ã‚‹ğŸ‘€
 * å°è¦æ¨¡ã‚¢ãƒ—ãƒªã€ç®¡ç†ç”»é¢ã€ãƒ„ãƒ¼ãƒ«ç³»ã§ã‚ã¡ã‚ƒä¾¿åˆ©ğŸ› ï¸

### âš ï¸ ã¤ã‚‰ã„ã¨ã“ã‚ï¼ˆè‚²ã¤ã¨ç—›ã„ï¼‰

* **ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã¨DBéƒ½åˆãŒæ··ã–ã‚Šã‚„ã™ã„**ğŸï¼ˆã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£åŒ–ï¼‰
* ãƒ†ã‚¹ãƒˆãŒã ã‚“ã ã‚“æ›¸ãã¥ã‚‰ããªã‚‹ğŸ˜µâ€ğŸ’«
* å¾Œã‹ã‚‰DDDã£ã½ãåˆ†ã‘ãŸããªã‚‹ã¨ã€ç§»æ¤ãŒã¡ã‚‡ã„å¤§å¤‰ğŸ—ï¸

ã€Œæœ€åˆã¯å‹ã¡ã‚„ã™ã„ã‘ã©ã€é•·æœŸæˆ¦ã¯ç–²ã‚Œã‚„ã™ã„ã€ã‚¿ã‚¤ãƒ—ã§ã™ğŸ¥ºğŸ’¦

---

## 2. ã©ã†ã„ã†æ™‚ã«Active Recordã‚’é¸ã¶ï¼ŸğŸ¯

æ¬¡ã®ã©ã‚Œã‹ã«å½“ã¦ã¯ã¾ã£ãŸã‚‰ã€Active Record ã¯ã‹ãªã‚Šæœ‰åŠ›ã§ã™âœ¨

* ä»•æ§˜ãŒè»½ã„ï¼ˆãƒ«ãƒ¼ãƒ«ãŒå°‘ãªã„ï¼‰ğŸ“„
* ã¾ãšã¯å‹•ãã‚‚ã®ã‚’æ—©ãå‡ºã—ãŸã„ï¼ˆæ¤œè¨¼ã—ãŸã„ï¼‰ğŸ§ª
* ç®¡ç†ç”»é¢ãƒ»ç¤¾å†…ãƒ„ãƒ¼ãƒ«ãƒ»ä¸€æ™‚çš„ãªã‚¢ãƒ—ãƒªğŸ§°
* ã€Œã‚ã¨ã§ä½œã‚Šç›´ã—ã¦ã‚‚ã„ã„ã€å‰æã§é€²ã‚ãŸã„ğŸ”

é€†ã«ã€æ¬¡ã¿ãŸã„ãªå ´åˆã¯DDDå¯„ã‚Šã®æ–¹ãŒãƒ©ã‚¯ã«ãªã‚ŠãŒã¡ğŸ‘‡

* ä¾¡æ ¼è¨ˆç®—ã€å‰²å¼•ã€åœ¨åº«ã€æ¨©é™ã€äºˆç´„ãªã© **ãƒ«ãƒ¼ãƒ«ãŒè¤‡é›‘**ğŸ§ 
* ä»•æ§˜å¤‰æ›´ãŒå¤šãã€è‚²ã¤ã®ãŒç¢ºå®šğŸŒ±
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ã¡ã‚ƒã‚“ã¨å®ˆã‚ŠãŸã„ï¼ˆDBã«å¼•ã£å¼µã‚‰ã‚ŒãŸããªã„ï¼‰ğŸ›¡ï¸

---

## 3. æœ€å°ã®Active Recordã‚’C#ã§ä½œã£ã¦ã¿ã‚ˆã†ğŸ§ï¼ˆEF Core + SQLiteï¼‰

é¡Œæã¯ã€Œãƒ¡ãƒ¢å¸³ã€âœï¸âœ¨
**Memoã‚¯ãƒ©ã‚¹ãŒè‡ªåˆ†ã§DBä¿å­˜/æ¤œç´¢ã—ã¡ã‚ƒã†**ä¾‹ã§ã™ã€‚

### 3-1. ã¾ãšã‚„ã‚‹ã“ã¨ï¼ˆã‚µã‚¯ãƒƒã¨ï¼‰ğŸ§ª

* ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹
* EF Coreï¼ˆSQLiteï¼‰ã‚’å…¥ã‚Œã‚‹
* `Memo` ã« `SaveAsync / DeleteAsync / FindAsync` ã‚’æŒãŸã›ã‚‹

---

## 4. ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ã§å‹•ãç³»ï¼‰ğŸ’»âœ¨

> ã€Œä½œã‚Šã‚„ã™ã•å„ªå…ˆã€ã§ã€**ã‚ã–ã¨å¯†çµåˆ**ã«ã—ã¦ã„ã¾ã™ğŸ˜ˆ
> ã“ã“ãŒ Active Record ã®â€œå‘³â€ã§ã™ğŸ­

```csharp
using Microsoft.EntityFrameworkCore;

await Demo.RunAsync();

public static class Demo
{
    public static async Task RunAsync()
    {
        // 1) æ–°è¦ä½œæˆã—ã¦ä¿å­˜
        var memo = new Memo("ã¯ã˜ã‚ã¦ã®Active Record", "DBä¿å­˜ã¾ã§ã‚¯ãƒ©ã‚¹1å€‹ã§ã‚„ã£ã¡ã‚ƒã†âœ¨");
        await memo.SaveAsync();

        // 2) å–å¾—
        var loaded = await Memo.FindAsync(memo.Id);
        Console.WriteLine($"Load: {loaded?.Title} / {loaded?.Body}");

        // 3) æ›´æ–°ã—ã¦ä¿å­˜
        loaded!.Body = "æ›´æ–°ã—ãŸã‚ˆã€œğŸ“âœ¨";
        await loaded.SaveAsync();

        // 4) å‰Šé™¤
        await loaded.DeleteAsync();
        Console.WriteLine("Deleted ğŸ—‘ï¸");
    }
}

public class AppDbContext : DbContext
{
    public DbSet<Memo> Memos => Set<Memo>();

    protected override void OnConfiguring(DbContextOptionsBuilder options)
        => options.UseSqlite("Data Source=app.db");
}

public class Memo
{
    public int Id { get; private set; }
    public string Title { get; private set; }
    public string Body { get; set; }
    public DateTime UpdatedAt { get; private set; }

    // EF Coreç”¨ï¼ˆç©ºã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼‰
    private Memo() { Title = ""; Body = ""; }

    public Memo(string title, string body)
    {
        Title = title;
        Body = body;
        UpdatedAt = DateTime.UtcNow;
    }

    public async Task SaveAsync()
    {
        UpdatedAt = DateTime.UtcNow;

        await using var db = new AppDbContext();
        await db.Database.EnsureCreatedAsync();

        if (Id == 0)
        {
            db.Memos.Add(this);
        }
        else
        {
            db.Memos.Update(this);
        }

        await db.SaveChangesAsync();
    }

    public async Task DeleteAsync()
    {
        if (Id == 0) return;

        await using var db = new AppDbContext();
        db.Memos.Remove(this);
        await db.SaveChangesAsync();
    }

    public static async Task<Memo?> FindAsync(int id)
    {
        await using var db = new AppDbContext();
        return await db.Memos.FirstOrDefaultAsync(x => x.Id == id);
    }
}
```

### ã©ã“ãŒActive Recordã£ã½ã„ï¼ŸğŸ‘€âœ¨

* `Memo.SaveAsync()` ãŒ **è‡ªåˆ†ã§DBã‚’é–‹ã„ã¦ä¿å­˜**ã—ã¦ã‚‹ğŸ“¦
* `Memo.FindAsync(id)` ãŒ **è‡ªåˆ†ã§æ¤œç´¢ã—ã¦è¿”ã™**ğŸ”
* â€œãƒ‡ãƒ¼ã‚¿ã®å…¥ã‚Œç‰©â€ã˜ã‚ƒãªãã¦ã€**DBæ“ä½œã§ãã‚‹ç”Ÿãç‰©**ã«ãªã£ã¦ã‚‹ğŸ§¬

---

## 5. ã“ã®æ–¹å¼ã®ã€Œåœ°é›·ãƒã‚¤ãƒ³ãƒˆã€ã‚‚çŸ¥ã£ã¦ãŠã“ã†ğŸ§¨ğŸ˜‡

![ddd_cs_study_077_fat_model](./picture/ddd_cs_study_077_fat_model.png)

### åœ°é›·â‘ ï¼šDBã®äº‹æƒ…ãŒã‚¯ãƒ©ã‚¹ã«æŸ“ã¿è¾¼ã‚€ğŸ›

![ddd_cs_study_077_spaghetti_risk](./picture/ddd_cs_study_077_spaghetti_risk.png)

`AppDbContext` ã‚„ `EnsureCreated` ãŒã‚¯ãƒ©ã‚¹å†…ã«å‡ºã¦ãã¦ã€
ã ã‚“ã ã‚“ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã˜ã‚ƒãªãã€ŒDBæ“ä½œã‚¯ãƒ©ã‚¹ã€ã£ã½ããªã‚Šã¾ã™ğŸ˜µâ€ğŸ’«

### åœ°é›·â‘¡ï¼šãƒ†ã‚¹ãƒˆãŒé‡ããªã‚Šã‚„ã™ã„ğŸ§ªğŸ’¦

`SaveAsync()` ãŒDBå¿…é ˆã«ãªã‚‹ã¨ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒã¤ã‚‰ã„â€¦
ï¼ˆçµå±€ã€çµåˆãƒ†ã‚¹ãƒˆã£ã½ããªã‚‹ï¼‰ğŸ˜¢

### åœ°é›·â‘¢ï¼šæˆé•·ã™ã‚‹ã¨åˆ†å‰²ã—ãŸããªã‚‹ğŸŒ±

![ddd_cs_study_077_migration_path](./picture/ddd_cs_study_077_migration_path.png)

ã€Œä¿å­˜ã¯åˆ¥ã®å±¤ã«é€ƒãŒã—ãŸã„â€¦ã€ã£ã¦æ°—æŒã¡ãŒæ¥ã¾ã™ã€‚
ãã®æ™‚ã« Repository æ–¹å¼ã¸å¼•ã£è¶Šã—ğŸ âœ¨ï¼ˆç¬¬46ç« ã€œã®ä¸–ç•Œï¼‰

---

## 6. Active Record ã‚’ä½¿ã†ã¨ãã®â€œå‰²ã‚Šåˆ‡ã‚Šãƒ«ãƒ¼ãƒ«â€ğŸ“âœ¨

![ddd_cs_study_077_crud_focus](./picture/ddd_cs_study_077_crud_focus.png)

ãŠã™ã™ã‚ã®å‰²ã‚Šåˆ‡ã‚Šã¯ã“ã‚ŒğŸ‘‡ï¼ˆè¶…åŠ¹ãï¼‰

* âœ… **â€œCRUDã—ã‹ãªã„â€é ˜åŸŸã«é™å®š**ã™ã‚‹ï¼ˆè¤‡é›‘ãªè¨ˆç®—ã‚’å…¥ã‚Œãªã„ï¼‰ğŸ¡
* âœ… ãƒ«ãƒ¼ãƒ«ãŒå¢—ãˆãŸã‚‰ **å¼•ã£è¶Šã—å‰æ**ã§OKï¼ˆã„ã¾å‹ã¤ï¼ï¼‰ğŸƒâ€â™€ï¸ğŸ’¨
* âœ… è¤‡é›‘ã«ãªã‚Šãã†ãªã‚‰ã€`Save` ã§ã¯ãªã **Serviceã¸å¯„ã›ã‚‹**ğŸ¤

---

## 7. AIï¼ˆCopilot/Codexï¼‰ã§çˆ†é€Ÿã™ã‚‹ã‚³ãƒ„ğŸ¤–âš¡

### âœ… AIã«æŠ•ã’ã¦ã„ã„ã“ã¨

* CRUDã®é››å½¢ç”Ÿæˆï¼ˆ`Find`, `Save`, `Delete`ï¼‰ğŸ§±
* EF Coreã®è¨­å®šãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç³»ã®æ‰‹é †ğŸ”§
* ä¾‹å¤–å‡¦ç†ã‚„ãƒ­ã‚°ã®è¿½åŠ ğŸ“œ

### âš ï¸ AIã«ä¸¸æŠ•ã’ã—ãªã„ã“ã¨

* ã€Œã©ã“ã¾ã§ã‚’Active Recordã§è¨±ã™ã‹ã€ã®å¢ƒç•Œç·šğŸ§­
* ãã®æ©Ÿèƒ½ã¯â€œè‚²ã¤â€ã®ã‹ï¼Ÿæ¨ã¦ã‚‹ã®ã‹ï¼Ÿã¨ã„ã†åˆ¤æ–­ğŸŒ±ğŸ—‘ï¸

### ãã®ã¾ã¾ä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ’¬âœ¨

* ã€Œã“ã® `Memo` ã‚’ Active Record é¢¨ã«ã—ã¦ã€`SaveAsync/FindAsync/DeleteAsync` ã‚’è¿½åŠ ã—ã¦ã€ğŸ¤–
* ã€Œã“ã®è¨­è¨ˆãŒè‚¥å¤§åŒ–ã—ãã†ãªãƒã‚¤ãƒ³ãƒˆã‚’3ã¤æŒ‡æ‘˜ã—ã¦ã€æ”¹å–„æ¡ˆã‚‚å‡ºã—ã¦ã€ğŸ§ 
* ã€Œå°†æ¥Repositoryã«ç§»ã™å ´åˆã®ç§»è¡Œæ‰‹é †ã‚’ã–ã£ãã‚Šä½œã£ã¦ã€ğŸ“¦â¡ï¸ğŸ“¦

---

## 8. ãƒŸãƒ‹æ¼”ç¿’ï¼ˆã‚„ã£ã¦ã¿ã‚ˆã†ï¼ï¼‰ğŸ“ğŸ’–

### æ¼”ç¿’Aï¼šé …ç›®ã‚’å¢—ã‚„ã™ğŸ§

`Memo` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ã€ä¿å­˜ãƒ»å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã­âœ¨

* `IsPinned`ï¼ˆãƒ”ãƒ³ç•™ã‚ï¼‰ğŸ“Œ
* `Tags`ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã§ã‚‚OKï¼‰ğŸ·ï¸

### æ¼”ç¿’Bï¼šâ€œå¤ªã‚Šå§‹ã‚ãŸã‚µã‚¤ãƒ³â€ã‚’æ¢ã™ğŸ”

æ¬¡ã®å‡¦ç†ã‚’è¶³ã—ãŸããªã£ãŸã‚‰ã€Active Recordã‚’å’æ¥­ã™ã‚‹åˆå›³ã‹ã‚‚ğŸ‘‡

* ã€Œã‚¿ã‚°ã®æ­£è¦åŒ–ã€
* ã€Œæ¤œç´¢æ¡ä»¶ãŒå¢—æ®–ï¼ˆAND/ORåœ°ç„ï¼‰ã€
* ã€Œæ›´æ–°æ™‚ã®è¤‡é›‘ãªãƒ«ãƒ¼ãƒ«ï¼ˆç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã€æ¨©é™ã€å±¥æ­´â€¦ï¼‰ã€ğŸ˜µâ€ğŸ’«

---

## ã¾ã¨ã‚ğŸŒ¸âœ¨

Active Record ã¯ã€

* **æœ€é€Ÿã§ä½œã‚Œã‚‹**ğŸš€
* ã§ã‚‚ **è‚²ã¤ã¨è‹¦ã—ããªã‚‹**ğŸŒ±ğŸ’¦

ã ã‹ã‚‰ã“ãã€1äººé–‹ç™ºã§ã¯ã‚ã¡ã‚ƒå¼·ã„é¸æŠè‚¢ã§ã™ğŸ’ªâœ¨
ã€Œã¾ãšå‹ã¤ã€ãŸã‚ã®æ­¦å™¨ã¨ã—ã¦ã€æ°—æŒã¡ã‚ˆãä½¿ã£ã¦OKã§ã™ğŸ˜†ğŸ‰

---

æ¬¡ã®ç¬¬78ç« ï¼ˆä½¿ã„åˆ†ã‘ã®åŸºæº–ï¼‰ã§ã¯ã€
ã€ŒActive Record / ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ / DDDã€ã®åˆ‡ã‚Šæ›¿ãˆåˆ¤æ–­ã‚’ã€ã‚‚ã£ã¨ã‚¹ãƒ‘ãƒƒã¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã‚ˆâœ‚ï¸âœ¨
