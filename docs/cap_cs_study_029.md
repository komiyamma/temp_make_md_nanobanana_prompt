# ç¬¬29ç« ï¼šã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒè¨­è¨ˆï¼ˆå°‘ãªãã¨ã‚‚1å›å±Šãä¸–ç•Œã®ä½œæ³•ï¼‰ğŸ“¬ğŸ›¡ï¸

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ğŸ¯âœ¨

* ã€Œ**åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒ2å›æ¥ã¦ã‚‚å£Šã‚Œãªã„**ã€ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã‚’ä½œã‚Œã‚‹ï¼ˆå†ªç­‰ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒï¼‰ğŸ›¡ï¸
* **é‡è¤‡ãƒ»é †ä¸åŒãƒ»å†é…é”**ãŒâ€œãµã¤ã†ã«èµ·ãã‚‹â€å‰æã§è¨­è¨ˆã§ãã‚‹ğŸ“¨ğŸ“¨ğŸ”€
* **ãƒªãƒˆãƒ©ã‚¤**ã¨**DLQï¼ˆé…ä¿¡ä¸èƒ½ã‚­ãƒ¥ãƒ¼ï¼‰**ã‚’ã€Œé‹ç”¨ã§ãã‚‹å½¢ã€ã§çµ„ã¿è¾¼ã‚ã‚‹ğŸ§¯ğŸ—‘ï¸
* CampusCafeã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¾‹ï¼š`OrderPaid` / `StockReserved`ï¼‰ã‚’å®‰å…¨ã«å‡¦ç†ã§ãã‚‹â˜•ğŸ“¦ğŸ’³

---

## ã¾ãšçµè«–ï¼šåˆ†æ•£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€Œã ã„ãŸã„å°‘ãªãã¨ã‚‚1å›ã€å±ŠãğŸ“¬

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã§ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®éƒ½åˆã§ã€Œå—ã‘å–ã£ãŸã®ã«ACKãŒè¿”ã›ãªã‹ã£ãŸã€ã€Œå‡¦ç†ä¸­ã«è½ã¡ãŸã€ã¿ãŸã„ãªã“ã¨ãŒèµ·ãã‚‹ã‚ˆã­â€¦ğŸ˜µâ€ğŸ’«
ã ã‹ã‚‰å¤šãã®ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¯ **at-least-onceï¼ˆå°‘ãªãã¨ã‚‚1å›ï¼‰** ã®ä¸–ç•Œã«ãªã‚ŠãŒã¡ã€‚

* RabbitMQã¯ **ACKï¼ˆç¢ºèªå¿œç­”ï¼‰ã‚’ä½¿ã†ã¨ at-least-once** ã«ãªã‚‹ï¼ˆACKã—ãªã„é™ã‚Šå†é…é”ã•ã‚Œã†ã‚‹ï¼‰ğŸ“¨ğŸ” ([rabbitmq.com][1])
* Azure Service Busã‚‚ã€Œãƒ­ãƒƒã‚¯ï¼†ç¢ºå®šï¼ˆCompleteï¼‰/æ”¾æ£„ï¼ˆAbandonï¼‰/DLQã€ã¿ãŸã„ã«ã€å‡¦ç†çµæœã«å¿œã˜ã¦æ˜ç¤ºçš„ã«æ‰±ã†è¨­è¨ˆãŒåŸºæœ¬ã«ãªã‚‹ã‚ˆğŸ“¦âœ… ([Microsoft Learn][2])

---

## CampusCafeã§ã€Œå£Šã‚Œã‚„ã™ã„ã€ä»£è¡¨ä¾‹ğŸ’¥

ãŸã¨ãˆã° `OrderPaid`ï¼ˆæ±ºæ¸ˆå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã‚’å—ã‘ãŸã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãŒã€

* æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’Paidã«æ›´æ–°ã™ã‚‹
* é€šçŸ¥ã‚’é€ã‚‹ï¼ˆã€Œæ±ºæ¸ˆã§ããŸã‚ˆã€œğŸ””ã€ï¼‰
* ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ã™ã‚‹

â€¦ã‚’ã‚„ã‚‹ã¨ã—ã¦ã€åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒ2å›æ¥ãŸã‚‰ã©ã†ãªã‚‹ï¼ŸğŸ˜‡
ãã®ã¾ã¾ã ã¨ã€Œãƒã‚¤ãƒ³ãƒˆ2å€ã€ã€Œé€šçŸ¥2å›ã€ã€ŒäºŒé‡å‡¦ç†ã€ãŒèµ·ãã‚‹ã‹ã‚‚ğŸ’¦

ã ã‹ã‚‰å¿…è¦ãªã®ãŒ **å†ªç­‰ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒï¼ˆIdempotent Consumerï¼‰** ã ã‚ˆğŸ›¡ï¸âœ¨

---

## å†ªç­‰ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã®ç‹é“ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯2ã¤ğŸ§©

```mermaid
flowchart TD
    A["ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡"] --> B{"Inboxã«IDã‚ã‚Š?"}
    B -- Yes --> C["å‡¦ç†æ¸ˆã¿ã¨ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ğŸ—‘ï¸"]
    B -- No --> D["ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹"]
    
    subgraph TX ["åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ ğŸ§±"]
        D --> E["Inboxã«IDã‚’ç™»éŒ²"]
        E --> F["æ¥­å‹™ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° (æ³¨æ–‡ç­‰)"]
    end
    
    F --> G["ã‚³ãƒŸãƒƒãƒˆ!"]
    G --> H["ACK(ç¢ºèªå¿œç­”)ã‚’è¿”ã™âœ…"]
    
    style TX fill:#f9f9f9,stroke:#333,stroke-dasharray: 5 5
```



![cap_cs_study_029_inbox_concept](./picture/cap_cs_study_029_inbox_concept.png)

### ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼šå‡¦ç†ãã®ã‚‚ã®ã‚’â€œè‡ªç„¶ã«å†ªç­‰â€ã«ã™ã‚‹ï¼ˆUpsert/ä¸€æ„åˆ¶ç´„ï¼‰ğŸŒ±

* ä¾‹ï¼šæ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚’ã€Œ`Paid` ä»¥å¤–ãªã‚‰ `Paid` ã«ã™ã‚‹ã€ã¿ãŸã„ã«ã™ã‚‹
* ä¾‹ï¼šãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã‚’ã€Œï¼ˆOrderId, Ruleï¼‰ã«ä¸€æ„åˆ¶ç´„ã€ã—ã¦äºŒé‡ä»˜ä¸ã‚’DBã§æ­¢ã‚ã‚‹

**DBã®ä¸€æ„åˆ¶ç´„ã§å®ˆã‚‹**ã®ã¯å¼·ã„ã‚ˆğŸ’ª
ãŸã ã—ã€Œé€šçŸ¥é€ä¿¡ã€ã¿ãŸã„ãªå¤–éƒ¨å‰¯ä½œç”¨ã¯ã€DBã ã‘ã§å®Œçµã—ãªã„ã‹ã‚‰æ³¨æ„âš ï¸

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼šInboxï¼ˆå‡¦ç†æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã§â€œé‡è¤‡æ’é™¤â€ã™ã‚‹ğŸ“¥ğŸ—ƒï¸

ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã«ã¯ **ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªID**ï¼ˆ`MessageId` / `EventId`ï¼‰ã‚’æŒãŸã›ã¦ã€
ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒå´ã§ã€Œã“ã®IDã€ã‚‚ã†å‡¦ç†ã—ãŸï¼Ÿã€ã‚’DBã«è¨˜éŒ²ã™ã‚‹æ–¹å¼ã ã‚ˆâœ¨

* `Inbox`ï¼ˆã¾ãŸã¯ `processed_messages`ï¼‰ã« `EventId` ã‚’ä¿å­˜
* **ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**ã§äºŒé‡ç™»éŒ²ã‚’é˜²ã
* ã™ã§ã«å­˜åœ¨ã—ãŸã‚‰ã€Œé‡è¤‡ã ã‹ã‚‰ã‚¹ã‚­ãƒƒãƒ—ã€ğŸ“¨â¡ï¸ğŸ—‘ï¸

ã“ã®è€ƒãˆæ–¹ãŒã€ŒIdempotent Consumer / Inboxã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚ˆğŸ“Œ ([event-driven.io][3])

---

## ä»Šæ—¥ã®ãƒŸãƒ‹å®Ÿè£…ï¼šInboxæ–¹å¼ã§ã€Œ2å›æ¥ã¦ã‚‚å£Šã‚Œãªã„ã€ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã‚’ä½œã‚‹ğŸ§ªâœ…

### ã¤ãã‚‹ã‚‚ã®ğŸ› ï¸

* `OrderPaid` ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒ
* SQLiteã« `Inbox` ã¨ `Orders` ã‚’ä½œã‚‹
* åŒã˜ `EventId` ã‚’2å›æµã—ã¦ã‚‚çµæœãŒ1å›åˆ†ã«ãªã‚‹ã®ã‚’ç¢ºèªğŸ‰

---

## DBè¨­è¨ˆï¼ˆæœ€å°æ§‹æˆï¼‰ğŸ—ƒï¸

### ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ“Œ

* `inbox_messages`

  * `EventId`ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼ï¼‰
  * `ProcessedAt`
* `orders`

  * `OrderId`ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  * `Status`ï¼ˆä¾‹ï¼šCreated / Paid / Cancelledï¼‰

> ãƒã‚¤ãƒ³ãƒˆï¼š**ã€ŒInboxç™»éŒ²ã€ã¨ã€ŒOrdersæ›´æ–°ã€ã‚’åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚„ã‚‹**ã“ã¨ï¼
> ã“ã‚Œã§ã€ŒInboxã ã‘ç™»éŒ²ã•ã‚ŒãŸ/Ordersã ã‘æ›´æ–°ã•ã‚ŒãŸã€ã¿ãŸã„ãªäº‹æ•…ã‚’æ¸›ã‚‰ã›ã‚‹ã‚ˆğŸ›¡ï¸âœ¨

---

## å®Ÿè£…ï¼ˆSQLite + ADO.NETã§ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ğŸ§

ä»¥ä¸‹ã¯ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘ãŸã€æƒ³å®šã§ `HandleOrderPaidAsync` ã‚’å‘¼ã¶ãƒŸãƒ‹æ§‹æˆã ã‚ˆğŸ“¨

```csharp
using Microsoft.Data.Sqlite;

public sealed record OrderPaidEvent(string EventId, string OrderId, DateTimeOffset PaidAt);

public static class Consumer
{
    public static async Task HandleOrderPaidAsync(SqliteConnection conn, OrderPaidEvent ev)
    {
        // 1) ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆInboxã¨æ¥­å‹™æ›´æ–°ã‚’åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ï¼ï¼‰
        await using var tx = await conn.BeginTransactionAsync();

        // 2) Inboxã«EventIdã‚’ç™»éŒ²ï¼ˆé‡è¤‡ãªã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã§å¼¾ã‹ã‚Œã‚‹ï¼‰
        //    â†’ ã“ã“ãŒã€Œé‡è¤‡æ’é™¤ã®æ “ã€ğŸ›¡ï¸
        var insertInbox = conn.CreateCommand();
        insertInbox.Transaction = tx;
        insertInbox.CommandText = """
            INSERT INTO inbox_messages (event_id, processed_at)
            VALUES ($event_id, $processed_at);
        """;
        insertInbox.Parameters.AddWithValue("$event_id", ev.EventId);
        insertInbox.Parameters.AddWithValue("$processed_at", DateTimeOffset.UtcNow.ToString("O"));

        try
        {
            await insertInbox.ExecuteNonQueryAsync();
        }
        catch (SqliteException ex) when (ex.SqliteErrorCode == 19) // SQLITE_CONSTRAINT
        {
            // ã‚‚ã†å‡¦ç†æ¸ˆã¿ï¼é‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆğŸ“¨ğŸ“¨
            await tx.RollbackAsync();
            return;
        }

        // 3) æ¥­å‹™æ›´æ–°ï¼šæ³¨æ–‡ã‚’Paidã«ã™ã‚‹ï¼ˆã™ã§ã«Paidã§ã‚‚çµæœãŒåŒã˜ã«ãªã‚‹ã‚ˆã†ã«ï¼‰
        var updateOrder = conn.CreateCommand();
        updateOrder.Transaction = tx;
        updateOrder.CommandText = """
            UPDATE orders
               SET status = 'Paid'
             WHERE order_id = $order_id
               AND status <> 'Paid';
        """;
        updateOrder.Parameters.AddWithValue("$order_id", ev.OrderId);

        await updateOrder.ExecuteNonQueryAsync();

        // 4) ã‚³ãƒŸãƒƒãƒˆ
        await tx.CommitAsync();
    }
}
```

### äº‹å‰ã«ä½œã‚‹DDLï¼ˆSQLiteï¼‰ğŸ“„

```sql
CREATE TABLE IF NOT EXISTS inbox_messages (
  event_id     TEXT PRIMARY KEY,
  processed_at TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS orders (
  order_id TEXT PRIMARY KEY,
  status   TEXT NOT NULL
);
```

---

## ãƒŸãƒ‹æ¼”ç¿’ï¼šåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’2å›æµã—ã¦ç¢ºèªã—ã‚ˆã†ğŸ“¨ğŸ“¨âœ…

### æ‰‹é †ğŸª„

1. `orders` ã« `order_id='O-100' , status='Created'` ã‚’å…¥ã‚Œã‚‹
2. `EventId='E-1'` ã® `OrderPaid` ã‚’2å›å‡¦ç†ã™ã‚‹
3. çµæœï¼š`orders.status` ã¯ `Paid` ã®ã¾ã¾ã€`inbox_messages` ã¯ `E-1` ãŒ1è¡Œã ã‘âœ¨

### æœŸå¾…ã™ã‚‹â€œå£Šã‚Œãªã„æŒ™å‹•â€ğŸ’¯

* 2å›ç›®ã¯ `inbox_messages` ã®ä¸€æ„åˆ¶ç´„ã§æ­¢ã¾ã£ã¦ **ä½•ã‚‚èµ·ããªã„**
* ã ã‹ã‚‰ã€Œãƒã‚¤ãƒ³ãƒˆ2å€ã€ã¿ãŸã„ãªäº‹æ•…ãŒæ¶ˆãˆã‚‹ğŸ›¡ï¸

---

## â€œé †ç•ªâ€ãŒå¿…è¦ãªã¨ãã ã‘ã€å°‚ç”¨ã®ä»•çµ„ã¿ã‚’ä½¿ã†ğŸ”€â¡ï¸ğŸ“Œ

é †ä¸åŒã¯æ™®é€šã«èµ·ãã‚‹ã‚ˆã€œğŸ˜µâ€ğŸ’«
ã§ã‚‚å…¨éƒ¨ã‚’ã€Œé †ç•ªä¿è¨¼ã€ã«ã™ã‚‹ã¨ã‚³ã‚¹ãƒˆãŒé«˜ã„ï¼ˆé…ããªã‚‹/è©°ã¾ã‚Šã‚„ã™ã„ï¼‰ğŸ’¦

### ã©ã†ã—ã¦ã‚‚é †ç•ªãŒå¿…è¦ãªä¾‹ğŸ“Œ

* `OrderCreated â†’ OrderPaid â†’ OrderCompleted` ã‚’**å¿…ãšé †ã«**å‡¦ç†ã—ãŸã„
* â€œåŒã˜OrderIdã®ã‚¤ãƒ™ãƒ³ãƒˆã ã‘â€é †ç•ªãŒå®ˆã‚Œã‚Œã°OK

ã“ã®æ‰‹ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€Azure Service Busã® **Sessionsï¼ˆFIFOï¼‰** ãŒä½¿ãˆã‚‹ã‚ˆâœ¨
ã€ŒåŒã˜ `SessionId=OrderId` ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯é †ã«å‡¦ç†ã€ã¿ãŸã„ãªæ„Ÿã˜ï¼ ([Microsoft Learn][4])

---

## DLQï¼ˆé…ä¿¡ä¸èƒ½ã‚­ãƒ¥ãƒ¼ï¼‰ã¯ã€Œå¤±æ•—ã®å¢“å ´ã€ã˜ã‚ƒãªãã€Œèª¿æŸ»ã®ä¿ç®¡åº«ã€ğŸ—‘ï¸ğŸ”

ä½•åº¦ã‚„ã£ã¦ã‚‚å¤±æ•—ã™ã‚‹â€œæ¯’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€ã¯ã‚ã‚‹ã‚ã‚‹â€¦ğŸ¥²
ãã“ã§DLQã«é€ƒãŒã—ã¦ã€ã‚ã¨ã§**èª¿æŸ»ãƒ»ä¿®æ­£ãƒ»å†æŠ•å…¥**ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ãŒå¤§äº‹ï¼

* Azure Service Busã®DLQã¯ã€Œå‡¦ç†ã§ããªã„/é…ä¿¡ã§ããªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿ç®¡ã—ã¦æ¤œæŸ»ã§ãã‚‹ã€ç›®çš„ã ã‚ˆğŸ“¦ğŸ” ([Microsoft Learn][5])

### DLQé‹ç”¨ã®ãƒŸãƒ‹ãƒ«ãƒ¼ãƒ«ï¼ˆãŠã™ã™ã‚ï¼‰ğŸ§­

* DLQã«å…¥ã£ãŸã‚‰ã€ŒåŸå› ã‚¿ã‚°ï¼ˆç†ç”±ï¼‰ã€ã‚’å¿…ãšè¨˜éŒ²ã™ã‚‹ï¼ˆä¾‹ï¼šValidationError / SchemaMismatchï¼‰ğŸ·ï¸
* DLQã®æ»ç•™ä»¶æ•°ã‚’ç›£è¦–ã™ã‚‹ï¼ˆå¢—ãˆãŸã‚‰ç•°å¸¸ï¼‰ğŸ“ˆ
* ã€Œç›´ã›ã‚‹å¤±æ•—ã€ã¯ä¿®æ­£ã—ã¦å†æŠ•å…¥ã€ã€Œç›´ã›ãªã„ã€ã¯éš”é›¢ã—ã¦ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ğŸ§¯

---

## Azure Service Busã§ã®â€œç¢ºå®š/æ”¾æ£„â€ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆè¶…ã–ã£ãã‚Šï¼‰âœ…â†©ï¸ğŸ•°ï¸

Service Busã® .NET ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦ä»£è¡¨çš„ã«ã“ã‚“ãªæ“ä½œãŒã‚ã‚‹ã‚ˆğŸ‘‡

* `Complete`ï¼šå‡¦ç†æˆåŠŸ â†’ ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤âœ…
* `Abandon`ï¼šä»Šã¯å¤±æ•— â†’ ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¦å†é…é”ã¸â†©ï¸
* `Defer`ï¼šã„ã£ãŸã‚“ä¿ç•™ï¼ˆã‚ã¨ã§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã§å›åï¼‰ğŸ•°ï¸

ï¼ˆç”¨èªã®æ•´ç†ã«ä¾¿åˆ©ï¼ï¼‰ ([Microsoft Learn][2])

---

## é‡è¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆ2026è¦–ç‚¹ï¼‰ğŸ“£

Azure Service Busã®å¤ã„SDKï¼ˆ`WindowsAzure.ServiceBus` / `Microsoft.Azure.ServiceBus` ãªã©ï¼‰ã¯ **2026-09-30 ã«é€€å½¹äºˆå®š**ã§ã€ç§»è¡ŒãŒæ¨å¥¨ã•ã‚Œã¦ã‚‹ã‚ˆâš ï¸
ä»Šã‹ã‚‰æ›¸ããªã‚‰ â€œæœ€æ–°ã®Azure SDKâ€ å´ã§é€²ã‚ã‚‹ã®ãŒå®‰å¿ƒï¼ ([Microsoft Learn][6])

---

## ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®åŠ©ã‘ã‚‚å€Ÿã‚Šã¦OKï¼ˆMassTransitä¾‹ï¼‰ğŸšŒâœ¨

ã€Œã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒå†…ã§å‡¦ç†ã—ã¦ã€ãã®å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ãŸã„ã€ã¿ãŸã„ãªã¨ãã€
MassTransitã® **In-Memory Outbox** ã‚’ä½¿ã†ã¨ã€Œå‡¦ç†ãŒæˆåŠŸã™ã‚‹ã¾ã§ç™ºè¡Œã‚’ä¿ç•™ã€ã—ã¦ãã‚Œã‚‹ã‚ˆğŸ“¤ğŸ§  ([masstransit.io][7])

> ãŸã ã—ï¼ãã‚Œã§ã‚‚**ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãŒå†ªç­‰ã§ã‚ã‚‹ã“ã¨**ã¯å‰æã«ãªã‚‹ã‚ˆğŸ›¡ï¸ ([masstransit.io][7])

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆãã®ã¾ã¾ã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ï¼‰âœ…âœ…âœ…

* [ ] ã‚¤ãƒ™ãƒ³ãƒˆã« `EventId`ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ã‚’æŒãŸã›ãŸï¼ŸğŸ”‘
* [ ] `Inbox`ï¼ˆå‡¦ç†æ¸ˆã¿è¨˜éŒ²ï¼‰ã‚’DBã«æŒã£ãŸï¼ŸğŸ“¥
* [ ] `Inboxç™»éŒ²` ã¨ `æ¥­å‹™æ›´æ–°` ã‚’**åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**ã«ã—ãŸï¼ŸğŸ§±
* [ ] æ¥­å‹™æ›´æ–°ã¯ã€Œã™ã§ã«é©ç”¨æ¸ˆã¿ã§ã‚‚çµæœãŒåŒã˜ã€ã«ãªã£ã¦ã‚‹ï¼Ÿï¼ˆå†ªç­‰ï¼‰ğŸ›¡ï¸
* [ ] å¤–éƒ¨å‰¯ä½œç”¨ï¼ˆé€šçŸ¥/ä»–APIå‘¼ã³å‡ºã—ï¼‰ã¯â€œäºŒé‡ã§ã‚‚å¹³æ°—â€ã«ã§ãã¦ã‚‹ï¼ŸğŸ””
* [ ] ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã„ã„å¤±æ•—/ãƒ€ãƒ¡ãªå¤±æ•—ã®ç·šå¼•ããŒã‚ã‚‹ï¼ŸğŸš¥
* [ ] æ¯’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯DLQã«é€ƒãŒã—ã¦èª¿æŸ»ã§ãã‚‹ï¼ŸğŸ—‘ï¸ğŸ”
* [ ] ç›£è¦–ï¼šå¤±æ•—ç‡ã€ãƒªãƒˆãƒ©ã‚¤å›æ•°ã€DLQæ»ç•™ã‚’è¦‹ã‚Œã‚‹ï¼ŸğŸ“ˆ

---

## AIæ´»ç”¨ï¼ˆCopilot / Codexå‘ã‘ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼‰ğŸ¤–âœ¨

### â‘  Inboxãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã—ã¦ã‚‚ã‚‰ã†ğŸ”

* ã€Œã“ã® `HandleOrderPaidAsync` ãŒå†ªç­‰ã«ãªã£ã¦ã‚‹ã‹ã€é‡è¤‡æ™‚ã®æŒ™å‹•ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€‚æ”¹å–„ç‚¹ã‚‚å‡ºã—ã¦ã€

### â‘¡ â€œå‰¯ä½œç”¨â€ã®æ´—ã„å‡ºã—ã‚’ã•ã›ã‚‹ğŸ§¨

* ã€Œã“ã®ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒå†…ã®å‰¯ä½œç”¨ï¼ˆé€šçŸ¥ã€å¤–éƒ¨APIã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œï¼‰ã‚’åˆ—æŒ™ã—ã¦ã€äºŒé‡å®Ÿè¡Œã§ã‚‚å®‰å…¨ã«ã™ã‚‹æ–¹æ³•ã‚’ææ¡ˆã—ã¦ã€

### â‘¢ DLQã®é‹ç”¨ãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚‰ã›ã‚‹ğŸ§¹

* ã€ŒDLQã«è½ã¡ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æŸ»ãƒ»å¾©æ—§ã™ã‚‹é‹ç”¨æ‰‹é †ï¼ˆåŸå› åˆ†é¡ã€å†æŠ•å…¥æ¡ä»¶ã€ç›£è¦–é …ç›®ï¼‰ã‚’CampusCafeå‘ã‘ã«ä½œã£ã¦ã€

---

## ç« æœ«ã¾ã¨ã‚ğŸŒ¸

* â€œå°‘ãªãã¨ã‚‚1å›å±Šãâ€ä¸–ç•Œã§ã¯ã€**é‡è¤‡ã¯ãƒã‚°ã˜ã‚ƒãªãä»•æ§˜**ğŸ“¨ğŸ“¨
* ã ã‹ã‚‰ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒã¯ **å†ªç­‰** ã«ã™ã‚‹ã®ãŒæ­£ç¾©ğŸ›¡ï¸âœ¨
* ç‹é“ã¯ **Inboxï¼ˆå‡¦ç†æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‹ä¸€æ„åˆ¶ç´„ï¼‰** ğŸ“¥
* é †åºãŒæœ¬å½“ã«å¿…è¦ãªã¨ãã ã‘ã€**Sessionsï¼ˆFIFOï¼‰** ãªã©å°‚ç”¨æ©Ÿèƒ½ã‚’ä½¿ã†ğŸ”€â¡ï¸ ([Microsoft Learn][4])
* å¤±æ•—ã¯DLQã§â€œè¦‹ãˆã‚‹åŒ–â€ã—ã¦ã€é‹ç”¨ã§å‹ã¤ğŸ—‘ï¸ğŸ” ([Microsoft Learn][5])

[1]: https://www.rabbitmq.com/docs/reliability?utm_source=chatgpt.com "Reliability Guide"
[2]: https://learn.microsoft.com/en-us/dotnet/api/overview/azure/messaging.servicebus-readme?view=azure-dotnet&utm_source=chatgpt.com "Azure Service Bus client library for .NET"
[3]: https://event-driven.io/en/outbox_inbox_patterns_and_delivery_guarantees_explained/?utm_source=chatgpt.com "Outbox, Inbox patterns and delivery guarantees explained"
[4]: https://learn.microsoft.com/en-us/azure/service-bus-messaging/message-sessions?utm_source=chatgpt.com "Azure Service Bus message sessions"
[5]: https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dead-letter-queues?utm_source=chatgpt.com "Service Bus dead-letter queues - Azure"
[6]: https://learn.microsoft.com/en-us/azure/service-bus-messaging/duplicate-detection?utm_source=chatgpt.com "Azure Service Bus duplicate message detection"
[7]: https://masstransit.io/documentation/patterns/in-memory-outbox?utm_source=chatgpt.com "In-Memory Outbox"
