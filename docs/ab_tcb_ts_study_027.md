# ç¬¬27ç« ï¼šå†ªç­‰æ€§â‘ ï¼ˆãªãœå¿…è¦ï¼ŸäºŒé‡é€ä¿¡ã®ä¸–ç•Œï¼‰ğŸ”‚ğŸŒ

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ğŸ¯âœ¨

* ã€ŒäºŒé‡é€ä¿¡ã€ã£ã¦ä½•ãŒæ€–ã„ã®ã‹ã€**å…·ä½“ä¾‹ã§**èª¬æ˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ˜±ğŸ’¥
* ã€Œæ¥½è¦³ãƒ­ãƒƒã‚¯ï¼ˆversionï¼‰ã€ã ã‘ã§ã¯**å®ˆã‚Œãªã„ç©´**ã‚’ç†è§£ã™ã‚‹ğŸ•³ï¸ğŸ›¡ï¸
* ãƒŸãƒ‹ECï¼ˆæ³¨æ–‡ğŸ›’ãƒ»åœ¨åº«ğŸ“¦ãƒ»æ”¯æ‰•ã„ğŸ’³ï¼‰ã§ã€**å†ªç­‰æ€§ãŒå¿…è¦ãªæ“ä½œ**ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã§ãã‚‹ğŸ“âœ…
* æ¬¡ç« ï¼ˆå†ªç­‰ã‚­ãƒ¼è¨­è¨ˆğŸ”‘ğŸ› ï¸ï¼‰ã«å‘ã‘ã¦ã€**ä»•æ§˜ï¼ˆæœŸå¾…ã™ã‚‹æŒ¯ã‚‹èˆã„ï¼‰**ã‚’ãƒ†ã‚¹ãƒˆã§æ›¸ã‘ã‚‹ğŸ§ªâœ¨

---

## ã¾ãšã¯ç¾å®Ÿï¼šäºŒé‡é€ä¿¡ã£ã¦ã€Œãƒã‚°ã€ã˜ã‚ƒãªãã¦ã€Œæ—¥å¸¸ã€ğŸ˜‡ğŸ“¡

äºŒé‡é€ä¿¡ãŒèµ·ãã‚‹ç†ç”±ã¯ã€ã ã„ãŸã„ã“ã®ã¸ã‚“ğŸ‘‡ï¼ˆãœã‚“ã¶â€œã‚ã‚‹ã‚ã‚‹â€ï¼‰

* é€šä¿¡ãŒä¸å®‰å®šã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒªãƒˆãƒ©ã‚¤ğŸ”ğŸ“¶
* ã‚¯ãƒªãƒƒã‚¯é€£æ‰“ï¼ˆæ±ºæ¸ˆãƒœã‚¿ãƒ³é€£æ‰“ï¼‰ğŸ–±ï¸ğŸ’¥ğŸ’¥
* ç”»é¢ãŒå›ºã¾ã£ãŸã‚ˆã†ã«è¦‹ãˆã¦å†é€ğŸ”ğŸ˜µ
* ãƒ¢ãƒã‚¤ãƒ«ã§é›»æ³¢ãŒåˆ‡ã‚ŒãŸã‚Šå¾©å¸°ã—ãŸã‚ŠğŸ“±âš¡
* ã‚­ãƒ¥ãƒ¼ã‚„WebhookãŒã€Œæœ€ä½1å›ã¯å±Šã‘ã‚‹ã€æ–¹å¼ã§ã€åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒæ¥ã‚‹ğŸ“¨ğŸ“¨

ã¤ã¾ã‚Šã€ŒåŒã˜è¦æ±‚ãŒã‚‚ã†ä¸€åº¦æ¥ã‚‹ã€ã“ã¨ã‚’**å‰æ**ã«ã—ãªã„ã¨ã€ã„ã¤ã‹äº‹æ•…ã‚Šã¾ã™ğŸ˜±ğŸ§¯

---

## å†ªç­‰æ€§ï¼ˆIdempotencyï¼‰ã£ã¦ãªã«ï¼ŸğŸ”‚ğŸ§ 

![Study Image](./picture/ab_tcb_ts_study_027_idempotency.png)

ã–ã£ãã‚Šè¨€ã†ã¨â€¦

**ã€ŒåŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½•å›é€ã£ã¦ã‚‚ã€ã‚µãƒ¼ãƒãƒ¼ã®æœ€çµ‚çµæœãŒ1å›ã¨åŒã˜ã€**ã«ãªã‚‹æ€§è³ªã ã‚ˆâœ…ğŸ”‚

HTTPã®ä¸–ç•Œã§ã‚‚ã¡ã‚ƒã‚“ã¨å®šç¾©ãŒã‚ã£ã¦ã€
**â€œåŒã˜ã“ã¨ã‚’è¤‡æ•°å›ã‚„ã£ã¦ã‚‚ã€æ„å›³ã•ã‚ŒãŸåŠ¹æœãŒ1å›ã¨åŒã˜â€**ãŒå†ªç­‰ã ã‚ˆã€œã£ã¦èª¬æ˜ã•ã‚Œã¦ã‚‹ğŸ§ âœ¨ ([rfc-editor.org][1])

ãã—ã¦HTTPçš„ã«ã¯ã€ä¸€èˆ¬ã«

* PUT / DELETE ã¯å†ªç­‰ï¼ˆåŒã˜ã‚‚ã®ã‚’ä½•å›ã‚„ã£ã¦ã‚‚çµæœã¯åŒã˜ã«ãªã‚Šã‚„ã™ã„ï¼‰
* POST ã¯å†ªç­‰ãŒä¿è¨¼ã•ã‚Œãªã„ï¼ˆä½œæˆã‚„ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã§å‰¯ä½œç”¨ãŒå‡ºã‚„ã™ã„ï¼‰

â€¦ã¿ãŸã„ãªæ•´ç†ãŒã‚ˆãå‡ºã¦ãã‚‹ã‚ˆğŸ“®âš™ï¸ ([Microsoft Learn][2])

---

## ãƒŸãƒ‹ECã§èµ·ãã‚‹åœ°ç„ï¼šæ”¯æ‰•ã„ç¢ºå®šãŒ2å›æ¥ãŸã‚‰ï¼ŸğŸ’³ğŸ˜±

### ä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œæ”¯æ‰•ã„ç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“â€¦

1å›ç›®ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ±ºæ¸ˆãŒæˆåŠŸğŸ’³âœ…
ã§ã‚‚ã€ãã®ç›´å¾Œã«é€šä¿¡ãŒåˆ‡ã‚Œã¦**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‰ãªã„**ğŸ“¶ğŸ’¥
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œå¤±æ•—ã—ãŸã®ã‹ãªï¼Ÿã€ã¨æ€ã£ã¦ã€ã‚‚ã†1å›æŠ¼ã™ or è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ğŸ”ğŸ˜µ

**çµæœï¼šäºŒé‡æ±ºæ¸ˆ** ğŸ˜­ğŸ’¸ğŸ’¸
ï¼ˆã—ã‹ã‚‚é‹ãŒæ‚ªã„ã¨ã€æ³¨æ–‡ã‚‚2ã¤ä½œã‚‰ã‚ŒãŸã‚Šã€ãƒ¡ãƒ¼ãƒ«ãŒ2é€šé£›ã‚“ã ã‚Šâ€¦ğŸ“§ğŸ“§ï¼‰

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§è¦‹ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ğŸ•’

* T0: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ã€Œæ”¯æ‰•ã„ç¢ºå®šã—ã¦ï¼ã€(1å›ç›®)
* T1: ã‚µãƒ¼ãƒãƒ¼ â†’ æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã€Œèª²é‡‘ã—ã¦ï¼ã€â†’ æˆåŠŸâœ…
* T2: ã‚µãƒ¼ãƒãƒ¼ â†’ DBã€Œæ³¨æ–‡ã‚’Paidã«æ›´æ–°ã€â†’ æˆåŠŸâœ…
* T3: **é€šä¿¡æ–­**ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæˆåŠŸã‚’å—ã‘å–ã‚Œãªã„ğŸ“¶ğŸ’¥
* T4: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ã€Œæ”¯æ‰•ã„ç¢ºå®šã—ã¦ï¼ã€(2å›ç›®) ğŸ”

ã“ã®ã€ŒT4ã€ãŒæ¥ãŸç¬é–“ã€è¨­è¨ˆãŒç”˜ã„ã¨ã¾ãŸèª²é‡‘ã—ã¡ã‚ƒã†ğŸ˜±ğŸ’³ğŸ’¥

---

## ã€Œã˜ã‚ƒã‚ã€Paidã ã£ãŸã‚‰å¼¾ã‘ã°ã„ã„ã˜ã‚ƒã‚“ï¼Ÿã€ãŒç½ ğŸ˜ˆğŸª¤

ãŸã—ã‹ã«ã€Œã‚‚ã†Paidãªã‚‰ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ã€ã¯ä¸€è¦‹æ­£ã—ãã†ğŸ‘‡

* 2å›ç›®ãŒæ¥ãŸã‚‰ã€Œã™ã§ã«æ”¯æ‰•ã„æ¸ˆã¿ã§ã™ï¼ã€ã£ã¦è¿”ã™ğŸš«ğŸ’¬

ã§ã‚‚ã€ã“ã‚Œã ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ã§ã¯

* ã€Œãˆã£â€¦ã˜ã‚ƒã‚æˆåŠŸã—ãŸã®ï¼Ÿå¤±æ•—ã—ãŸã®ï¼Ÿã©ã£ã¡ï¼Ÿã€ğŸ˜µâ€ğŸ’«
* ã€Œæ³¨æ–‡å±¥æ­´ã«ã‚‚åæ˜ ã•ã‚Œã¦ãªã„æ°—ãŒã™ã‚‹â€¦ã€ğŸ˜¢

ã¿ãŸã„ã«**UXãŒåœ°ç„**ã«ãªã‚ŠãŒã¡ğŸ˜‡ğŸŒ€
æœ¬å½“ã«æ¬²ã—ã„ã®ã¯ã ã„ãŸã„ã“ã‚ŒğŸ‘‡

* 2å›ç›®ãŒæ¥ã¦ã‚‚ **â€œ1å›ç›®ã¨åŒã˜æˆåŠŸçµæœâ€** ã‚’è¿”ã—ã¦å®‰å¿ƒã•ã›ãŸã„âœ…ğŸ˜Š

---

## ã•ã‚‰ã«é‡è¦ï¼šæ¥½è¦³ãƒ­ãƒƒã‚¯ï¼ˆversionï¼‰ã§ã‚‚é˜²ã’ãªã„äº‹æ•…ãŒã‚ã‚‹ğŸ˜±ğŸ”¢

æ¥½è¦³ãƒ­ãƒƒã‚¯ã¯ã€ŒåŒæ™‚æ›´æ–°ã®ä¸Šæ›¸ãäº‹æ•…ã€ã‚’é˜²ãã®ã«å¼·ã„ğŸ›¡ï¸
ã§ã‚‚ **â€œå¤–éƒ¨å‰¯ä½œç”¨â€**ï¼ˆæ±ºæ¸ˆãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ»ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãªã©ï¼‰ãŒçµ¡ã‚€ã¨ç©´ãŒå‡ºã‚‹ğŸ’¥

### æœ€æ‚ªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šåŒæ™‚ã«2ç™ºæ¥ãŸã‚‰ï¼ŸğŸ’¥ğŸ’¥

2ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã»ã¼åŒæ™‚ã«æ¥ã‚‹ã¨â€¦ğŸ‘‡

* ãƒªã‚¯ã‚¨ã‚¹ãƒˆAï¼šæ³¨æ–‡(Pending v1)ã‚’èª­ã‚“ã 
* ãƒªã‚¯ã‚¨ã‚¹ãƒˆBï¼šæ³¨æ–‡(Pending v1)ã‚’èª­ã‚“ã ï¼ˆåŒã˜v1ï¼‰
* Aï¼šæ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã«èª²é‡‘ â†’ æˆåŠŸğŸ’³âœ…
* Bï¼šæ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã«èª²é‡‘ â†’ æˆåŠŸğŸ’³âœ…ï¼ˆã“ã“ã§äºŒé‡æ±ºæ¸ˆğŸ˜­ï¼‰
* Aï¼šæ³¨æ–‡ã‚’Paidã«ã—ã¦ä¿å­˜ â†’ æˆåŠŸï¼ˆv2ã¸ï¼‰âœ…
* Bï¼šä¿å­˜ã—ã‚ˆã†ã¨ã—ã¦versionä¸ä¸€è‡´ â†’ å¤±æ•—ğŸš«ï¼ˆã§ã‚‚èª²é‡‘ã¯ã‚‚ã†çµ‚ã‚ã£ã¦ã‚‹ğŸ˜‡ï¼‰

ã¤ã¾ã‚Šã€æ¥½è¦³ãƒ­ãƒƒã‚¯ã§DBã¯å®ˆã‚Œã¦ã‚‚ã€**æ±ºæ¸ˆã¯å®ˆã‚Œãªã„**ã“ã¨ãŒã‚ã‚‹ğŸ’³ğŸ˜±
ã“ã®ã€Œæ±ºæ¸ˆã¿ãŸã„ãªå¤–éƒ¨I/Oã®å‰¯ä½œç”¨ã€ã¯ã€å†ªç­‰æ€§ã§å®ˆã‚‹ç™ºæƒ³ãŒè¶…å¤§äº‹ã«ãªã‚‹ã‚ˆğŸ”‚ğŸ›¡ï¸

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼ (Aã•ã‚“) ğŸ§‘â€ğŸ’»
    participant S1 as ã‚µãƒ¼ãƒãƒ¼ (1å›ç›®) ğŸ—„ï¸
    participant S2 as ã‚µãƒ¼ãƒãƒ¼ (2å›ç›®) ğŸ—„ï¸
    participant Pay as å¤–éƒ¨æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ ğŸ’³
    
    User->>S1: æ”¯æ‰•ã„ç¢ºå®šä¾é ¼
    User->>S2: æ”¯æ‰•ã„ç¢ºå®šä¾é ¼ (é€£æ‰“orãƒªãƒˆãƒ©ã‚¤)
    
    S1->>Pay: 1. æ±ºæ¸ˆå‡¦ç†ã®å‘¼ã³å‡ºã—
    Note right of Pay: æ±ºæ¸ˆæˆåŠŸ âœ…
    S2->>Pay: 2. æ±ºæ¸ˆå‡¦ç†ã®å‘¼ã³å‡ºã— <br/>(ã‚­ãƒ¼ç„¡ã—ã ã¨é€šã£ã¦ã—ã¾ã†!)
    Note right of Pay: äºŒé‡èª²é‡‘!! ğŸ’¸ğŸ’¸ğŸ’¥
    
    S1->>S1: 3. æ³¨æ–‡ã‚’Paidã«æ›´æ–° (DBä¿å­˜ OK)
    S2->>S2: 4. æ³¨æ–‡ã‚’Paidã«æ›´æ–° (DBä¿å­˜ Lockã§å¤±æ•—) âŒ
    
    Note over User: DBã¯å®ˆã‚‰ã‚ŒãŸã‘ã©ã€ãŠé‡‘ã¯2å›å¼•ã‹ã‚ŒãŸ...ğŸ˜­
```

---

## å†ªç­‰æ€§ãŒç‰¹ã«å¿…è¦ãªæ“ä½œãƒªã‚¹ãƒˆğŸ“ğŸ”‚ï¼ˆãƒŸãƒ‹ECç‰ˆï¼‰

æ¬¡ã®ã©ã‚Œã‹ã«å½“ã¦ã¯ã¾ã£ãŸã‚‰ã€ã ã„ãŸã„å†ªç­‰æ€§ãŒå¿…è¦âœ¨ğŸ‘‡

### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…

* ãŠé‡‘ãŒå‹•ãğŸ’³ğŸ’¸
* åœ¨åº«ãŒå‹•ãğŸ“¦ğŸ”
* ã€Œä¸€å›ã ã‘èµ·ãã¦ã»ã—ã„ã€ã“ã¨ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãªã©ï¼‰ğŸ“§ğŸ
* å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ãŒã‚ã‚‹ï¼ˆæ±ºæ¸ˆã€é…é€ã€ç¨è¨ˆç®—ãªã©ï¼‰ğŸŒğŸ”Œ
* ãƒªãƒˆãƒ©ã‚¤ãŒèµ·ãã†ã‚‹ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯ä¿¡ç”¨ã—ãªã„ï¼‰ğŸ“¶ğŸ”

### ãƒŸãƒ‹ECã®ä¾‹ğŸ›’

* æ³¨æ–‡ç¢ºå®šï¼ˆplaceOrderï¼‰ğŸ›’âœ…
* æ”¯æ‰•ã„ç¢ºå®šï¼ˆconfirmPaymentï¼‰ğŸ’³âœ…
* åœ¨åº«å¼•å½“ï¼ˆreserveStockï¼‰ğŸ“¦âœ…
* å‡ºè·ç¢ºå®šï¼ˆshipOrderï¼‰ğŸššâœ…
* è¿”é‡‘ï¼ˆrefundï¼‰â†©ï¸ğŸ’¸
* ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼ˆgrantPointsï¼‰ğŸâœ¨
* ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆsendOrderEmailï¼‰ğŸ“§

---

## â€œå†ªç­‰ã«ã™ã‚‹â€ãŸã‚ã®ä»£è¡¨ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆã“ã®ç« ã¯æ¦‚å¿µã¾ã§ï¼‰ğŸ”‘ğŸ§ 

### 1) å†ªç­‰ã‚­ãƒ¼ï¼ˆIdempotency Key / Tokenï¼‰ã‚’ä½¿ã†ğŸ”‘âœ¨

ã€Œã“ã®æ“ä½œã¯åŒã˜ã‚­ãƒ¼ãªã‚‰1å›ã¨ã¿ãªã™ï¼ã€ã£ã¦ã„ã†æ–¹å¼ã ã‚ˆğŸ”‚
AWSã®ã‚¬ã‚¤ãƒ‰ã§ã‚‚ã€**ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¦‹ã¦é‡è¤‡ãªã‚‰ä¿å­˜æ¸ˆã¿ã®å¿œç­”ã‚’è¿”ã™**ã€ã¿ãŸã„ãªè€ƒãˆæ–¹ãŒç´¹ä»‹ã•ã‚Œã¦ã‚‹ğŸ“¦âœ… ([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])

æ±ºæ¸ˆç³»ã ã¨ã€Stripeã¿ãŸã„ã« **POSTã§ã‚‚å†ªç­‰ã‚­ãƒ¼ã§å®‰å…¨ã«ãƒªãƒˆãƒ©ã‚¤ã§ãã‚‹**è¨­è¨ˆãŒæœ‰åã ã‚ˆğŸ’³ğŸ”‚ ([Stripe ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][4])

### 2) PUTçš„ã«ã€ŒåŒã˜çµæœã«ãªã‚‹å½¢ã€ã§è¨­è¨ˆã™ã‚‹ğŸ§±

HTTPçš„ã«ã¯ PUT ã¯å†ªç­‰ã§ã‚ã‚‹ã¹ãã€ã¨ã„ã†æ•´ç†ãŒã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚ˆğŸ“Œ ([Microsoft Learn][2])
ãŸã ã€ç¾å®Ÿã®ã€Œæ”¯æ‰•ã„ç¢ºå®šã€ã¿ãŸã„ãªâ€œã‚³ãƒãƒ³ãƒ‰â€ã¯POSTã§ã‚„ã‚ŠãŒã¡ãªã®ã§ã€å†ªç­‰ã‚­ãƒ¼æ–¹å¼ãŒå‡ºç•ªã«ãªã‚Šã‚„ã™ã„ğŸ”‘âœ¨

> å®Ÿè£…ã®æœ¬ç•ªã¯æ¬¡ç« ï¼ˆç¬¬28ç« ï¼‰ã§ã‚¬ãƒƒãƒ„ãƒªã‚„ã‚‹ã‚ˆã€œï¼ğŸ› ï¸ğŸ”¥
> ã“ã®ç« ã¯ã€Œãªãœå¿…è¦ï¼Ÿã€ã¨ã€Œã©ã“ã«å¿…è¦ï¼Ÿã€ã‚’èº«ä½“ã«å…¥ã‚Œã‚‹å›ğŸ’ªğŸ˜Š

---

## æ‰‹ã‚’å‹•ã‹ã™ğŸ§ªâœ¨ï¼šäºŒé‡é€ä¿¡ã§å£Šã‚Œã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ï¼ˆã‚ã–ã¨å£Šã™ğŸ˜ˆğŸ§¨ï¼‰

## ã‚´ãƒ¼ãƒ«ğŸ¯

* **äºŒé‡é€ä¿¡ãŒèµ·ããŸã‚‰ä½•ãŒãƒ€ãƒ¡ã‹**ã‚’ã€ãƒ†ã‚¹ãƒˆã§â€œè¦‹ãˆã‚‹åŒ–â€ã™ã‚‹ğŸ‘€ğŸ§ª
* æ¬¡ç« ã§ã€Œå†ªç­‰ã«ã™ã‚‹ã€ãŸã‚ã®**æœŸå¾…ä»•æ§˜**ã‚’å…ˆã«æ›¸ãâœï¸âœ…

---

## ã‚¹ãƒ†ãƒƒãƒ—1ï¼šä»Šå›ã®æœ€å°ãƒ¢ãƒ‡ãƒ«ï¼ˆæ”¯æ‰•ã„ç¢ºå®šã ã‘ï¼‰ğŸ’³ğŸ“¦

ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ğŸ‘‡

* Orderï¼ˆæ³¨æ–‡ï¼‰ã¯ `paymentStatus: "Pending" | "Paid"` ã‚’æŒã¤
* ã€Œæ”¯æ‰•ã„ç¢ºå®šã€ã¯å¤–éƒ¨ã® `PaymentGateway` ã‚’å‘¼ã¶ï¼ˆï¼å‰¯ä½œç”¨ï¼‰
* ã„ã¾ã¯å†ªç­‰æ€§ã‚¼ãƒ­ï¼ˆã‚ã–ã¨ï¼‰ğŸ˜ˆ

```typescript
// domain/order.ts
export type PaymentStatus = "Pending" | "Paid";

export class Order {
  constructor(
    public readonly id: string,
    public paymentStatus: PaymentStatus,
    public paidTransactionId: string | null,
    public version: number,
  ) {}

  markPaid(txId: string) {
    // ã„ã£ãŸã‚“è¶…å˜ç´”ï¼ˆã“ã®ç« ã§ã¯ â€œãªãœå¿…è¦ã‹â€ ãŒä¸»å½¹ãªã®ã§ï¼‰
    this.paymentStatus = "Paid";
    this.paidTransactionId = txId;
  }
}
```

```typescript
// application/paymentGateway.ts
export interface PaymentGateway {
  charge(orderId: string, amountYen: number): Promise<{ transactionId: string }>;
}
```

```typescript
// application/orderRepository.ts
import { Order } from "../domain/order";

export interface OrderRepository {
  findById(id: string): Promise<Order | null>;
  save(order: Order): Promise<void>;
}
```

```typescript
// application/confirmPaymentUseCase.ts
import { OrderRepository } from "./orderRepository";
import { PaymentGateway } from "./paymentGateway";

export class ConfirmPaymentUseCase {
  constructor(
    private readonly repo: OrderRepository,
    private readonly gateway: PaymentGateway,
  ) {}

  async execute(input: { orderId: string; amountYen: number }) {
    const order = await this.repo.findById(input.orderId);
    if (!order) throw new Error("OrderNotFound");

    // ã“ã“ãŒ â€œç´ æœ´è¨­è¨ˆâ€ ã®ã¾ã¾ãªã®ãŒãƒã‚¤ãƒ³ãƒˆğŸ˜‡
    // äºŒé‡é€ä¿¡ãŒæ¥ãŸã‚‰ã€ã¾ãŸ gateway.charge() ã—ã¦ã—ã¾ã†å±é™ºãŒã‚ã‚‹ğŸ’³ğŸ’¥
    const res = await this.gateway.charge(order.id, input.amountYen);

    order.markPaid(res.transactionId);
    order.version += 1;

    await this.repo.save(order);

    return { orderId: order.id, transactionId: res.transactionId };
  }
}
```

---

## ã‚¹ãƒ†ãƒƒãƒ—2ï¼šãƒ†ã‚¹ãƒˆã§ã€ŒäºŒé‡é€ä¿¡ã™ã‚‹ã¨äºŒé‡èª²é‡‘ã£ã½ããªã‚‹ã€ã‚’å†ç¾ğŸ˜±ğŸ’³ğŸ’¥

`FakePaymentGateway` ãŒå‘¼ã°ã‚ŒãŸå›æ•°ã‚’æ•°ãˆã¦ã€2å›èª²é‡‘ã•ã‚Œã¡ã‚ƒã†é›°å›²æ°—ã‚’ä½œã‚‹ã‚ˆğŸ§ªğŸ”

```typescript
// tests/confirmPayment.doubleSubmit.spec.ts
import { ConfirmPaymentUseCase } from "../application/confirmPaymentUseCase";
import { Order } from "../domain/order";
import type { OrderRepository } from "../application/orderRepository";
import type { PaymentGateway } from "../application/paymentGateway";

class InMemoryOrderRepo implements OrderRepository {
  private store = new Map<string, Order>();

  seed(order: Order) {
    this.store.set(order.id, order);
  }

  async findById(id: string) {
    return this.store.get(id) ?? null;
  }

  async save(order: Order) {
    // è¶…ç°¡æ˜“ï¼ˆversionæ•´åˆãªã©ã¯ç¬¬26ç« ã§æ‰±ã£ãŸæƒ³å®šï¼‰
    this.store.set(order.id, order);
  }
}

class FakePaymentGateway implements PaymentGateway {
  public chargeCount = 0;

  async charge(orderId: string, amountYen: number) {
    this.chargeCount += 1;
    return { transactionId: `tx_${orderId}_${this.chargeCount}` };
  }
}

test("äºŒé‡é€ä¿¡ã§ã€èª²é‡‘ãŒ2å›èµ°ã£ã¦ã—ã¾ã†ï¼ˆå†ªç­‰æ€§ãŒãªã„ä¸–ç•ŒğŸ˜‡ï¼‰", async () => {
  const repo = new InMemoryOrderRepo();
  repo.seed(new Order("order-1", "Pending", null, 1));

  const gw = new FakePaymentGateway();
  const useCase = new ConfirmPaymentUseCase(repo, gw);

  await useCase.execute({ orderId: "order-1", amountYen: 1000 });
  await useCase.execute({ orderId: "order-1", amountYen: 1000 }); // ğŸ” äºŒé‡é€ä¿¡ã®ã¤ã‚‚ã‚Š

  expect(gw.chargeCount).toBe(2); // ğŸ˜±ğŸ’³ğŸ’¥
});
```

ã“ã®ãƒ†ã‚¹ãƒˆã® `expect(gw.chargeCount).toBe(2)` ãŒé€šã‚‹ã®ãŒã€**â€œäº‹æ•…ãŒèµ·ãã‚‹è¨­è¨ˆâ€**ã ã‚ˆğŸ˜‡ğŸ§¨
ï¼ˆã€Œãˆã€ã“ã‚Œæ™®é€šã«èµ·ãã‚‹ã®â€¦ï¼Ÿã€ã£ã¦æ€ã£ãŸã‚‰å‹ã¡ğŸ‰ï¼‰

---

## ã‚¹ãƒ†ãƒƒãƒ—3ï¼šæ¬¡ç« ã®ãŸã‚ã«ã€Œã“ã†ãªã£ã¦ã»ã—ã„ã€ä»•æ§˜ã‚’æ›¸ã„ã¦ãŠãâœï¸âœ…

ç†æƒ³ã¯ã ã„ãŸã„ã“ã†ğŸ‘‡

* äºŒé‡é€ä¿¡ãŒæ¥ã¦ã‚‚èª²é‡‘ã¯1å›ã ã‘
* 2å›ç›®ã¯ã€Œ1å›ç›®ã¨åŒã˜çµæœã€ã‚’è¿”ã™ï¼ˆå®‰å¿ƒUXğŸ˜Šï¼‰

æ¬¡ç« ã§å†ªç­‰ã‚­ãƒ¼ã‚’å…¥ã‚ŒãŸã‚‰ã€ã“ã‚Œã‚’é€šã—ã«è¡Œãã‚ˆğŸ› ï¸ğŸ”¥

```typescript
test("ç†æƒ³ï¼šäºŒé‡é€ä¿¡ã§ã‚‚èª²é‡‘ã¯1å›ã§ã€çµæœã¯åŒã˜ï¼ˆæ¬¡ç« ã§å®Ÿç¾ğŸ”‘âœ¨ï¼‰", async () => {
  // ã“ã“ã¯ â€œæœŸå¾…ä»•æ§˜â€ ã ã‘å…ˆã«ç½®ãã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ“
  // ç¬¬28ç« ã§ Idempotency Key ã‚’å…¥ã‚ŒãŸã‚‰é€šã™ï¼ğŸ’ª
  expect(true).toBe(true);
});
```

---

## AIæ´»ç”¨ğŸ¤–âœ¨ï¼šã“ã®ç« ã§ä½¿ã†ã¨å¼·ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼ˆã‚³ãƒ”ãƒšOKğŸ“ï¼‰

* ã€ŒãƒŸãƒ‹ECã§äºŒé‡é€ä¿¡ãŒèµ·ãã‚‹ã‚±ãƒ¼ã‚¹ã‚’10å€‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ã§æŒ™ã’ã¦ã€‚æ±ºæ¸ˆ/åœ¨åº«/ãƒ¡ãƒ¼ãƒ«/é…é€ã‚’æ··ãœã¦ã€ğŸ¤–ğŸ“
* ã€Œâ€œæ¥½è¦³ãƒ­ãƒƒã‚¯ã§ã¯é˜²ã’ãªã„äºŒé‡å®Ÿè¡Œâ€ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¾‹ã‚’3ã¤ã€ã‚ã‹ã‚Šã‚„ã™ãæ›¸ã„ã¦ã€ğŸ¤–ğŸ•’
* ã€Œæ”¯æ‰•ã„ç¢ºå®šã®å†ªç­‰æ€§ãŒå¿…è¦ãªç†ç”±ã‚’ã€åˆå¿ƒè€…å‘ã‘ã«æ¯”å–©ã§èª¬æ˜ã—ã¦ã€ğŸ¤–ğŸ€
* ã€ŒGiven-When-Thenã§ã€äºŒé‡é€ä¿¡ãƒ†ã‚¹ãƒˆã®è¦³ç‚¹ã‚’å¢—ã‚„ã—ã¦ï¼ˆå¢ƒç•Œå€¤ã‚‚ï¼‰ã€ğŸ¤–ğŸ§ª

---

## ç« æœ«ãƒã‚§ãƒƒã‚¯âœ…ğŸ“ï¼ˆã‚µã‚¯ãƒƒã¨ï¼‰

1. äºŒé‡é€ä¿¡ãŒèµ·ãã‚‹ã®ã¯ã€ã©ã‚“ãªã¨ãï¼Ÿï¼ˆ3ã¤è¨€ãˆãŸã‚‰OKï¼‰ğŸ“¡ğŸ”
2. æ¥½è¦³ãƒ­ãƒƒã‚¯ãŒå¾—æ„ãªã®ã¯ä½•ï¼Ÿè‹¦æ‰‹ãªã®ã¯ä½•ï¼ŸğŸ”¢ğŸ›¡ï¸
3. ãƒŸãƒ‹ECã§ã€Œå†ªç­‰æ€§ãŒå¿…è¦ãªæ“ä½œã€ã‚’5ã¤æŒ™ã’ã¦ã¿ã‚ˆã†ğŸ›’ğŸ“¦ğŸ’³
4. ã€ŒäºŒé‡é€ä¿¡ã§ã‚‚åŒã˜æˆåŠŸçµæœã‚’è¿”ã—ãŸã„ã€ç†ç”±ã‚’1ã¤èª¬æ˜ã—ã¦ã¿ã‚ˆã†ğŸ˜Šâœ…

---

## ã¾ã¨ã‚ğŸ§ºâœ¨

* äºŒé‡é€ä¿¡ã¯â€œæ™®é€šã«èµ·ãã‚‹â€ã‹ã‚‰ã€è¨­è¨ˆã§å—ã‘æ­¢ã‚ã‚‹ã®ãŒå‰æğŸ”ğŸ“¡
* å†ªç­‰æ€§ã¯ã€ŒåŒã˜æ“ä½œã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚‚çµæœãŒåŒã˜ã€ã£ã¦æ€§è³ªğŸ”‚âœ… ([rfc-editor.org][1])
* PUTã¯å†ªç­‰ã¨ã—ã¦æ‰±ã‚ã‚Œã‚„ã™ã„ä¸€æ–¹ã€POSTã¯å†ªç­‰ãŒä¿è¨¼ã•ã‚Œãªã„ã“ã¨ãŒå¤šã„ğŸ“®âš™ï¸ ([Microsoft Learn][2])
* å¤–éƒ¨å‰¯ä½œç”¨ï¼ˆæ±ºæ¸ˆãªã©ï¼‰ã¯ã€æ¥½è¦³ãƒ­ãƒƒã‚¯ã ã‘ã ã¨å®ˆã‚Œãªã„ç©´ãŒã‚ã‚‹ğŸ’³ğŸ˜±
* ãã“ã§å†ªç­‰ã‚­ãƒ¼ï¼ˆIdempotency Key/Tokenï¼‰ã¿ãŸã„ãªä»•çµ„ã¿ãŒè¶…é‡è¦ã«ãªã‚‹ğŸ”‘âœ¨ï¼ˆæ¬¡ç« ã§å®Ÿè£…ï¼ï¼‰ ([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])

[1]: https://www.rfc-editor.org/rfc/rfc9110.html?utm_source=chatgpt.com "RFC 9110: HTTP Semantics"
[2]: https://learn.microsoft.com/en-us/azure/architecture/best-practices/api-design?utm_source=chatgpt.com "Web API Design Best Practices - Azure Architecture Center"
[3]: https://docs.aws.amazon.com/wellarchitected/latest/reliability-pillar/rel_prevent_interaction_failure_idempotent.html?utm_source=chatgpt.com "REL04-BP04 Make mutating operations idempotent"
[4]: https://docs.stripe.com/api/idempotent_requests?utm_source=chatgpt.com "Idempotent requests | Stripe API Reference"
