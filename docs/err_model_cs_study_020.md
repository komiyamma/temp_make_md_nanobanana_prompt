# ç¬¬20ç« ï¼šã‚¤ãƒ³ãƒ•ãƒ©ã§ä¾‹å¤–ãŒå‡ºãŸã¨ãã®æ–¹é‡ï¼ˆå¤‰æ›ãƒ«ãƒ¼ãƒ«ï¼‰ğŸ§¯â¡ï¸ğŸ

ã“ã®ç« ãŒçµ‚ã‚ã‚‹ã¨ã€**DB/HTTP/å¤–éƒ¨APIãªã©ã®ã€ŒI/Oå±¤ã§èµ·ããŸä¾‹å¤–ã€ã‚’ã€æ¯å›ãƒ–ãƒ¬ãšã« Result ã«å¤‰æ›**ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ˜Šâœ¨
ãã—ã¦ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º**ã¨**ãƒ­ã‚°**ã‚’ã‚­ãƒ¬ã‚¤ã«åˆ†ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ï¼ğŸ«¶ğŸ§¾

---

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* âœ… ã‚¤ãƒ³ãƒ•ãƒ©ä¾‹å¤–ã‚’ **ã€Œã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼Resultã€** ã«å¤‰æ›ã™ã‚‹â€œå‹â€ã‚’æŒã¤ğŸ
* âœ… **Transientï¼ˆä¸€æ™‚çš„ï¼‰/ Permanentï¼ˆæ’ä¹…çš„ï¼‰** ã‚’åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ğŸŒ©ï¸â¡ï¸â˜€ï¸
* âœ… **ãƒ­ã‚°ã«æ®‹ã™ç²’åº¦**ã‚’æ±ºã‚ã‚‹ï¼ˆå¤šã™ã/å°‘ãªã™ãé˜²æ­¢ï¼‰ğŸ”
* âœ… ã€Œå¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ï¼ˆãƒãƒƒãƒ—ï¼‰ã€ã‚’ä½œã‚Œã‚‹ğŸ“‹âœ¨

---

## ã¾ãšçµè«–ï¼šå¤‰æ›ãƒ«ãƒ¼ãƒ«ã®åŸºæœ¬ã€Œ7ã¤ã€ğŸ§ ğŸ§·

1. **ã‚¤ãƒ³ãƒ•ãƒ©ä¾‹å¤–ã¯ã€ãã®ã¾ã¾ä¸Šã«æŠ•ã’ãªã„**ğŸ™…â€â™€ï¸
   â†’ ä¸Šã®å±¤ã¯ã€Œä¾‹å¤–ã®ç¨®é¡ã€ã˜ã‚ƒãªãã¦ã€Œå¤±æ•—ã®æ„å‘³ã€ã‚’çŸ¥ã‚ŠãŸã„ã®ã€‚

2. **ä¾‹å¤–â†’Resultå¤‰æ›ã¯â€œ1ã‹æ‰€ã«é›†ã‚ã‚‹â€**ğŸ“
   â†’ ã„ã‚ã‚“ãªæ‰€ã§ `catch` ã—ã¦ãƒãƒ©ãƒãƒ©å¤‰æ›ã™ã‚‹ã¨ã€åœ°ç„åŒ–ã™ã‚‹ğŸ˜‡

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ–‡è¨€ã«ã€ä¾‹å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ã‚ãªã„**ğŸš«ğŸ§¨
   â†’ ä¾‹å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å†…éƒ¨æƒ…å ±ãƒ»è‹±èªãƒ»ä¸å®‰ã‚’ç…½ã‚‹ã€ã«ãªã‚ŠãŒã¡ã€‚

4. Resultã®å¤±æ•—ã«ã¯æœ€ä½ã§ã‚‚ã“ã‚Œã‚’å…¥ã‚Œã‚‹ğŸ§¾

* `Code`ï¼ˆå›ºå®šã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼‰ğŸ·ï¸
* `UserMessage`ï¼ˆå„ªã—ã„è¡¨ç¤ºæ–‡è¨€ï¼‰ğŸ’¬
* `Retryable`ï¼ˆå†è©¦è¡Œã—ã¦è‰¯ã„ï¼Ÿï¼‰ğŸ”
* `ActionHint`ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¿ƒã™è¡Œå‹•ï¼‰ğŸ«¶

5. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ä¸€æ™‚çš„ãƒãƒƒãƒˆä¸å®‰å®šã¯ â€œretryable: trueâ€ ãŒåŸºæœ¬**â³ğŸ”
   ï¼ˆãŸã ã—å›æ•°ãƒ»é–“éš”ã¯åˆ¥é€”ã‚¬ãƒ¼ãƒ‰ï¼ï¼‰

6. **ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ â€œéšœå®³â€ ã§ã¯ãªã â€œæ“ä½œçµæœâ€**ğŸ›‘ğŸ™‚
   â†’ ãƒ­ã‚°ã¯ Error ã«ã—ãªã„ã“ã¨ãŒå¤šã„ï¼ˆInfo/Debugå¯„ã‚Šï¼‰

7. **ãƒ­ã‚°ã«ã¯ã€Œä¾‹å¤–ï¼‹ç›¸é–¢IDï¼‹å¤–éƒ¨ä¾å­˜åï¼‹æ“ä½œåã€ã‚’æ®‹ã™**ğŸ”ğŸ§µ
   â†’ å¾Œã‹ã‚‰è¿½ãˆã‚‹ã‹ãŒå…¨ã¦ï¼

---

## æˆæœç‰©ğŸ“„âœ¨ï¼šå¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ï¼ˆãƒŸãƒ‹ç‰ˆï¼‰

![Translation Map](./picture/err_model_cs_study_020_translation_map.png)

æœ€åˆã¯ã“ã‚Œãã‚‰ã„ã®ç²’åº¦ã§OKã ã‚ˆğŸ˜ŠğŸ“‹

* `INFRA_HTTP_TIMEOUT` â³

  * Retryable: âœ…
  * UserMessage: ã€Œé€šä¿¡ãŒæ··ã¿åˆã£ã¦ã‚‹ã¿ãŸã„â€¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ğŸ™ã€
  * ActionHint: ã€Œå°‘ã—å¾…ã£ã¦å†è©¦è¡Œã€
* `INFRA_HTTP_UNREACHABLE` ğŸŒ

  * Retryable: âœ…
  * UserMessage: ã€Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã§ããªã„ã¿ãŸã„â€¦ğŸ›œã€
  * ActionHint: ã€Œå›ç·šç¢ºèªâ†’å†è©¦è¡Œã€
* `INFRA_HTTP_RATE_LIMIT` ğŸš¦

  * Retryable: âœ…ï¼ˆãŸã ã—å¾…ã¡æ™‚é–“ã‚ã‚Šï¼‰
  * UserMessage: ã€Œã‚¢ã‚¯ã‚»ã‚¹ãŒé›†ä¸­ã—ã¦ã‚‹ã‚ˆğŸ’¦ å°‘ã—å¾…ã£ã¦ã­ã€
  * ActionHint: ã€Œæ•°ç§’ã€œæ•°åç§’å¾…ã¤ã€
* `INFRA_DB_TRANSIENT` ğŸ—„ï¸ğŸŒ©ï¸

  * Retryable: âœ…
  * UserMessage: ã€ŒãŸã ã„ã¾ä¿å­˜ãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸã‚ˆâ€¦ã‚‚ã†ä¸€åº¦ğŸ™ã€
* `INFRA_DB_UNAVAILABLE` ğŸ—„ï¸ğŸ› ï¸

  * Retryable: âœ…/âŒï¼ˆçŠ¶æ³æ¬¡ç¬¬ï¼‰
  * UserMessage: ã€ŒãŸã ã„ã¾ã‚·ã‚¹ãƒ†ãƒ ãŒæ··ã¿åˆã£ã¦ã‚‹ã‚ˆğŸ’¦ã€

---

## â€œå¤‰æ›å…ˆâ€ã®ã‚¨ãƒ©ãƒ¼å‹ï¼ˆä¾‹ï¼‰ğŸ§·âœ¨

â€»ç¬¬14ã€œ17ç« ã§ä½œã£ãŸã‚¨ãƒ©ãƒ¼å‹ã®æµã‚Œã‚’å¼•ãç¶™ãæ„Ÿã˜ã§OKã ã‚ˆğŸ˜Š

```csharp
public sealed record InfraError(
    string Code,
    string UserMessage,
    bool Retryable,
    string ActionHint,
    string? DetailForLog = null,     // å†…éƒ¨å‘ã‘ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ãªã„ï¼‰
    int? HttpStatus = null           // HTTPç³»ãªã‚‰ä¾¿åˆ©ï¼ˆæ¬¡ç« ã§æ´»èºï¼‰
);
```

---

## å¤‰æ›ã®â€œç½®ãå ´æ‰€â€ã¯ã“ã“ãŒå®‰å®šğŸ˜ŠğŸ“

ãŠã™ã™ã‚ã¯ã“ã®ã©ã¡ã‚‰ã‹ï¼š

### A) ã‚¤ãƒ³ãƒ•ãƒ©ã‚¢ãƒ€ãƒ—ã‚¿ã®å‡ºå£ã§å¤‰æ›ï¼ˆã„ã¡ã°ã‚“åˆ†ã‹ã‚Šã‚„ã™ã„ï¼‰ğŸ§±

* Repository / ApiClient ã®ä¸­ã§ `try/catch` ã—ã¦ `Result.Fail(InfraError)` ã‚’è¿”ã™

### B) å¢ƒç•Œï¼ˆã‚¢ãƒ—ãƒªå±¤ã®å…¥å£/å‡ºå£ï¼‰ã«é›†ç´„ã—ã¦å¤‰æ›ğŸšª

* ã‚¤ãƒ³ãƒ•ãƒ©ã¯ä¾‹å¤–ã‚’æŠ•ã’ã¦ã‚‚OKï¼ˆãŸã ã—æœ€çµ‚çš„ã«å¢ƒç•Œã§å¿…ãšå¤‰æ›ï¼‰

åˆå¿ƒè€…å‘ã‘ã«ã¯ **AãŒç†è§£ã—ã‚„ã™ã„**ã‚ˆğŸ˜Šâœ¨ï¼ˆã¾ãšã¯Aã§OKï¼ï¼‰

---

## HTTPï¼ˆHttpClientï¼‰ã§ã‚ˆãã‚ã‚‹ä¾‹å¤– â†’ å¤‰æ›ãƒ«ãƒ¼ãƒ«ğŸŒğŸ§¯

### 1) ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¤å®šã®â€œå®šç•ªâ€â³

æœ€è¿‘ã® .NET ã§ã¯ã€**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã« TaskCanceledException ãŒé£›ã³ã€InnerException ãŒ TimeoutException ã«ãªã‚‹**ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã‚ˆï¼ˆè¦‹åˆ†ã‘ã«ä½¿ãˆã‚‹ï¼‰ğŸ§ âœ¨ ([Microsoft Learn][1])

```csharp
public static InfraError MapHttpException(Exception ex)
{
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    if (ex is TaskCanceledException tce && tce.InnerException is TimeoutException)
    {
        return new InfraError(
            Code: "INFRA_HTTP_TIMEOUT",
            UserMessage: "é€šä¿¡ãŒæ··ã¿åˆã£ã¦ã‚‹ã¿ãŸã„â€¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ğŸ™â³",
            Retryable: true,
            ActionHint: "å°‘ã—å¾…ã£ã¦å†è©¦è¡Œã—ã¦ã­",
            DetailForLog: ex.ToString()
        );
    }

    // æ‰‹å‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ/ã‚­ãƒ£ãƒ³ã‚»ãƒ«Tokenï¼‰
    if (ex is OperationCanceledException)
    {
        return new InfraError(
            Code: "INFRA_HTTP_CANCELED",
            UserMessage: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‚ˆğŸ™‚",
            Retryable: false,
            ActionHint: "å¿…è¦ãªã‚‰ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã—ã¦ã­",
            DetailForLog: ex.ToString()
        );
    }

    // ãã®ä»–ã¯ã²ã¨ã¾ãšé€šä¿¡å¤±æ•—æ‰±ã„
    return new InfraError(
        Code: "INFRA_HTTP_FAILED",
        UserMessage: "é€šä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸâ€¦é›»æ³¢ã‚„å›ç·šã‚’ç¢ºèªã—ã¦ã­ğŸ›œğŸ’¦",
        Retryable: true,
        ActionHint: "å›ç·šç¢ºèªâ†’å†è©¦è¡Œ",
        DetailForLog: ex.ToString()
    );
}
```

### 2) â€œç›¸æ‰‹ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸâ€ã¯ã€StatusCode ã‚’è¦‹ã¦åˆ†é¡ã§ãã‚‹ğŸ§¾

`EnsureSuccessStatusCode()` ã‚’ä½¿ã†ã¨ `HttpRequestException` ãŒé£›ã¶ã‚“ã ã‘ã©ã€æœ€è¿‘ã® .NET ã§ã¯ **StatusCode ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã§åˆ¤å®šã§ãã‚‹ã‚ˆğŸ˜Š ([Microsoft Learn][1])

* 429ï¼ˆRate Limitï¼‰â†’ å¾…ã£ã¦ã‹ã‚‰ retry âœ… ğŸš¦
* 503/502 â†’ ä¸€æ™‚éšœå®³ã£ã½ã„ã®ã§ retry âœ… ğŸŒ©ï¸
* 401/403 â†’ èªè¨¼/æ¨©é™ã®å¯èƒ½æ€§ï¼ˆåŸºæœ¬ retry âŒï¼‰ğŸ”

---

## HTTPã¯ã€Œãƒªãƒˆãƒ©ã‚¤ã§ç›´ã›ã‚‹å¤±æ•—ã€ã‚’å…ˆã«æ¸›ã‚‰ã™ã®ãŒå¼·ã„ğŸ’ªğŸ”

`Microsoft.Extensions.Http.Resilience` ã§ **æ¨™æº–ã®å›å¾©æˆ¦ç•¥ï¼ˆãƒªãƒˆãƒ©ã‚¤ç­‰ï¼‰**ã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹ã‚ˆğŸ˜Š
`AddStandardResilienceHandler` ãŒç”¨æ„ã•ã‚Œã¦ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆâœ¨ ([Microsoft Learn][2])

> ãŸã ã—ï¼
> **ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚ãƒ€ãƒ¡ã ã£ãŸæœ€å¾Œã®å¤±æ•—**ã¯ã€ä»Šå›ã®ç« ã©ãŠã‚Š **Resultã«å¤‰æ›**ã—ã¦ä¸Šã¸æ¸¡ã™ã®ãŒã‚­ãƒ¬ã‚¤ğŸâœ¨

---

## DBï¼ˆEF Core / SqlClientï¼‰ã§ã‚ˆãã‚ã‚‹å¤±æ•— â†’ å¤‰æ›ãƒ«ãƒ¼ãƒ«ğŸ—„ï¸ğŸ§¯

### 1) EF Core ã¯ã€Œæ¥ç¶šå›å¾©ï¼ˆãƒªãƒˆãƒ©ã‚¤ï¼‰ã€ã®ä»•çµ„ã¿ãŒã‚ã‚‹ğŸ”

EF Core ã® â€œConnection Resiliencyâ€ ã¯ã€**ä¸€æ™‚çš„ãªå¤±æ•—ã‚’æ¤œçŸ¥ã—ã¦å†è©¦è¡Œã™ã‚‹**è€ƒãˆæ–¹ã ã‚ˆğŸ˜Š ([Microsoft Learn][3])

* ã¾ãšã¯ **ãƒªãƒˆãƒ©ã‚¤ã§æ•‘ã†**
* ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ **INFRA_DB_TRANSIENT / INFRA_DB_UNAVAILABLE** ã«å¤‰æ›ğŸ

### 2) SqlClient å´ã«ã‚‚ã€Œè¨­å®šå¯èƒ½ãªãƒªãƒˆãƒ©ã‚¤ã€æ©Ÿèƒ½ãŒã‚ã‚‹ğŸ§°

SqlClient ã«ã¯ **Configurable Retry Logic** ãŒã‚ã£ã¦ã€transient ã‚¨ãƒ©ãƒ¼ç•ªå·ãªã©ã‚’ä½¿ã£ã¦åˆ¶å¾¡ã§ãã‚‹ã‚ˆğŸ§  ([Microsoft Learn][4])

ï¼ˆåˆå¿ƒè€…å‘ã‘ã®çµè«–ï¼‰
â¡ï¸ **â€œãƒªãƒˆãƒ©ã‚¤ã§æ•‘ã†â€ ã¨ â€œæœ€å¾Œã¯Resultå¤‰æ›â€ ã‚’ã‚»ãƒƒãƒˆ**ã§è¦šãˆã‚‹ã®ãŒæœ€å¼·âœ¨

---

## ãƒ­ã‚°ç²’åº¦ã®æ–¹é‡ï¼ˆã“ã“è¶…å¤§äº‹ï¼ï¼‰ğŸ”ğŸ§µ

.NET ã¯ `ILogger` ã§ **æ§‹é€ åŒ–ãƒ­ã‚°**ã‚’å‰æã«ã§ãã‚‹ã‚ˆğŸ˜Š ([Microsoft Learn][5])

### ã¾ãšâ€œæ®‹ã™é …ç›®â€ãƒ†ãƒ³ãƒ—ãƒ¬ğŸ§¾âœ¨

* `CorrelationId` ğŸ§µï¼ˆæ¬¡ç« ä»¥é™ã§æœ¬æ ¼ï¼‰
* `ErrorCode` ğŸ·ï¸ï¼ˆINFRA_ã€œï¼‰
* `Dependency` ğŸŒ/ğŸ—„ï¸ï¼ˆã©ã®å¤–éƒ¨ï¼Ÿï¼‰
* `Operation` ğŸ§°ï¼ˆä½•ã‚’ã—ã¦ãŸï¼Ÿï¼‰
* `Retryable` ğŸ”
* `DurationMs` â±ï¸
* `ExceptionType` ğŸ§¯
* `HttpStatus`ï¼ˆã‚ã‚Œã°ï¼‰ğŸ§¾

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®ã–ã£ãã‚ŠåŸºæº–ğŸ“Œ

* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼š**Information** ğŸ›‘ğŸ™‚
* ä¸€æ™‚éšœå®³ï¼ˆtimeout/503ç­‰ï¼‰ï¼š**Warning** â³âš ï¸
* æ’ä¹…çš„/è¨­å®šãƒŸã‚¹/è‡´å‘½ï¼š**Error** ğŸ’¥

---

## å®Ÿè£…ã®å‹ï¼šResultã«å¤‰æ›ã—ã¦è¿”ã™ğŸâœ¨

```csharp
public async Task<Result<Order>> PlaceOrderAsync(...)
{
    try
    {
        // ä¾‹ï¼šå¤–éƒ¨APIå‘¼ã³å‡ºã—
        var res = await _client.SendAsync(...);

        // ç›¸æ‰‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¾‹å¤–ã«ã—ãŸã„ãªã‚‰ã“ã‚Œ
        res.EnsureSuccessStatusCode();

        // ä¾‹ï¼šDBä¿å­˜
        await _db.SaveChangesAsync();

        return Result.Success(order);
    }
    catch (Exception ex)
    {
        var infraError = _infraErrorMapper.Map(ex, dependency: "OrderApi/SqlDb", operation: "PlaceOrder");
        _logger.Log(infraError.Retryable ? LogLevel.Warning : LogLevel.Error, ex,
            "Infra failure. Code={Code} Dep={Dep} Op={Op} Retryable={Retryable}",
            infraError.Code, "OrderApi/SqlDb", "PlaceOrder", infraError.Retryable);

        return Result.Fail<Order>(infraError);
    }
}
```

> ã“ã“ã§ã®ã‚­ãƒ¢ã¯ã­ğŸ‘‡
> **ã€Œä¾‹å¤–ã®ç¨®é¡ã€â†’ã€Œå¤±æ•—ã®æ„å‘³ï¼ˆã‚³ãƒ¼ãƒ‰/å†è©¦è¡Œ/è¡Œå‹•ï¼‰ã€ã«ç¿»è¨³ã—ã¦è¿”ã™**ã“ã¨ğŸâœ¨

---

## ãƒŸãƒ‹æ¼”ç¿’ğŸ§ªâœ¨ï¼ˆDB/HTTPå¤±æ•—ã‚’ã€Œè¡¨ç¤ºã€ã¨ã€Œãƒ­ã‚°ã€ã«åˆ†é…ã—ã‚ˆã†ï¼‰

### ãŠé¡ŒğŸ€

ã€Œè³¼å…¥å‡¦ç†ã€ã§å¤±æ•—ã—ãŸã¨ãã«ğŸ‘‡ã‚’ä½œã£ã¦ã¿ã¦ã­ğŸ˜Š

1. `InfraError` ã®ã‚³ãƒ¼ãƒ‰ã‚’æ±ºã‚ã‚‹ğŸ·ï¸
2. `UserMessage` ã‚’ **ã‚„ã•ã—ã„æ—¥æœ¬èª**ã§ä½œã‚‹ğŸ’¬
3. `DetailForLog` ã« **ä¾‹å¤–å…¨æ–‡**ã‚’å…¥ã‚Œã‚‹ğŸ§¯
4. `Retryable` ã¨ `ActionHint` ã‚’æ±ºã‚ã‚‹ğŸ”ğŸ«¶

### ã‚±ãƒ¼ã‚¹Aï¼šHTTPã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ³

* è¡¨ç¤ºï¼šä¸å®‰ã‚’ç…½ã‚‰ãªã„
* ãƒ­ã‚°ï¼šç›¸é–¢IDã€æ“ä½œåã€Durationã€ä¾‹å¤–å…¨æ–‡

### ã‚±ãƒ¼ã‚¹Bï¼šDBä¸€æ™‚éšœå®³ï¼ˆæ¥ç¶šãŒç¬æ–­ï¼‰ğŸŒ©ï¸

* è¡¨ç¤ºï¼šã€Œã‚‚ã†ä¸€åº¦ã€ã§OK
* ãƒ­ã‚°ï¼šDBåã€ã‚³ãƒãƒ³ãƒ‰ç¨®åˆ¥ã€ãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼ˆåˆ†ã‹ã‚‹ãªã‚‰ï¼‰

---

## AIæ´»ç”¨ã‚³ãƒ¼ãƒŠãƒ¼ğŸ¤–âœ¨ï¼ˆã“ã®ç« ã«åŠ¹ãä½¿ã„æ–¹ï¼‰

### 1) ä¾‹å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ´—ã„å‡ºã—ï¼ˆæ¼ã‚Œé˜²æ­¢ï¼‰âœ…

* ã€ŒHttpClient ã§èµ·ã“ã‚ŠãŒã¡ãªä¾‹å¤–ã‚’åˆ—æŒ™ã—ã¦ã€timeout/ãƒãƒƒãƒˆä¸é€š/ç›¸æ‰‹ã‚¨ãƒ©ãƒ¼ã«åˆ†é¡ã—ã¦ã€

### 2) å¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ã®å©ãå°ã‚’ä½œã‚‹ğŸ“‹

* ã€ŒINFRA_ç³»ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰æ¡ˆã‚’10å€‹ã€UserMessageã¯ã‚„ã•ã—ã„æ—¥æœ¬èªã§ã€

### 3) ãƒ­ã‚°é …ç›®ãƒ¬ãƒ“ãƒ¥ãƒ¼å½¹ğŸ‘€

* ã€Œã“ã®ãƒ­ã‚°é …ç›®ã§ã€å¾Œã‹ã‚‰åŸå› è¿½è·¡ã§ãã‚‹ï¼Ÿä¸è¶³ãŒã‚ã‚Œã°è¿½åŠ æ¡ˆã‚’å‡ºã—ã¦ã€

---

## ã¾ã¨ã‚ğŸµğŸ˜Š

* ã‚¤ãƒ³ãƒ•ãƒ©ä¾‹å¤–ã¯ **Resultã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ã«ç¿»è¨³**ã—ã‚ˆã†ğŸ
* å¤‰æ›ã¯ **1ã‹æ‰€ã«é›†ç´„**ãŒãƒ©ã‚¯ğŸ“
* **timeout/503/ãƒãƒƒãƒˆä¸å®‰å®šã¯ retryable** ã®è€ƒãˆæ–¹ãŒåŸºæœ¬ğŸ”
* ãƒ­ã‚°ã¯ **è¿½è·¡ã§ãã‚‹é …ç›®ã‚»ãƒƒãƒˆ**ã§æ§‹é€ åŒ–ã—ã¦æ®‹ã™ğŸ”ğŸ§µ ([Microsoft Learn][5])

---

æ¬¡ã®ç¬¬21ç« ã§ã¯ã€ã“ã® `InfraError` ã‚’ **HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ400/409/500â€¦ï¼‰ã«ã©ã†å‰²ã‚Šå½“ã¦ã‚‹ã‹**ğŸš¦ğŸŒ ã‚’ã‚„ã‚‹ã‚ˆğŸ˜Šâœ¨

[1]: https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/http/httpclient?utm_source=chatgpt.com "Make HTTP requests with the HttpClient - .NET"
[2]: https://learn.microsoft.com/en-us/dotnet/core/resilience/http-resilience?utm_source=chatgpt.com "Build resilient HTTP apps: Key development patterns - .NET"
[3]: https://learn.microsoft.com/en-us/ef/core/miscellaneous/connection-resiliency?utm_source=chatgpt.com "Connection Resiliency - EF Core"
[4]: https://learn.microsoft.com/en-us/sql/connect/ado-net/configurable-retry-logic-sqlclient-introduction?view=sql-server-ver17&utm_source=chatgpt.com "Configurable retry logic in SqlClient introduction"
[5]: https://learn.microsoft.com/en-us/dotnet/core/extensions/logging?utm_source=chatgpt.com "Logging in C# - .NET"
