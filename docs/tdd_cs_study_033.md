# ç¬¬33ç« ï¼šãƒ¢ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å…¥é–€ï¼ˆæœ€å°ã ã‘ï¼‰ğŸ§ª

ï¼ˆãƒ†ãƒ¼ãƒï¼š**ã€Œå¤–éƒ¨é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã—ã¦ã€å‘¼ã°ã‚ŒãŸã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€**ğŸ“£âœ…ï¼‰

---

### ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯ğŸ’–

![ç”»åƒã‚’æŒ¿å…¥äºˆå®š](./picture/tdd_cs_study_033_moq_intro.png)

ã“ã®ç« ãŒçµ‚ã‚ã£ãŸã‚‰ã€ã‚ãªãŸã¯ã“ã‚“ãªã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ğŸ˜Šâœ¨

* ã€Œ**å¤–éƒ¨ã«ä½•ã‹ã™ã‚‹ï¼ˆé€šçŸ¥ã™ã‚‹ï¼ä¿å­˜ã™ã‚‹ï¼‰**ã€ã¿ãŸã„ãª**å‰¯ä½œç”¨**ã‚’ã€ãƒ†ã‚¹ãƒˆã§å®‰å…¨ã«ç¢ºèªã§ãã‚‹ğŸ“£âœ…
* ãƒ¢ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§æœ€ä½é™ã®

  * **æˆ»ã‚Šå€¤ï¼ˆ/Taskï¼‰ã‚’ç”¨æ„ã™ã‚‹**
  * **å‘¼ã³å‡ºã—å›æ•°ã‚’ç¢ºèªã™ã‚‹**
    ã‚’ã‚µã‚¯ãƒƒã¨ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ªâœ¨
* ãã—ã¦ä¸€ç•ªå¤§äº‹ï¼š**ãƒ¢ãƒƒã‚¯ã®ä½¿ã„ã™ãã‚’é¿ã‘ã‚‹åŸºæº–**ãŒæŒã¦ã‚‹ğŸ­ğŸš«ğŸ°

```mermaid
graph LR
    A["Arrange"] -- "Setup" --> M["Mock Object"]
    B["Act"] -- "Invoke" --> M
    C["Assert"] -- "Verify" --> M
```

---

## 0) ã©ã‚Œã‚’ä½¿ã†ï¼Ÿï¼ˆ2026å¹´1æœˆã®â€œä»Šâ€ãƒ™ãƒ¼ã‚¹ï¼‰ğŸ”âœ¨

ã“ã®ç« ã§ã¯ **Moq** ã‚’ãƒ¡ã‚¤ãƒ³ã§æ‰±ã„ã¾ã™ï¼ˆã„ã¡ã°ã‚“æƒ…å ±ã‚‚ä¾‹ã‚‚å¤šã„ã‹ã‚‰ğŸ’¡ï¼‰ã€‚

* **Moq**ï¼šNuGetã®æœ€æ–°ãŒ **4.20.72**ï¼ˆæœ¬æ—¥æ™‚ç‚¹ï¼‰ ([nuget.org][1])
* ä»£æ›¿ï¼š

  * **NSubstitute**ï¼š**5.3.0** ([nuget.org][2])
  * **FakeItEasy**ï¼š**9.0.0** ([nuget.org][3])
* ã¡ãªã¿ã« xUnit v3 ã®NuGetã¯ **xunit.v3 3.2.2**ï¼ˆæœ¬æ—¥æ™‚ç‚¹ï¼‰ ([nuget.org][4])

> ã“ã®ç« ã®ç‹™ã„ã¯ã€ŒMoqã‚’æ¥µã‚ã‚‹ã€ã˜ã‚ƒãªãã¦ã€**â€œå¿…è¦ãªæ™‚ã ã‘æœ€å°ã§ä½¿ãˆã‚‹â€**ã‚ˆã†ã«ãªã‚‹ã“ã¨ã ã‚ˆã€œğŸ˜ŠğŸª„

---

## 1) ãƒ¢ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã£ã¦ä½•ï¼ŸğŸ©ğŸ­

### ã–ã£ãã‚Šè¨€ã†ã¨â€¦

ã€Œæœ¬ç‰©ã®ä»£ã‚ã‚Šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ†ã‚¹ãƒˆãƒ€ãƒ–ãƒ«ï¼‰ã€ã‚’ã€**ç°¡å˜ã«ä½œã‚‹é“å…·**ã§ã™ğŸ§°âœ¨

ç‰¹ã«ä¾¿åˆ©ãªã®ã¯ã“ã“ğŸ‘‡

* **å¤–éƒ¨é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ«/Slack/Pushï¼‰**
* **å¤–éƒ¨I/Oï¼ˆHTTP/DB/ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰**
* **æ™‚é–“ãƒ»ä¹±æ•°** ãªã©ã€ãƒ†ã‚¹ãƒˆã§æ‰±ã„ã¥ã‚‰ã„ã‚‚ã®â°ğŸ²

ãã—ã¦ã€ã“ã®ç« ã§è¦šãˆã‚‹â€œæœ€å°ã‚»ãƒƒãƒˆâ€ã¯ã“ã‚Œã ã‘ğŸ‘‡

* **Setup**ï¼šå‘¼ã°ã‚ŒãŸã‚‰ã“ã†è¿”ã—ã¦ã­ï¼ˆTaskã§ã‚‚OKï¼‰ğŸ§ª
* **Verify**ï¼šã¡ã‚ƒã‚“ã¨å‘¼ã°ã‚ŒãŸï¼Ÿä½•å›ï¼Ÿâœ…

---

## 2) ä½¿ã„ã©ã“ã‚ã®ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã“è¶…å¤§äº‹ï¼‰ğŸ“ŒğŸ’–

ãƒ¢ãƒƒã‚¯ã¯ä¾¿åˆ©ã ã‘ã©ã€ä½¿ã„ã™ãã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒã¤ã‚‰ããªã‚‹ğŸ˜µâ€ğŸ’«ğŸ’¦
ãªã®ã§åˆ¤æ–­åŸºæº–ã‚’æ±ºã‚ã‚ˆã€œï¼

### âœ… ãƒ¢ãƒƒã‚¯ã‚’ä½¿ã£ã¦ã„ã„å…¸å‹

* ã€Œ**é€šçŸ¥ã—ãŸ/ã—ãªã„**ã€ãŒä»•æ§˜ğŸ“£âœ…
* ã€Œä¿å­˜ã—ãŸ/ã—ãªã„ã€ã€Œé€ä¿¡ã—ãŸ/ã—ãªã„ã€ã¿ãŸã„ã« **å‰¯ä½œç”¨ãŒç›®çš„**ã®ã¨ã

### ğŸš« ãƒ¢ãƒƒã‚¯ã‚’é¿ã‘ãŸã„å…¸å‹

* è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚„ç´”ç²‹ãªåˆ¤å®šï¼ˆ**æˆ»ã‚Šå€¤ã§ç¢ºèªã§ãã‚‹**ã‚„ã¤ï¼‰
  â†’ ãã‚Œã¯ **å€¤ã®Assert** ã§ååˆ†ğŸ˜‡âœ¨

> è¿·ã£ãŸã‚‰ï¼šã€Œãã‚Œã€çµæœï¼ˆå€¤ï¼‰ã§ç¢ºèªã§ããªã„ï¼Ÿã€ã£ã¦è‡ªåˆ†ã«èãã®ãŒã‚³ãƒ„ã ã‚ˆğŸ˜ŠğŸ§ âœ¨

---

## 3) ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã™ã‚‹ğŸ“§ğŸ§ªâœ¨

### é¡Œæï¼ˆè¶…ãƒŸãƒ‹ï¼‰ğŸ§¸

ã€Œè³¼å…¥ãŒæˆåŠŸã—ãŸã‚‰ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ã€ğŸ“§

* æˆåŠŸ â†’ **SendAsyncãŒ1å›å‘¼ã°ã‚Œã‚‹**
* å¤±æ•— â†’ **å‘¼ã°ã‚Œãªã„**

---

### 3-1) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ ï¼ˆVSã§ã‚‚CLIã§ã‚‚OKï¼‰ğŸ“¦âœ¨

CLIæ´¾ãªã‚‰ï¼ˆãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ï¼‰ğŸ‘‡

```bash
dotnet add package Moq
```

ï¼ˆMoqã¯NuGetã§é…å¸ƒã•ã‚Œã¦ã‚‹ã‚ˆ ([nuget.org][1])ï¼‰

---

## 4) ã¾ãšâ€œãƒ†ã‚¹ãƒˆã‹ã‚‰â€æ›¸ãï¼ˆRedï¼‰ğŸš¦ğŸ”´

### 4-1) ä¾å­˜ï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼‰ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã™ã‚‹ğŸ“®

```csharp
public interface IEmailSender
{
    Task SendAsync(string to, string subject, string body);
}
```

### 4-2) ãƒ†ã‚¹ãƒˆï¼šæˆåŠŸã—ãŸã‚‰ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã•ã‚Œã‚‹ğŸ“§âœ…

```csharp
using Moq;
using Xunit;

public class PurchaseServiceTests
{
    [Fact]
    public async Task Purchase_success_sends_confirmation_email()
    {
        // Arrange
        var emailMock = new Mock<IEmailSender>();

        // Taskã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€æœ€ä½é™ã“ã“ã‚’ç”¨æ„ã™ã‚‹ã¨å®‰å¿ƒğŸ˜Š
        emailMock
            .Setup(x => x.SendAsync(It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>()))
            .Returns(Task.CompletedTask);

        var sut = new PurchaseService(emailMock.Object);

        // Act
        await sut.PurchaseAsync(userEmail: "alice@example.com", amount: 1200);

        // Assertï¼ˆå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹ï¼ï¼‰
        emailMock.Verify(
            x => x.SendAsync(
                "alice@example.com",
                It.Is<string>(s => s.Contains("è³¼å…¥", StringComparison.Ordinal)),
                It.IsAny<string>()),
            Times.Once);
    }
}
```

ãƒã‚¤ãƒ³ãƒˆè§£èª¬ğŸ§âœ¨

* `Setup(...).Returns(Task.CompletedTask)`ï¼š**ã€Œå‘¼ã°ã‚Œã¦ã‚‚è½ã¡ãªã„ã€å®‰å…¨è£…ç½®**
* `Verify(..., Times.Once)`ï¼š**ã€Œ1å›ã ã‘é€ã‚Œã€**ã‚’ä»•æ§˜ã¨ã—ã¦å›ºå®šğŸ“Œ
* `It.Is<string>(...)`ï¼šä»¶åãŒãã‚Œã£ã½ã„ã‹ã ã‘è¦‹ã‚‹ï¼ˆç´°ã‹ã™ããªã„ï¼‰ğŸ˜ŠğŸ‘Œ

---

## 5) å®Ÿè£…ã‚’æ›¸ãï¼ˆGreenï¼‰ğŸš¦ğŸŸ¢

```csharp
public class PurchaseService
{
    private readonly IEmailSender _email;

    public PurchaseService(IEmailSender email)
    {
        _email = email;
    }

    public async Task PurchaseAsync(string userEmail, int amount)
    {
        // ã“ã“ã§ã¯ã€ŒæˆåŠŸã—ãŸã“ã¨ã«ã™ã‚‹ã€ãƒŸãƒ‹å®Ÿè£…ã§OKğŸ˜Š
        // ï¼ˆç¬¬19ç« ã®ä»®å®Ÿè£…ã®æ„Ÿè¦šï¼ğŸ©¹ï¼‰
        await _email.SendAsync(
            userEmail,
            subject: "è³¼å…¥ã®ç¢ºèª",
            body: $"ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é‡‘é¡: {amount}");
    }
}
```

ã“ã‚Œã§ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã¯ãšğŸ‰âœ¨

---

## 6) ã‚‚ã†1æœ¬ãƒ†ã‚¹ãƒˆï¼šå¤±æ•—æ™‚ã¯é€ã‚‰ãªã„ï¼ˆæ¬¡ã®Redï¼‰ğŸš¦ğŸ”´â¡ï¸ğŸŸ¢

ã€Œå¤±æ•—ã€ã‚’ä»•æ§˜ã«ã—ãŸã„ã®ã§ã€ãƒ†ã‚¹ãƒˆã§å›ºå®šã—ã‚ˆã€œğŸ’ªğŸ˜Š

```csharp
[Fact]
public async Task Purchase_failure_does_not_send_email()
{
    // Arrange
    var emailMock = new Mock<IEmailSender>();
    emailMock
        .Setup(x => x.SendAsync(It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>()))
        .Returns(Task.CompletedTask);

    var sut = new PurchaseService(emailMock.Object);

    // Act
    await sut.PurchaseAsync(userEmail: "alice@example.com", amount: 0);

    // Assert
    emailMock.Verify(
        x => x.SendAsync(It.IsAny<string>(), It.IsAny<string>(), It.IsAny<string>()),
        Times.Never);
}
```

### ã“ã“ã§å®Ÿè£…ã‚’å°‘ã—ã ã‘è‚²ã¦ã‚‹ğŸŒ±âœ¨

```csharp
public async Task PurchaseAsync(string userEmail, int amount)
{
    if (amount <= 0)
        return; // å¤±æ•—æ‰±ã„ï¼ˆãƒŸãƒ‹ï¼‰

    await _email.SendAsync(
        userEmail,
        subject: "è³¼å…¥ã®ç¢ºèª",
        body: $"ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é‡‘é¡: {amount}");
}
```

---

## 7) ã‚ˆãã‚ã‚‹ãƒãƒã‚Šã©ã“ã‚é›†ğŸ˜µâ€ğŸ’«ğŸ§¯

* âœ… **VerifyãŒç´°ã‹ã™ãã‚‹**ï¼ˆæœ¬æ–‡ãŒå®Œå…¨ä¸€è‡´ï¼ã¨ã‹ï¼‰
  â†’ å¤‰æ›´ã«å¼±ããªã‚‹ã®ã§ã€**é‡è¦ãªéƒ¨åˆ†ã ã‘**è¦‹ã‚‹ã®ãŒã‚³ãƒ„ğŸ˜Š
* âœ… **ãƒ¢ãƒƒã‚¯ã ã‚‰ã‘**ã«ãªã£ã¦ã€ãƒ†ã‚¹ãƒˆãŒã€Œæ‰‹é †ã®å†™ã—ã€ã«ãªã‚‹
  â†’ ã€Œçµæœã§Assertã§ãã‚‹ãªã‚‰ã€çµæœã§ï¼ã€ã«æˆ»ã‚‹ğŸ§ âœ¨
* âœ… asyncãƒ¡ã‚½ãƒƒãƒ‰ã§ `Setup` ã—ãªãã¦æŒ™å‹•ãŒåˆ†ã‹ã‚Šã¥ã‚‰ã„
  â†’ ã¾ãšã¯ `Returns(Task.CompletedTask)` ã‚’ç™–ã«ã—ã‚ˆğŸ‘âœ¨

---

## 8) AIã®ä½¿ã„æ–¹ï¼ˆã“ã®ç« ã®å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ğŸ¤–ğŸª„

AIã¯â€œå©ãå°â€ã«ä¾¿åˆ©ã ã‚ˆã€œğŸ˜Šâœ¨ï¼ˆæ¡ç”¨ã¯ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã‚‚ã®ã ã‘âœ…ï¼‰

ãŠã™ã™ã‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ‘‡

* ã€Œã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’Moqã§ãƒ¢ãƒƒã‚¯ã—ã¦ã€**1å›å‘¼ã°ã‚ŒãŸã“ã¨ã‚’Verifyã™ã‚‹ãƒ†ã‚¹ãƒˆ**ã‚’æ›¸ã„ã¦ã€ğŸ¤–
* ã€ŒVerifyãŒç´°ã‹ã™ããªã„ã‚ˆã†ã«ã€**å£Šã‚Œã«ãã„Assert/Verifyã®ç²’åº¦**ã‚’ææ¡ˆã—ã¦ã€ğŸ§ 
* ã€Œã“ã®å‰¯ä½œç”¨ã€**ãƒ¢ãƒƒã‚¯ã§è¦‹ã‚‹ã¹ãè¦³ç‚¹**ï¼ˆå›æ•°/å¼•æ•°/å‘¼ã°ãªã„æ¡ä»¶ï¼‰ã‚’åˆ—æŒ™ã—ã¦ã€ğŸ“£âœ…

---

## 9) ãƒŸãƒ‹èª²é¡Œï¼ˆã‚³ãƒŸãƒƒãƒˆå˜ä½ã§ï¼‰ğŸ’âœ¨

### èª²é¡ŒAï¼šé€šçŸ¥æ¡ä»¶ã‚’å¢—ã‚„ã™ğŸŸï¸

* `amount >= 5000` ã®ã¨ãã ã‘ã€ŒVIPã‚ã‚ŠãŒã¨ã†ãƒ¡ãƒ¼ãƒ«ã€ã«ã™ã‚‹ğŸ’Œâœ¨

  * ãƒ†ã‚¹ãƒˆï¼šä»¶åã« â€œVIPâ€ ãŒå…¥ã‚‹ã“ã¨ï¼ˆå®Œå…¨ä¸€è‡´ã˜ã‚ƒãªãã¦OKï¼‰

### èª²é¡ŒBï¼šé€ä¿¡å…ˆãŒç©ºãªã‚‰é€ã‚‰ãªã„ğŸš«ğŸ“§

* `userEmail` ãŒç©º/ç©ºç™½ãªã‚‰é€ã‚‰ãªã„

  * ãƒ†ã‚¹ãƒˆï¼š`Times.Never` ã§å›ºå®š

---

## ã¾ã¨ã‚ğŸ€âœ¨

* ãƒ¢ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ **å‰¯ä½œç”¨ï¼ˆé€šçŸ¥/ä¿å­˜/é€ä¿¡ï¼‰ã‚’ä»•æ§˜ã¨ã—ã¦å›ºå®š**ã™ã‚‹ã®ã«å¼·ã„ğŸ“£âœ…
* ã“ã®ç« ã¯ **Setupï¼ˆè¿”ã™ï¼‰ï¼‹Verifyï¼ˆå‘¼ã°ã‚ŒãŸï¼Ÿï¼‰** ã®æœ€å°ã ã‘ã§OKğŸ§ªâœ¨
* ãƒ¢ãƒƒã‚¯ã¯ä¾¿åˆ©ã ã‘ã©ã€**çµæœã§Assertã§ãã‚‹ãªã‚‰ãã£ã¡å„ªå…ˆ**ãŒå¹³å’ŒğŸ˜ŠğŸŒ¸

æ¬¡ã®ç« ï¼ˆç¬¬34ç« ï¼‰ã¯ã€ã“ã®æµã‚Œã‚’ãã®ã¾ã¾ä½¿ã£ã¦
ã€Œ**å‘¼ã¶/å‘¼ã°ãªã„**ãŒæ¡ä»¶ã§å¤‰ã‚ã‚‹å‰¯ä½œç”¨ã€ã‚’ã€ã‚‚ã£ã¨ä»•æ§˜ã£ã½ããƒ†ã‚¹ãƒˆã—ã¦ã„ãã‚ˆã€œğŸ“£âœ…âœ¨

[1]: https://www.nuget.org/packages/moq/?utm_source=chatgpt.com "Moq 4.20.72"
[2]: https://www.nuget.org/packages/nsubstitute/?utm_source=chatgpt.com "NSubstitute 5.3.0"
[3]: https://www.nuget.org/packages/fakeiteasy/?utm_source=chatgpt.com "FakeItEasy 9.0.0"
[4]: https://www.nuget.org/packages/xunit.v3?utm_source=chatgpt.com "xunit.v3 3.2.2"
