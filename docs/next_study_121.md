# ç¬¬121ç« ï¼šã‚„ã‚Šã™ãæ³¨æ„ï¼šé‡ã„å‡¦ç†ã¯ç½®ã‹ãªã„ğŸª¶

ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã ã‚ˆğŸ¯

* Middleware ã«ã€Œç½®ã„ã¦ã„ã„å‡¦ç† / ãƒ€ãƒ¡ãªå‡¦ç†ã€ã‚’è¦‹åˆ†ã‘ã‚‰ã‚Œã‚‹ğŸ‘€âœ¨
* â€œé‡ã„å‡¦ç†â€ ã‚’ã©ã“ã«ç§»ã™ã¨å¹¸ã›ã«ãªã‚Œã‚‹ã‹åˆ†ã‹ã‚‹ğŸššğŸ’¨
* æœ€å°ã® Middlewareï¼ˆè»½ã„ã‚¬ãƒ¼ãƒ‰ï¼‰ã‚’1ã¤æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹âœï¸ğŸª

---

## ã¾ãšå¤§äº‹ãªæ„Ÿè¦šï¼šMiddleware ã¯ã€Œå…¥å£ã®ä¿‚å“¡ã€ã ã‚ˆğŸšªğŸ‘®â€â™€ï¸

![next_study_121_bottleneck](./picture/next_study_121_bottleneck.png)


Middleware ã¯ **ãƒ«ãƒ¼ãƒˆã«å…¥ã‚‹å‰**ã«å‹•ãâ€œå‰ã•ã°ãâ€ã¿ãŸã„ãªã‚‚ã®âœ¨
ã“ã“ã§æ™‚é–“ãŒã‹ã‹ã‚‹ã¨ã€**æ¯å›ãœã‚“ã¶ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé…ããªã‚‹**ã®ãŒæœ€å¤§ã®æ€–ã•ğŸ˜±ğŸ¢

Next.js ã® Edge Runtime ã¯ã€Œé€Ÿã„ã‘ã©åˆ¶ç´„ã‚ã‚Šã€ãªç’°å¢ƒã§ã€**Node.js ã®å…¨éƒ¨ã®APIãŒä½¿ãˆã‚‹ã‚ã‘ã˜ã‚ƒãªã„**ã‚ˆã€œã¨ã„ã†å‰æã‚‚ã‚ã‚‹ã‚ˆâš¡ğŸ§© ([Next.js][1])

---

## å›³ã§è¦‹ã‚‹ï¼šè»½ã„ Middleware ã¨ã€ã‚„ã£ã¡ã‚ƒã„ã‘ãªã„ Middleware ğŸª¶ğŸª¨

![è»½ã„ Middleware ã¨é‡ã„ Middleware](./picture/next_study_121_heavy_processing.png)



```mermaid
flowchart LR
  U["ãƒ–ãƒ©ã‚¦ã‚¶ğŸŒ"] --> MW["MiddlewareğŸ§¤"]

  MW -->|"âœ…è»½ã„å‡¦ç†"| OK["åˆ¤å®šã ã‘ã—ã¦é€²ã‚ã‚‹/æˆ»ã™ğŸš¦"]
  OK --> APP["ãƒšãƒ¼ã‚¸/Route Handler/Server ActionsğŸ ğŸ§©"]

  MW -->|"âŒé‡ã„å‡¦ç†"| BAD["DBã‚¢ã‚¯ã‚»ã‚¹ãƒ»é‡ã„è¨ˆç®—ãƒ»ã§ã‹ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªğŸª¨"]
  BAD --> SLOW["å…¨éƒ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé…ããªã‚‹ğŸ¢ğŸ’¥"]
```

---

## ã€Œé‡ã„å‡¦ç†ã€ã£ã¦ãªã«ï¼Ÿï¼ˆMiddleware ã§ã¯é¿ã‘ã‚‹ã‚„ã¤ï¼‰ğŸª¨ğŸ™…â€â™€ï¸

![next_study_121_heavy_vs_light](./picture/next_study_121_heavy_vs_light.png)


### âŒ Middleware ã«ç½®ã‹ãªã„ã»ã†ãŒã„ã„ä»£è¡¨ä¾‹

* DB ã¸ã®å•ã„åˆã‚ã›ï¼ˆä¾‹ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’DBã§ç…§åˆï¼‰ğŸ—„ï¸ğŸ”
* å¤–éƒ¨APIã¸ã® fetch ã‚’æ¯å›ã™ã‚‹ğŸ“¡ğŸ’¸
* ç”»åƒå‡¦ç†ãƒ»PDFå‡¦ç†ãƒ»æš—å·åŒ–ã®é‡ã„è¨ˆç®—ğŸ–¼ï¸ğŸ§®
* â€œã§ã‹ã„èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªâ€ ã‚’ä¸¸ã”ã¨èª­ã¿è¾¼ã‚€ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãŒè†¨ã‚‰ã‚€ï¼‰ğŸ“¦ğŸ’¥
* ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã£ã½ã„å‡¦ç†ï¼ˆå¾…ã¡ãŒå¤šã„ï¼‰â³ğŸ˜µâ€ğŸ’«

ã€ŒMiddleware ã¯è»½ãã™ã‚‹ã¹ãã€ã€Œé‡ã„è¨ˆç®—ã¯ãƒ€ãƒ¡ã€ã£ã¦ã„ã†ã®ã¯ã€ã„ã‚ã‚“ãªè§£èª¬ã§ã‚‚å…±é€šã®æ–¹é‡ã ã‚ˆğŸª¶âœ¨ ([Contentful][2])

Edge Runtime ã¯ **Node.js API ã®ä¸€éƒ¨ãŒéå¯¾å¿œ**ã ã£ãŸã‚Šã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ **ã‚µã‚¤ã‚ºåˆ¶é™**ã¿ãŸã„ãªåˆ¶ç´„ã‚‚ã‚ã‚‹ã®ã§ã€ã€Œé ‘å¼µã£ã¦è‰²ã€…ã‚„ã‚ã†ã€ã¨ã™ã‚‹ã¨è©°ã¾ã‚Šã‚„ã™ã„ã‚ˆâš¡ğŸ“¦ ([Next.js][1])

---

## âœ… Middleware ã«å‘ã„ã¦ã‚‹å‡¦ç†ï¼ˆè»½ã„ãƒ»é€Ÿã„ãƒ»å˜ç´”ï¼‰ğŸª¶âœ¨

* ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„ãªã‚‰ `/login` ã¸ï¼‰ğŸš¦â¡ï¸
* URLã®æ›¸ãæ›ãˆï¼ˆrewriteï¼‰ğŸ›£ï¸
* Cookie / Header ã‚’ã¡ã‚‡ã£ã¨è¦‹ã‚‹ãƒ»ã¡ã‚‡ã£ã¨ä»˜ã‘ã‚‹ğŸªğŸ·ï¸
* è¨€èªåˆ¤å®šã—ã¦ `/ja` `/en` ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ğŸŒğŸ’¬
* â€œã–ã£ãã‚Šãƒã‚§ãƒƒã‚¯ï¼ˆoptimistic checkï¼‰â€ âœ…

  * ä¾‹ï¼š`session` cookie ãŒã€Œã‚ã‚‹/ãªã„ã€ã ã‘è¦‹ã‚‹ï¼ˆDBç…§åˆã¯ã—ãªã„ï¼‰

---

## åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ï¼šè¿·ã£ãŸã‚‰ã“ã‚Œã§æ±ºã‚ã‚ˆğŸ§ ğŸ§

```mermaid
flowchart TD
  A["ã‚„ã‚ŠãŸã„å‡¦ç†ãŒã‚ã‚‹ğŸ¤”"] --> B{"ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/DBã«è¡Œãï¼ŸğŸ“¡ğŸ—„ï¸"}
  B -->|"Yes"| X["Middlewareã«ç½®ã‹ãªã„ğŸ™…â€â™€ï¸<br>Route Handler / Server Actionsã¸ğŸšš"]
  B -->|"No"| C{"é‡ã„è¨ˆç®—ï¼Ÿã§ã‹ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ŸğŸ§®ğŸ“¦"}
  C -->|"Yes"| X
  C -->|"No"| D{"åˆ¤å®šã—ã¦ redirect/rewrite/header ãã‚‰ã„ï¼ŸğŸš¦ğŸ·ï¸"}
  D -->|"Yes"| OK["Middlewareå‘ãğŸª¶âœ¨"]
  D -->|"No"| X
```

---

## å®Ÿä¾‹ï¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ã€Œå…¥å£ã§è»½ãæ­¢ã‚ã‚‹ã€ã ã‘ã«ã™ã‚‹ğŸš¦ğŸª

![next_study_121_optimistic_check](./picture/next_study_121_optimistic_check.png)


ã‚„ã‚ŠãŸã„ã“ã¨ï¼š

* `/dashboard` ã«æ¥ãŸäººãŒ **ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã•ãã†**ãªã‚‰ `/login` ã«é£›ã°ã™ğŸ’¨
* ã§ã‚‚ **DBã§æœ¬å½“ã®ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª**ã¯ Middleware ã§ã¯ã‚„ã‚‰ãªã„ï¼ˆé‡ã„ã‹ã‚‰ï¼‰ğŸª¨ğŸ™…â€â™€ï¸

### âœ… middleware.tsï¼ˆè»½ã„ï¼ï¼‰

```ts
import { NextRequest, NextResponse } from "next/server";

export function middleware(req: NextRequest) {
  const isDashboard = req.nextUrl.pathname.startsWith("/dashboard");

  if (!isDashboard) return NextResponse.next();

  // âœ… ã“ã“ã§ã¯ã€Œã‚ã‚‹/ãªã„ã€ã ã‘è¦‹ã‚‹ï¼ˆoptimistic checkï¼‰
  const session = req.cookies.get("session")?.value;

  if (!session) {
    const url = req.nextUrl.clone();
    url.pathname = "/login";
    // ã©ã“ã‹ã‚‰æ¥ãŸã‹æˆ»ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨è¦ªåˆ‡ğŸ€
    url.searchParams.set("from", req.nextUrl.pathname);
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
}

// ã§ãã‚Œã°å¯¾è±¡ã‚’çµã‚‹ï¼ˆé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ç­‰ã¾ã§æ¯å›å‹•ã‹ã•ãªã„ï¼‰âœ¨
export const config = {
  matcher: ["/dashboard/:path*"],
};
```

### âŒ ã‚„ã‚ŠãŒã¡ãªNGä¾‹ï¼ˆé‡ã„ï¼ï¼‰

* middleware ã®ä¸­ã§ã€Œæ¯å›DBã§ session ç¢ºèªã€
* middleware ã®ä¸­ã§ã€Œæ¯å› `/api/me` ã‚’ fetch ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã€

ã“ã‚Œã‚’ã‚„ã‚‹ã¨ã€**ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«å…¥ã‚‹å‰ã®å…¨å“¡ãŒæ¯å›å¾…ãŸã•ã‚Œã‚‹**æ„Ÿã˜ã«ãªã‚Šã‚„ã™ã„ã‚ˆğŸ¢ğŸ’¦
ï¼ˆã•ã‚‰ã« Edge ã ã¨ä½¿ãˆãªã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå‡ºãŸã‚Šã‚‚ã—ã¦ã€ãƒãƒã‚Šã‚„ã™ã„â€¦ï¼ï¼‰([Next.js][1])

---

## ã˜ã‚ƒã‚ã€Œæœ¬å½“ã®ãƒã‚§ãƒƒã‚¯ã€ã¯ã©ã“ã§ã‚„ã‚‹ã®ï¼ŸğŸ ğŸ”

![next_study_121_check_location](./picture/next_study_121_check_location.png)


ãŠã™ã™ã‚ã¯ã“ã®ã¸ã‚“ğŸ‘‡âœ¨

* **Server Component**ï¼ˆãƒšãƒ¼ã‚¸å´ï¼‰ã§ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼‹æ¨©é™ãƒã‚§ãƒƒã‚¯ã€ğŸ§Š
* **Route Handler**ï¼ˆ`app/api/.../route.ts`ï¼‰ã§ã€Œèªè¨¼APIã€ğŸšª
* **Server Actions** ã§ã€Œãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«å³å¯†ãƒã‚§ãƒƒã‚¯ã€ğŸ“¨

Middleware ã¯ â€œå…¥å£ã§è»½ããµã‚‹ã„ã«ã‹ã‘ã‚‹â€ ãã‚‰ã„ãŒã¡ã‚‡ã†ã©ã„ã„ã‚ˆğŸª¶ğŸ˜Š

---

## ãƒŸãƒ‹ç·´ç¿’ğŸ¯ï¼ˆ5åˆ†ï¼‰ğŸ•”âœ¨

1. ä¸Šã® `middleware.ts` ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã«ä½œã‚‹ğŸ“„
2. Cookie ãŒç„¡ã„çŠ¶æ…‹ã§ `/dashboard` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€`/login` ã«é£›ã¹ãŸã‚‰OKğŸš¦ğŸ‰
3. Cookie ã‚’é©å½“ã«ä»˜ã‘ãŸã‚‰ï¼ˆDevToolsã§OKï¼‰ `/dashboard` ãŒé€šã‚‹ã®ã‚’ç¢ºèªğŸªâœ…
4. ã€ŒMiddlewareã§ã¯é€šã™/æ­¢ã‚ã‚‹ã ã‘ã€‚æœ¬å½“ã®èªè¨¼ã¯ãƒšãƒ¼ã‚¸å´ã§ã‚„ã‚‹ã€ã£ã¦æ„è­˜ã‚’ãƒ¡ãƒ¢ğŸ“ğŸ’—

---

## ã¾ã¨ã‚ï¼šåˆè¨€è‘‰ã¯ã€Œè–„ãã€é€Ÿãã€é‹­ãã€ğŸª¶âš¡âœ‚ï¸

* Middleware ã¯ **å…¥å£ã®å‰å‡¦ç†**ã ã‹ã‚‰ã€é‡ã„ã“ã¨ã‚’ã™ã‚‹ã¨å…¨ä½“ãŒé…ããªã‚‹ğŸ¢
* **DB / å¤–éƒ¨é€šä¿¡ / é‡ã„è¨ˆç®— / ã§ã‹ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ã¯ç½®ã‹ãªã„ğŸ™…â€â™€ï¸ğŸª¨
* â€œã‚ã‚‹/ãªã„â€ã¿ãŸã„ãª **è»½ã„åˆ¤å®šã ã‘**ã—ã¦ã€è©³ç´°ã¯ãƒšãƒ¼ã‚¸ã‚„APIå´ã«æ¸¡ã™ğŸššâœ¨

æ¬¡ã®ç« ï¼ˆEdge Runtimeï¼‰ã«ã¤ãªãŒã‚‹è¶…å¤§äº‹ãƒã‚¤ãƒ³ãƒˆãªã®ã§ã€ã“ã®æ„Ÿè¦šã¯ã“ã“ã§å›ºã‚ã¡ã‚ƒãŠã†ã­ã€œğŸ˜ŠğŸŒ¸

[1]: https://nextjs.org/docs/app/api-reference/edge?utm_source=chatgpt.com "Edge Runtime - API Reference"
[2]: https://www.contentful.com/blog/next-js-middleware/?utm_source=chatgpt.com "Next.js Middleware guide, tutorial, and code examples"
